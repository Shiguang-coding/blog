<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>【尚硅谷】RabbitMQ | 時光</title><meta name="keywords" content="尚硅谷,RabbitMQ"><meta name="author" content="時光"><meta name="copyright" content="時光"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="【尚硅谷】RabbitMQ"><meta name="application-name" content="【尚硅谷】RabbitMQ"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="【尚硅谷】RabbitMQ"><meta property="og:url" content="https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/index.html"><meta property="og:site_name" content="時光"><meta property="og:description" content="在线视频:尚硅谷2024最新RabbitMQ教程，消息中间件RabbitMQ迅速上手！官方资料: 尚硅谷2024最新版RabbitMQ视频 代码Gitee：https:&amp;#x2F;&amp;#x2F;gitee.com&amp;#x2F;an_shiguang&amp;#x2F;learn-rabbitmqGitHub: https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg"><meta property="article:author" content="時光"><meta property="article:tag" content="博客,時光,時光的博客,時光博客园子,实用博客,开源,共享"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg"><meta name="description" content="在线视频:尚硅谷2024最新RabbitMQ教程，消息中间件RabbitMQ迅速上手！官方资料: 尚硅谷2024最新版RabbitMQ视频 代码Gitee：https:&amp;#x2F;&amp;#x2F;gitee.com&amp;#x2F;an_shiguang&amp;#x2F;learn-rabbitmqGitHub: https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/"><link rel="preconnect" href="//cdn.cbd.int"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与各类博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo.shiguangdev.eu.org',
  commentBarrageConfig:{"enable":true,"maxBarrage":1,"barrageTime":4000,"accessToken":"","mailMd5":""},
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🌟 技术分享领航人","📚 终身学习倡导者","💡 创新思维启发源","📈 成长路径引路人","🚀 科技趋势探索者","🤖️ AI技术探索先锋","🌈 技术创新推动手","💬 社区互动活跃家","🛠️ 代码经验传授师","📢 知识传播倡导员"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":true,"limitCount":300,"languages":{"author":"作者: 時光","link":"链接: ","source":"来源: 時光","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '時光',
  title: '【尚硅谷】RabbitMQ',
  postAI: '',
  pageFillDescription: 'MQ的相关概念, 什么是MQ, 为什么要用MQ, 流量消峰, 应用解耦, 异步处理, MQ的分类, 消息队列底层实现的两大主流方式, AMQP与JMS对比, 各主流MQ产品对比, MQ的选择, RabbitMQ介绍, RabbitMQ的概念, 四大核心概念, RabbitMQ核心部分, 各个名词介绍, 安装RabbitMQ, 手动安装, Docker安装, Hello World, 导入依赖, 消息发送端(生产者), 消息接收端(消费者), RabbitMQ工作模式, 工作模式概述, Work Queues, 生产者代码, 封装工具类, 编写代码, 发送消息效果, 消费者代码, 编写代码, 运行效果, 发布订阅模式（Publishx2FSubscribe）, 生产者代码, 编写代码, 执行效果, 消费者代码, 编写代码, 执行效果, 路由模式（Routing）, 生产者代码, 编写代码, 运行效果, 消费者代码, 编写代码, 执行效果, 主题模式（Topics）, 生产者代码, 编写代码, 执行效果, 消费者代码, 编写代码, 执行效果, 远程过程调用（RPC）, 工作模式小结, Spring Boot 整合RabbitMQ, 基本思路, 消费者操作步骤, 创建项目并导入依赖, 创建配置文件, 创建启动类, MyMessageListener, 测试, 图形化界面操作, 生产者操作步骤, 创建项目并导入依赖, 创建配置文件, 测试, 消息可靠性投递, 问题场景及解决方案, 问题场景, 解决方案, 故障情况1, 生产者端实现, 创建项目并导入依赖, 主启动类, 配置文件, 配置类, 测试类, 测试, 备份交换机实现, 故障情况2, 故障情况3, 消费者端实现, 创建项目并导入依赖, 主启动类, 配置文件, Listener, 消息确认相关方法参数说明, 测试, 消费端限流, 消息超时, 测试, 给队列设置超时时间, 给消息设置超时时间, 死信和死信队列, 测试相关准备, 创建死信交换机和死信队列, 创建正常交换机和正常队列, java代码中的相关常量声明, 消费端拒收消息, 发送消息的代码, 接收消息的代码, 执行结果, 消费数量超过队列容量极限, 发送消息的代码, 接收消息的代码, 执行效果, 消息超时未消费, 发送消息的代码, 执行效果, 延迟队列, 业务场景, 实现思路, 方案1：设置消息超时时间 + 死信队列, 方案2：给RabbitMQ安装插件, 插件介绍, 安装插件, 确定卷映射目录, 下载延迟插件, 启用插件, 确认, 创建交换机及队列, 代码测试, 生产者端代码, 消费者端代码, 事务消息, 实操演示, 环境准备, 创建项目并导入依赖, 配置文件, 启动类, 配置类, 测试类, 测试, 惰性队列, 优先级队列, 实操演示, 集群搭建, 安装RabbitMQ, 前置要求, 安装Erlang环境, 创建yum库配置文件, 加入配置内容, 更新yum库, 正式安装Erlang, CentOS 8, CentOS 7, 安装RabbitMQ, CentOS 8, CentOS 7, RabbitMQ基础配置, 收尾工作, 克隆 VMWare虚拟机, 目标, 克隆虚拟机, 给新机器设置IP地址, 修改主机名称, 保险措施, 集群节点彼此发现, node01设置, node02设置, node03设置, 负载均衡：Management UI, 说明, 安装HAProxy, 修改配置文件, 测试效果, 负载均衡：核心功能, 添加配置, 测试, 创建组件, 创建生产者端程序, 创建消费者端程序, 运行结果, 镜像队列, 仲裁队列, 操作步骤, 创建仲裁队列, 测试, 常规测试, 高可用测试, 流式队列, 使用步骤, 启用插件, 负载均衡, JAVA代码, 引入依赖, 创建Stream, 生产端程序, 消费端程序, 指定偏移量消费, 偏移量, 官网文档说明, 指定Offset消费, 对比, Federation插件, 简介, Federation交换机, 总体说明, 准备工作, 启用联邦插件, 添加上游连接端点, 创建控制策略, 测试, Federation队列, 总体说明, 创建控制策略, 测试, Shovel插件, 启用Shovel插件, 配置Shovel, 测试, 测试计划, 测试效果在线视频尚硅谷最新教程消息中间件迅速上手官方资料尚硅谷最新版视频代码的相关概念什么是从字面意思上看本质是个队列先入先出只不过队列中存放的内容是而已还是一种跨进程的通信机制用于上下游传递消息在互联网架构中是一种非常常见的上下游逻辑解耦物理解耦的消息通信服务使用了之后消息发送上游只需要依赖不用依赖其他服务为什么要用流量消峰举个例子如果订单系统最多能处理一万次订单这个处理能力应付正常时段的下单时绰绰有余正常时段我们下单一秒后就能返回结果但是在高峰期如果有两万次下单操作系统是处理不了的只能限制订单超过一万后不允许用户下单使用消息队列做缓冲我们可以取消这个限制把一秒内下的订单分散成一段时间来处理这时有些用户可能在下单十几秒后才能收到下单成功的操作但是比不能下单的体验要好应用解耦以电商应用为例应用中有订单系统库存系统物流系统支付系统用户创建订单后如果耦合调用库存系统物流系统支付系统任何一个子系统出了故障都会造成下单操作异常当转变成基于消息队列的方式后系统间调用的问题会减少很多比如物流系统因为发生故障需要几分钟来修复在这几分钟的时间里物流系统要处理的内存被缓存在消息队列中用户的下单操作可以正常完成当物流系统恢复后继续处理订单信息即可中单用户感受不到物流系统的故障提升系统的可用性异步处理有些服务间调用是异步的例如调用需要花费很长时间执行但是需要知道什么时候可以执行完以前一般有两种方式过一段时间去调用的查询查询或者提供一个执行完之后调用通知服务这两种方式都不是很优雅使用消息总线可以很方便解决这个问题调用服务后只需要监听处理完成的消息当处理完成后会发送一条消息给会将此消息转发给服务这样服务既不用循环调用的查询也不用提供同样服务也不用做这些操作服务还能及时的得到异步处理成功的消息的分类消息队列底层实现的两大主流方式由于消息队列执行的是跨应用的信息传递所以制定底层通信标准非常必要目前主流的消息队列通信协议标准包括通用协议公司研发专门为语言服务公司研发一组由接口组成的标准与对比各主流产品对比尚硅谷教程消息中间件快速入门优点单机吞吐量万级时效性级可用性高基于主从架构实现高可用性消息可靠性较低的概率丢失数据缺点官方社区现在对维护越来越少高吞吐量场景较少使用尚硅谷教程新版视频零基础入门到实战尚硅谷教程从入门到调优深入全面大数据的杀手锏谈到大数据领域内的消息传输则绕不开这款为大数据而生的消息中间件以其百万级的吞吐量名声大噪迅速成为大数据领域的宠儿在数据采集传输存诸的过程中发挥着举足轻重的作用目前已经被等大公司所采纳优点性能卓越单机写入约在百万条秒最大的优点就是吞吐量高时效性级可用性非常高是分布式的一个数据多个副本少数机器宕机不会丢失数据不会导致不可用消费者采用方式获取消息消息有序通过控制能够保证所有消息被消费且仅被消费一次有优秀的第三方管理界面在日志领域比较成熟被多家公司和多个开源项目使用功能支持功能较为简单主要支持简单的功能在大数据领域的实时计算以及日志采集被大规模使用缺点单机超过个队列分区会发生明显的飙高现象队列越多越高发送消息响应时间变长使用短轮询方式实时性取决于轮询间隔时间消费失败不支持重试支持消息顺序但是一台代理宕机后就会产生消息乱序社区更新较慢尚硅谷教程丨深度掌握消息中间件出自阿里巴巴的开源产品用语言实现在设计时参考了并做出了自己的一些改进被阿里巴巴广泛应用在订单交易充值流计算消息推送日志流式处理分发等场景优点单机吞吐量十万级可用性非常高分布式架构消息可以做到丢失功能较为完善还是分布式的扩展性好支持亿级别的消息堆积不会因为堆积导致性能下降源码是我们可以自己阅读源码定制自己公司的缺点支持的客户端语言不多目前是及其中不成熟社区活跃度一般没有在核心中去实现等接口有些系统要迁移需要修改大量代码年发布是一个在高级消息队列协议基础上完成的可复用的企业消息系统是当前最主流的消息中间件之一优点由于语言的高并发特性性能较好吞吐量到万级功能比较完备健壮稳定易用跨平台支持多种语言如等支持文档齐全开源提供的管理界面非常棒用起来很好用社区活跃度高更新频率相当高缺点商业版需要收费学习成本较高的选择主要特点是基于的模式来处理消息消费追求高吞吐量一开始的目的就是用于日志收集和传输适合产生大量数据的互联网服务的数据收集业务大型公司建议可以选用如果有日志采集功能肯定是首选了天生为金融互联网领域而生对于可靠性要求很高的场景尤其是电商里面的订单扣款以及业务削峰在大量交易涌入时后端可能无法及时处理的情况在稳定性上可能更值得信赖这些业务场景在阿里双已经经历了多次考验如果你的业务有上述并发场景建议可以选择结合语言本身的并发优势性能好时效性微秒级社区活跃度也比较高管理界面用起来十分方便如果你的数据量没有那么大中小型公司优先选择功能比较完备的介绍的概念是一个消息中间件它接受并转发消息你可以把它当做一个快递站点当你要发送一个包裹时你把你的包裹放到快递站快递员最终会把你的快递送到收件人那里按照这种逻辑是一个快递站一个快递员帮你传递快件与快递站的主要区别在于它不处理快件而是接收存储和转发消息数据四大核心概念生产者产生数据发送消息的程序是生产者交换机交换机是非常重要的一个部件一方面它接收来自生产者的消息另一方面它将消息推送到队列中交换机必须确切知道如何处理它接收到的消息是将这些消息推送到特定队列还是推送到多个队列亦或者是把消息丢弃这个得有交换机类型决定队列队列是内部使用的一种数据结构尽管消息流经和应用程序但它们只能存储在队列中队列仅受主机的内存和滋盘限制的约束本质上是一个大的消息缓冲区许多生产者可以将消息发送到一个队列许多消费者可以尝试从一个队列接收数据这就是我们使用队列的方式消费者消费与接收具有相似的含义消费者大多时候是一个等待接收消息的程序请注意生产者消费者和消息中间件很多时候并不在同一机器上同一个应用程序既可以是生产者又是可以是消费者核心部分各个名词介绍接收和分发消息的应用就是出于多租户和安全因素设计的把的基本组件划分到一个虚拟的分组中类似于网络中的概念当多个不同的用户使用同一个提供的服务时可以划分出多个每个用户在自己的创建等和之间的连接如果每一次访问都建立一个在消息量大的时候建立的开销将是巨大的效率也较低是在内部建立的逻辑连接如果应用程序支持多线程通常每个创建单独的进行通讯包含了帮助客户端和识别所以之间是完全隔离的作为轻量级的极大减少了操作系统建立的开销到达的第一站根据分发规则匹配查询表中的分发消息到中去常用的类型有消息最终被送到这里等待取走和之间的虚拟连接中可以包含信息被保存到中的查询表中用于的分发依据安装手动安装官网地址文件上传上传到目录下如果没有需要自己创建安装文件分别按照以下顺序安装常用命令按照以下顺序执行添加开机启动服务启动服务查看服务状态停止服务选择执行开启管理插件用默认账号密码访问地址出现权限问题添加一个新的用户创建账号设置用户角色设置用户权限用户具有这个中所有资源的配置写读权限当前用户和角色再次利用用户登录重置命令关闭应用的命令为清除的命令为重新启动命令为安装安装拉取镜像参数后台运行容器参数设置容器名称参数映射端口号格式为宿主机端口号容器内部端口号供客户端程序访问供后台应用管理界面访问参数卷映射目录参数设置容器内的环境变量这里我们设置了登录管理后台的默认用户和密码验证访问后台管理界面登录后界面如图我们将用编写两个程序发送单个消息的生产者和接收消息并打印出来的消费者下图中是我们的生产者是我们的消费者中间的框是一个队列代表使用者保留的消息缓冲区导入依赖消息发送端生产者创建连接工厂设置主机地址设置端口号默认为虚拟主机名称默认为设置连接用户名默认为设置连接密码默认为创建连接创建通道声明队列名称是否持久化是否独占本次连接若为则队列仅在本次连接可见连接关闭后队列自动删除是否自动删除若为则当最后一个消费者断开连接后队列会被删除其他参数发布消息交换机名称路由键用于将消息路由到指定的队列如果没有指定消息将发送到默认的交换机默认的交换机名称为空字符串消息属性用于设置消息的属性如消息的优先级过期时间等消息体即要发送的消息内容消息已发送关闭资源执行后如下所示可以在后台管理界面查看状态查看消息队列消息接收端消费者创建一个并设置主机名端口号虚拟主机用户名和密码设置连接参数通过工厂创建连接通过连接创建通道创建队列并指定队列名称是否持久化是否独占是否自动删除其他参数生产者已经创建了队列这里不需要再创建消费消息消费者标签用来标识消费者在监听消息时使用消息的元数据包括交换机路由键投递模式等消息的属性如消息的优先级过期时间等消息的正文即要发送的数据注册消费者指定队列名称是否自动应答消费者关闭资源执行结果如下再次查看状态再次查看消息队列工作模式工作模式概述有种用法以下是的一些常见用法消息队列最基本的用法是作为消息队列生产者将消息发送到服务器消费者从队列中获取消息并进行处理这种模式可以实现应用程序的解耦和异步通信发布订阅模式支持发布订阅模式允许生产者将消息发布到一个或多个交换机消费者订阅感兴趣的队列当有新消息到达时会将消息路由到所有订阅了相应队列的消费者路由模式在路由模式中生产者将消息发送到交换机并指定一个路由键根据路由键将消息路由到绑定了相应路由键的队列这种模式可以实现更精细的消息路由主题模式主题模式是路由模式的扩展允许使用通配符来匹配路由键例如可以使用通配符匹配一个单词使用通配符匹配任意数量的单词这种模式可以实现更灵活的消息路由远程过程调用可以用于实现机制允许客户端调用远程服务器上的方法客户端将请求消息发送到服务器处理请求并将响应消息发送回客户端工作队列又称任务队列的主要思想是避免立即执行资源密集型任务而不得不等待它完成相反我们安排任务在之后执行我们把任务封装为消息并将其发送到队列在后台运行的工作进程将弹出任务并最终执行作业当有多个工作线程时这些工作线程将一起处理这些任务本质上我们刚刚写的程序就是这种模式只是简化到了最简单的情况生产者只有一个发送一个消息消费者也只有一个消息也只能被这个消费者消费所以也称为简单模式现在我们还原一下常规情况生产者发送多个消息由多个消费者来竞争谁抢到算谁的结论多个消费者监听同一个队列则各消费者之间对同一个消息是竞争的关系工作模式适用于任务较重或任务较多的情况多消费者分摊任务可以提高消息处理的效率生产者代码封装工具类获取与服务器的连接与服务器的连接对象如果在创建连接时发生错误创建一个新的连接工厂对象设置服务器的主机地址设置服务器的端口号设置服务器的虚拟主机设置连接服务器的用户名设置连接服务器的密码返回新创建的连接对象连接成功连接失败编写代码发送消息效果消费者代码编写代码运行效果发布订阅模式模式需要引入新角色交换机生产者不是把消息直接发送到队列而是发送到交换机交换机接收消息而如何处理消息取决于交换机的类型交换机有如下种常见类型广播将消息发送给所有绑定到交换机的队列定向把消息交给符合指定的队列通配符把消息交给符合路由模式的队列注意交换机只负责转发消息不具备存储消息的能力因此如果没有任何队列与绑定或者没有符合路由规侧的队列那么消息会丢失组件之间关系生产者把消息发送到交换机队列直接和交换机绑定工作机制消息发送到交换机上就会以广播的形式发送给所有已绑定队列理解概念发布这里就是把消息发送到交换机上订阅这里只要把队列和交换机绑定事实上就形成了一种订阅关系生产者代码编写代码获取连接获取通道声明交换机交换机名称交换机类型是否持久化是否自动删除其他参数创建队列绑定队列到交换机队列名称交换机名称路由键用于指定消息的路由规则发送消息日志信息张三调用了方法释放资源执行效果可以通过后台查看我们刚创建的交换机点击栏的交换机名称跳转到详情页展开查看该交换机绑定的消息队列可以看到新增两个消息队列并分别发送了一条消息点击栏的消息队列名称可查看详情通过按钮可以查看消息详情消费者代码编写代码队列消费者日志打印队列消费者日志打印执行效果示例代码两个分别绑定不同的消息队列为非竞争关系若绑定相同的消息队列则为竞争关系路由模式通过路由绑定的方式把交换机和队列关联起来交换机和队列通过路由键进行绑定生产者发送消息时不仅要指定交换机还要指定路由键交换机接收到消息会发送到路由键绑定的队列在编码上与发布与订阅模式的区别交换机的类型为队列绑定交换机的时候需要指定生产者代码编写代码获取连接获取通道声明交换机交换机名称交换机类型是否持久化是否自动删除其他参数创建队列绑定队列到交换机队列名称交换机名称路由键用于指定消息的路由规则队列绑定路由键队列绑定路由键发送消息日志信息张三调用了方法执行出错日志级别发送成功释放资源运行效果新创建的交换机如图所示详情如图所示可以看到绑定了两个消息队列和关联一个路由键关联了三个路由键消费者代码编写代码队列消费者日志打印队列消费者日志打印执行效果由于我们只往路由键发送消息而关联一个路由键关联了三个路由键所以收不到消息可以收到消息我们可以修改为往路由键发送消息这样两个消费者就都能接收到消息了日志信息张三调用了方法执行出错日志级别主题模式类型与相比都是可以根据把消息路由到不同的队列只不过类型可以让队列在绑定的时候使用通配符一般都是由一个或多个单词组成多个单词之间以分割例如通配符规则匹配零个或多个词匹配一个词假设有一个主题交换机并且有以下队列和绑定队列绑定键为队列绑定键为队列绑定键为如果生产者发送一条路由键为的消息那么这条消息将被路由到和队列如果生产者发送一条路由键为的消息那么这条消息将被路由到和队列生产者代码编写代码获取连接获取通道声明交换机交换机名称交换机类型是否持久化是否自动删除其他参数创建队列绑定队列到交换机队列名称交换机名称路由键用于指定消息的路由规则常用格式系统名称日志级别需求所有级别日志存入数据库所有系统的日志存入数据库发送消息分别发送消息到队列所在系统日志级别日志内容订单生成保存成功发送成功所在系统日志级别日志内容商品发布成功发送成功所在系统日志级别日志内容商品发布失败发送成功释放资源执行效果创建的交换机信息如图所示创建的消息队列如图所示消费者代码编写代码队列消费者日志打印队列消费者日志打印执行效果匹配规则满足所有级别日志存入数据库所有系统的日志存入数据库则匹配所有消息我们先发送规则的消息执行并查看效果发送消息分别发送消息到队列所在系统日志级别日志内容订单生成保存成功发送成功所在系统日志级别日志内容商品发布成功发送成功所在系统日志级别日志内容商品发布失败发送成功由于与均能匹配规则所以与均能接收到消息我们再发送这个规则的消息清空日志重新发送消息发送消息分别发送消息到队列所在系统日志级别日志内容订单生成保存成功发送成功所在系统日志级别日志内容商品发布成功发送成功所在系统日志级别日志内容商品发布失败发送成功由于不能匹配规则所以只接收到一条消息接收到两条消息我们继续追加这个规则的消息发送消息分别发送消息到队列所在系统日志级别日志内容订单生成保存成功发送成功所在系统日志级别日志内容商品发布成功发送成功所在系统日志级别日志内容商品发布失败发送成功同理可知只接收到两条消息接收到三条消息远程过程调用远程过程调用本质上是同步调用和我们使用调用远程接口一样所以这不是典型的消息队列工作方式我们不展开说明工作模式小结直接发送到队列底层使用了默认交换机经过交换机发送到队列没有直接绑定队列通过绑定队列消息发送到绑定的队列上一个交换机绑定一个队列定点发送一个交换机绑定多个队列广播发送针对使用通配符整合基本思路搭建环境基础设定交换机名称队列名称绑定关系发送消息使用接收消息使用注解消费者操作步骤创建项目并导入依赖创建配置文件创建启动类写法一监听在服务器上创建交换机队列绑定关系消费端接收到消息消费端接收到消息写法二只监听消费端接收到消息消费端接收到消息测试启动服务登录管理界面查看交换机消息队列是否创建成功并建立绑定关系交换机消息队列绑定关系图形化界面操作创建交换机创建消息队列建立绑定关系添加后如下生产者操作步骤创建项目并导入依赖创建配置文件创建启动类创建测试类注意测试类包路径应与项目启动类所属包路径一致否则无法自动装配测试执行测试代码查看后台监控有一条消息待消费启动消费者服务进行消费消息可靠性投递问题场景及解决方案问题场景下单操作的正常流程如下图所示故障情况消息没有发送到消息队列上后果消费者拿不到消息业务功能缺失数据错误故障情况消息成功存入消息队列但是消息队列服务器宕机了原本保存在内存中的消息也丢失了即使服务器重新启动消息也找不回来了后果消费者拿不到消息业务功能缺失数据错误故障情况消息成功存入消息队列但是消费端出现问题例如宕机抛异常等等后果业务功能缺失数据错误解决方案故障情况消息没有发送到消息队列解决思路在生产者端进行确认具体操作中我们会分别针对交换机和队列来确认如果没有成功发送到消息队列服务器上那就可以尝试重新发送解决思路为目标交换机指定备份交换机当目标交换机投递失败时把消息投递至备份交换机故障情况消息队列服务器宕机导致内存中消息丢失解决思路消息持久化到硬盘上哪怕服务器重启也不会导致消息丢失故障情况消费端宕机或抛异常导致消息没有成功被消费消费端消费消息成功给服务器返回信息然后消息队列删除该消息消费端消费消息失败给服务器端返回信息同时把消息恢复为待消费的状态这样就可以再次取回消息重试一次当然这就需要消费端接口支持幂等性故障情况生产者端实现创建项目并导入依赖主启动类配置文件注意和是两个必须要增加的配置如果没有则本节功能不生效交换机的确认队列的确认配置类目标首先我们需要声明回调函数来接收服务器返回的确认信息方法名方法功能所属接口接口所属类确认消息是否发送到交换机确认消息是否发送到队列然后就是对的功能进行增强因为回调函数所在对象必须设置到对象中才能生效原本对象并没有生产者端消息确认的功能要给它设置对应的组件才可以而设置对应的组件需要调用对象下面两个方法设置组件调用的方法所需对象类型接口类型接口类型代码如下要点加注解加入容器已经包含了要点配置类自身实现这两个接口然后通过指针把配置类的对象设置到对象中操作封装到了一个专门的方法中为了保证这个方法在应用启动时被调用我们使用注解来修饰这个方法关于注解大家可以参照以下说明注解是中的一个标准注解它用于指定在对象创建之后立即执行的方法当使用依赖注入如框架或者其他方式创建对象时注解可以确保在对象完全初始化之后执行相应的方法使用注解的方法必须满足以下条件方法不能有任何参数方法必须是非静态的方法不能返回任何值当容器实例化一个带有注解的时它会在调用构造函数之后并在依赖注入完成之前调用被注解标记的方法这样我们可以在该方法中进行一些初始化操作比如读取配置文件建立数据库连接等消息发送到交换机成功或失败时调用这个方法用于关联消息的唯一标识符表示消息是否被成功确认如果消息确认失败这里会包含失败的原因回调函数打印回调函数打印回调函数打印当消息无法路由到队列时调用这个方法包含无法路由的消息的详细信息回调函数消息主体回调函数应答码回调函数描述回调函数消息使用的交换器回调函数消息使用的路由键测试类测试正常执行测试代码查看日志输出为为调整交换机名称故意使其发送失败重新执行并查看日志输出为有相应错误原因调整路由键名称故意使其无法匹配重新执行并查看日志输出打印了回到函数日志备份交换机实现创建备份交换机类型必须为因为消息从目标交换机转至备份交换机时是没有路由键的只能通过广播的方式查找队列创建队列交换机绑定队列执行目标交换机的备份交换机由于交换机创建后参数无法修改所以需要将原来的目标删除重新创建并执行备份交换机删除原来的目标交换机重新创建目标交换机队列重新绑定交换机重新执行测试测试结果为有一条消息待消费故障情况默认情况下服务宕机后消息会丢失吗我们手动重启下服务然后查看消息消费情况原来有一条消息待消费重启后重新查看发现带消费消息从条转变为条我们并未重新发送消息但消息并未丢失其实默认情况下是支持持久化数据的重启后会将保存到磁盘的数据重新加载到内存中我们可以查看下注解的源码找到这个接口可以看到和虽然默认值都为空但源码注释中有说明默认是支持持久化但是并不会自动删除的故障情况消费者端实现创建项目并导入依赖主启动类配置文件把消息确认模式改为手动确认与的区别比少了个是否批量操作的参数不能控制是否批量操作获取当前消息的唯一标识核心操作消费端接收到消息核心操作成功返回信息消息的唯一标识位的长整型消息往消费端投递时会分配一个唯一的值获取当前消息是否是重复投递的说明当前消息已经重试过一次了说明当前消息是第一次投递核心操作失败返回信息是否重新入队表示重新入队表示丢弃如果当前消息已经是重复投递的则说明此前已经重试过一次了则不再重试过了直接丢弃如果当前消息不是重复投递的则说明此前没有重试过一次则重试过一次重新入队消息确认相关方法参数说明交付标签机制消费端把消息处理结果等返回给之后需要对对应的消息执行后续操作例如删除消息重新排队或标记为死信等等那么就必须知道它现在要操作的消息具体是哪一条而作为消息的唯一标识就很好的满足了这个需求提问如果交换机是模式同一个消息广播到了不同队列会重复吗答不会在范围内唯一思考更新购物车的微服务消费了消息返回确认信息然后删除了消息进而导致更新库存更新积分的功能拿不到消息一这种情况会发生吗是否批量处理为时采用批量处理为时进行单独处理由于批量操作可能导致误操作所以一般将设为是否重新入队表示重新入队表示丢弃测试以模式启动服务在图形化界面生成一条消息找到交换机然后手动发布一条消息消息发布成功进入到方法内部再查看队列情况发现消息已经被消费尚未确认消费端正常放行返回进行确认再次查看队列情况接下来我们模拟异常场景修改代码手动打印使程序出错重启服务消费端接收到消息重新发布一条消息逐条执行观察运行情况出现异常被捕获此时的值为继续执行方法进入重新放入队列放行此时消息仍是待确认重新进入继续逐条执行这次的值为不再重试直接丢弃放行此时再查看队列情况消费端限流消费端限流可以实现削峰减谷的作用假设消息总量为万条如果一次性取出所有消息会导致消费端并发压力过大我们可以限制每次最多从队列取出条消息这样就可以对消费端进行很好的保护实现也比较简单只需添加参数即可先观察下默认情况下是如何处理的我们重写一个测试方法生产端发布条消息消息发布后查看下队列情况消费端注释掉原来的方法新增一个方法进行处理核心操作消费端接收到消息延迟秒运行消费端服务并查看队列情况观察发现数量直接从变为和随着消息被消费端消费逐渐减少说明消费时一次性取出队列中的所有消息然后逐条消费接下来我们限制每次从队列中获取的数量并观察队列运行情况添加配置设置每次从队列中获取消息的数量每次只消费一个消息重新发布消息以及重启消费端服务并观察队列运行情况我们可以看到数量每次变化减这是因为图形化界面每秒刷新一次消息超时给消息设定一个过期时间超过这个时间没有被取走的消息就会被删除我们可以从两个层面来给消息设定过期时间队列层面在队列层面设定消息的过期时间并不是队列的过期时间意思是这个队列中的消息全部使用同一个过期时间消息本身给具体的某个消息设定过期时间如果两个层面都做了设置那么哪个时间短哪个生效测试给队列设置超时时间创建交换机和队列并建立绑定关系交换机队列交换机绑定队列新增测试方法并执行测试此时观察队列情况发现数量从变为而我们并未运行消费端进行消费这是因为我们给队列设置了过期时间队列内的消息超出过期时间后被丢弃给消息设置超时时间删除原来的队列并重新创建不设置超时时间队列重新绑定新增测试方法添加后置处理器对象参数创建消息后置处理器对象设置消息的过期时间为秒设置为这样消息处理失败不会重新加入队列执行测试方法并观察队列情况消息超出超时时间后被清除死信和死信队列概念当一个消息无法被消费它就变成了死信死信产生的原因大致有下面三种拒绝消费者拒接消息并且不把消息重新放入原目标队列溢出队列中消息数量到达限制比如队列最大只能存储条消息且现在已经存储了条此时如果再发送一条消息进来根据先进先出原则队列中最早的消息会变成死信超时消息到达超时时间未被消费死信的处理方式大致有下面三种丢弃对不重要的消息直接丢弃不做处理入库把死信写入数据库日后处理监听消息变成死信后进入死信队列我们专门设置消费端监听死信队列做后续处理通常采用测试相关准备创建死信交换机和死信队列死信交换机死信队列死信路由键创建正常交换机和正常队列注意一定要注意正常队列有诸多限定和设置这样才能让无法处理的消息进入死信交换机关联的死信交换机关联的死信路由键队列最大容量长度队列超时时间正常交换机正常队列正常路由键代码中的相关常量声明消费端拒收消息发送消息的代码也可直接在图形化界面操作测试死信情况消息被拒绝接收消息的代码由于监听正常队列的方法一定会拒绝并且不会重新加入队列那么队列中的消息就会成为死信并加入到死信队列中死信队列正常返回监听正常队列监听正常队列监听正常队列但是拒绝消息消息接收到但我拒绝监听死信队列监听死信队列监听死信队列我是死信监听方法我接收到了死信消息执行结果正常队列发布消息重启消费端服务后台日志输出情况观察队列情况正常队列死信队列消费数量超过队列容量极限发送消息的代码测试死信情况数量超过队列最大容量接收消息的代码执行效果停止消费端服务批量发送条消息观察队列情况正常队列由于我们设置的最容量为所以我们最多接收条消息超出设定的超时时间后消息被废弃数量变为死信队列由于我们设置的最大容量为消息成为死信后每条消息为一个批次加入死信队列此时我们启动消费端服务观察日志输出情况可以发现都是级别的日志因为此时队列里的所有消息都变为死信了消息超时未消费发送消息的代码由于我们设置的队列最大容量为为了避免由于溢出产生死信的影响我们发送小于条的数据测试死信情况消息超时未消费执行效果停止消费端服务发送消息查看队列情况正常队列死信队列死信队列从原始的条数量增至条我们发送的条数据因为超时未消费加入到死信队列中延迟队列业务场景在限定时间内进行支付否则订单自动取消实现思路方案设置消息超时时间死信队列可参考上文介绍不再演示方案给安装插件插件介绍官网地址延迟极限最多两天安装插件确定卷映射目录运行结果查看中为对应的值可以看到值为下载延迟插件官方文档说明页地址下载插件安装文件若连接被拒绝可多次尝试或手动下载启用插件登录进入容器内部命令所在目录已经配置到环境变量中了可以直接调用查看插件列表检查插件是否启用有标识即为已启用退出容器重启容器确认确认点查看当前节点已启用插件的列表确认点如果创建新交换机时在中可以看到选项则说明插件安装好了创建交换机及队列创建交换机选择添加来指定交换机类型创建队列队列绑定交换机代码测试生产者端代码创建消息后置处理器对象消息的过期时间单位毫秒安装插件才生效消费者端代码监听死信队列消息本身当前时间启动消费者端服务并发送消息查看日志输出情况注意启用插件后方法始终会执行事务消息的事务只是作用到生产者端而且只起到局部作用的事务功能非常有限只是控制是否将缓存中的消息发送到并不能保证消息的可靠性投递实操演示环境准备创建项目并导入依赖配置文件启动类配置类测试类发送一条消息抛出异常发送第二条消息测试我们分别发送两条消息两条消息中间手动抛出异常来观察启用事务前后的区别创建交换机队列并绑定关系交换机名称队列名称路由键发送消息并观察队列情况默认未使用事务的情况第一条事务发送成功消息能够正常获取开启事务测试类添加注解由于中是默认回滚的我们想要提交事务需要添加注解发送一条消息抛出异常发送第二条消息我们保持默认回滚事务执行测试方法观察队列情况由于出现异常事务被回滚消息未发送惰性队列惰性队列未设置惰性模式时队列的持久化机制创建队列时在这里有两个选项可以选择持久化队列消息会持久化到硬盘上临时队列不做持久化操作重启后消息会丢失思考队列在存入消息之后是否是立即保存到硬盘呢其实并不会立即保存到硬盘当内存中的队列达到一定容量或者关闭时才会保存到硬盘官网上对于惰性队列的介绍比较下面两个说法是否是相同的意思立即移动到硬盘尽早移动到硬盘理解立即消息刚进入队列时尽早服务器不繁忙时惰性队列应用场景原文翻译使用惰性队列的主要原因之一是支持非常长的队列数百万条消息由于各种原因排队可能会变得很长消费者离线崩溃停机进行维护突然出现消息进入高峰生产者的速度超过了消费者消费者比正常情况慢优先级队列机制说明默认情况基于队列先进先出的特性通常来说先入队的先投递设置优先级之后优先级高的消息更大几率先投递关键参数允许我们使用一个正整数给消息设定优先级消息的优先级数值取值范围官网建议在之间设置消息的优先级优先级越高占用内存等资源越多队列在声明时可以指定参数默认值此时消息即使设置优先级也无效指定一个正整数值消息的优先级数值不能超过这个值实操演示创建交换机及队列并绑定交换机名称队列名称的类型必须是路由键分别发送三条消息优先级从低到高后面观察入队情况发送第一条消息消息本身的优先级数据不能超过队列配置的最大值发送第二条消息消息本身的优先级数据不能超过队列配置的最大值发送第三条消息消息本身的优先级数据不能超过队列配置的最大值启动客户端服务查看日志输出情况我们可以看到优先级高的先输出集群搭建安装前置要求课程要求发行版的版本其实也可以后面有详细介绍下载地址查看当前系统发行版本安装方式官方指南安装环境创建库配置文件加入配置内容以下内容来自官网文档更新库表示所需安装包即使不是最佳选择也接收若不支持系统参数则可不使用正式安装卸载旧版本若未安装过可跳过卸载旧版本的查找已安装的包卸载旧版本的检查并删除残留文件确保系统中没有其他版本的残留文件或配置查找并删除所有与相关的目录查找并删除所有与相关的文件查找并删除所有与相关的符号链接安装时需要注意与的版本匹配详细介绍见官网如课程中使用的是需要安装的版本需要由于安装包支持的版本较老如兼容的最低版本为最高通过安装可参考文章配置下载地址我们需要下载与之相兼容的版本如代表仓库地址将文件上传到的某个目录上如安装检查版本验证是否安装成功或者用命令其中是我们安装的版本是库依赖的版本通过安装可参考文章安装亲测通过安装包下载地址选择与相兼容的版本如代表适用若执行第一步出现如下错误检查版本若为执行如下命令创建软连接使用执行步骤安装了存储库步骤安装软件包若下载失败可到官网手动下载安装下载地址会跳转至下载完成后将文件上传到某个目录如通过以下代码完成安装使用包管理器安装编译器选项表示自动回答以确认所有提示使用命令解压源码包选项表示使用解压选项表示解压选项表示显示详细信息选项指定文件名进入解压后的源码目录运行脚本选项指定的安装路径为编译并安装会执行编译后的安装步骤查看是否安装成功以及设置环境变量列出目录下的所有文件和目录是的别名显示详细信息将的目录添加到系统的环境变量中以便在终端中可以直接使用命令重新加载文件使环境变量配置立即生效检查版本验证是否安装成功或者用验证安装最新版会遇到的坑此处发现打印的是版本是使用验证下发现安装时提示如下错误错误依赖检测失败被需要安装导入密钥下载包若下载失败多尝试几次或重启后重新尝试安装通过跳转到下载界面选择与相兼容的版本如上传到某个目录如安装显示如下信息代表安装成功警告头密钥准备中正在升级安装基础配置启动服务前注意停用之前的服务以免造成端口冲突启用管理界面插件启动服务将服务设置为开机自动启动新增登录账号密码设置登录账号权限设置所有稳定功能启动重新启动服务收尾工作若不删除该配置以后用安装会受到该配置影响克隆虚拟机目标通过克隆操作一共准备三台虚拟机集群节点名称虚拟机地址克隆虚拟机需克隆完整连接如下给新机器设置地址在中可以使用命令行工具修改地址以下是具体步骤查看网络连接信息停止指定的网络连接将替换为实际的网络连接名称修改地址将替换为实际的网络连接名称将替换为新的地址将替换为子网掩码将替换为网关这里是表示法手动启动网络连接验证新的地址是否生效修改主机名称主机名称会被作为集群中的节点名称后面会用到所以需要设置一下修改后需重启查看当前系统名称修改当前系统名称保险措施为了在后续操作过程中万一遇到操作失误友情建议拍摄快照集群节点彼此发现设置设置地址到主机名称的映射修改文件追加如下内容查看当前节点的值并记录显示如下重置节点应用设置设置地址到主机名称的映射修改文件追加如下内容修改当前节点的值和都改成和一样重置节点应用并加入集群设置设置地址到主机名称的映射修改文件追加如下内容修改当前节点的值和都改成和一样重置节点应用并加入集群查看集群状态显示如下也可登录管理后台查看负载均衡说明两个需要暴露的端口目前集群方案管理界面负载均衡核心功能负载均衡安装安装检查是否安装成功启动设置开机自启动修改配置文件配置文件位置在配置文件未尾增加如下内容设置策略允许拥有权限连接任意端口是系统中的安全模块它可以限制进程的权限以提高系统的安全性在某些情况下可能会阻止绑定指定的端口这就需要通过设置域的安全策略来解决此问题通过执行命令您已经为设置了一个布尔值允许连接到任意端口这样就可以成功绑定指定的并正常工作重启测试效果访问配置的前台负载均衡地址查看是否可以正常打开管理端界面负载均衡核心功能添加配置配置文件位置在配置文件未尾增加如下内容重启测试创建组件交换机队列路由键创建生产者端程序核心配置文件交换机的确认队列的确认配置类消息发送到交换机成功或失败时调用这个方法用于关联消息的唯一标识符表示消息是否被成功确认如果消息确认失败这里会包含失败的原因消息发送到交换机成功数据消息发送到交换机失败数据错误原因当消息无法路由到队列时调用这个方法包含无法路由的消息的详细信息回调函数消息主体回调函数应答码回调函数描述回调函数消息使用的交换器回调函数消息使用的路由键启动类测试类创建消费者端程序核心配置文件手动确认消费者端消息内容启动类运行结果镜像队列镜像队列在新版本中已被仲裁队列取代这里不再介绍仲裁队列版本的主要更新内容未来有可能取代创建仲裁队列可以将队列同步到集群中的每个节点上操作步骤创建仲裁队列需要在集群的基础上创建创建交换机和仲裁队列绑定的交换机没有特殊要求我们还是创建一个交换机即可交换机名称创建仲裁队列队列名称创建好后如图所示详情信息绑定交换机路由键测试常规测试像使用经典队列一样发送消息消费消息生产者端日志输出情况队列情况消费者端消费者端消息内容日志输出情况队列情况高可用测试停止某个节点的应用停止应用此时可以再观察下队列详情可以发现已自动选举出新的再次发送消息修改发送消息的内容以区分之前发送的消息消费者端能够正常消费控制台有报错是因为有节点下线属于正常情况流式队列在推出的新特性工作机制在一个仅追加的日志文件内保存所发送的消息给每个消息都分配个偏移页即使消息被消费端消费掉消息依然保存在日志文件中可重复消费总体评价从客户端支持角度来说生态尚不健全从使用习惯角度来说和原有队列用法不完全兼容从竞品角度来说像但远远比不上从应用场景角度来说经典队列适用于系统内部异步通信场景流式队列适用于系统间跨平台大流量实时计算场景主场使用建议队列在目前企业实际应用非常少真有特定场景需要使用肯定会倾向于使用而不是未来展望已经有和合二为一的趋势也有加入进来整合成一种队列的趋势但内部机制决定这很难使用步骤启用插件说明只有启用了插件才能使用流式队列的完整功能在集群每个节点中依次执行如下操作启用插件重启应用查看插件状态负载均衡配置文件位置在配置文件未尾增加如下内容重启代码专属客户端官方网址专属客户端官方文档网址引入依赖创建不需要创建交换机代码方式创建创建生产端程序内部机制说明官方文档翻译在内部将查问以了解流的拓扑结构并将创建或重用连接以发布到流的节点解析在中封装的连接信息仅负责连接到在构建对象时会访问拉取集群中的连接信息将来实际访问的是集群中的节点的连接信息格式是节点名称端口号配置文件位置为了让本机的应用程序知道节点名称对应的地址我们需要在本地配置文件建立从节点名称到地址的映射关系测试示例代码生产者端生产者端消费端程序消费者指定偏移量消费偏移量官网文档说明指定消费消费者端对比方式始终监听中的新消息狗狗看家忠于职守指定偏移量方式针对指定偏移量的消息消费之后就停止狗狗叼飞盘叼回来就完插件简介插件的设计目标是使在不同的节点之间进行消息传送而无须建立集群它可以在不同的管理域中的或集群间传递消息这些管理域可能设置了不同的用户和也可能运行在不同版本的和上基于协议在不同的之间进行通信并且设计成能够密忍不稳定的网络连接情况交换机总体说明各节点操作启用联邦插件下游操作添加上游连接端点创建控制策略准备工作为了执行相关测试我们使用创建两个实例特别提示由于机制的最大特点就是跨集群同步数据所以这两个容器中的实例不加入集群是两个独立的实例上游下游启用联邦插件在上游下游节点中都需要开启容器中的已经开启了还需要开启使用以下命令进入容器的插件启用后会在的选项卡下看到添加上游连接端点在下游节点填写上游节点的连接信息创建控制策略详细配置如下测试测试计划特别提示普通交换机和联邦交换机名称要一致交换机名称要能够和策略正则表达式匹配上发送消息时两边使用的路由键也要一致队列名称不要求一致创建组件所在机房交换机名称路由键队列名称深圳机房上游上海机房下游创建组件后可以查看一下联邦状态连接成功的联邦状态如下发布消息执行测试在上游节点向交换机发布消息下游两个队列消息总量均变成了队列总体说明队列和交换机的最核心区别就是作用在交换机上就是交换机作用在队列上就是队列创建控制策略详细配置如下测试测试计划上游节点和下游节点中队列名称是相同的只是下游队列中的节点附加了联邦策略而已所在机房交换机名称路由键队列名称深圳机房上游上海机房下游创建组件上游节点都是常规操作此处省略重点需要关注的是下游节点的联邦队列创建时需要指定相关参数创建组件后可以查看一下联邦状态连接成功的联邦状态如下执行测试在上游节点向交换机发布消息但此时发现下游节点中联邦队列并没有接收到消息这是为什么呢这里就体现出了联邦队列和联邦交换机工作逻辑的区别对联邦队列来说如果没有监响联队列的消费端程序它是不会到上游去拉取消息的如果有消费端监听联邦队列那么首先消费联邦队列自身的消息如果联邦队列为空这时候才会到上游队列节点中拉取消息所以现在的测试效果需要消费端程序配合才能看到插件是铲子的意思把消息铲走从源节点移至目标节点源节点将收不到消息启用插件使用以下命令进入容器的启用后管理界面可以看到如下配置配置不区分上下游在哪个节点配置都可以测试测试计划所在机房交换机名称路由键队列名称深圳机房上海机房测试效果发布消息源节点目标节点如果测试效果与视频中演示不一致可检查配置的账号密码是否正确可用查看日志可点击查看配置详情例如此处我错误地将用户名写为正确应为如果账号密码配置错误导致无法连接实际测试效果将和普通队列相同源节点目标节点',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-15 21:17:07',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><script async="" defer="" src="https://umami.shiguangdev.cn/script.js" data-website-id="bc279f56-9a19-416a-a035-58c0abed887b"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="時光" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/avatar.png"><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.shiguang666.eu.org" title="時光主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="時光主页"><span class="back-menu-item-text">時光主页</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://nav.shiguang666.eu.org" title="時光导航站"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="時光导航站"><span class="back-menu-item-text">時光导航站</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://game.shiguang666.eu.org" title="怀旧游戏机"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="怀旧游戏机"><span class="back-menu-item-text">怀旧游戏机</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://umami.shiguangdev.cn/share/1CY8KW6pqM0UBUIL/blog.shiguangdev.cn" title="访客统计"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://umami.shiguangdev.cn/favicon.ico" alt="访客统计"><span class="back-menu-item-text">访客统计</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">后台管理</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://img.shiguangdev.cn/" title="時光图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/favicon.ico" alt="時光图床"><span class="back-menu-item-text">時光图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://qexo.shiguang666.eu.org/" title="Hexo管理面板"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://qexo.shiguang666.eu.org/favicon.ico" alt="Hexo管理面板"><span class="back-menu-item-text">Hexo管理面板</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">時光</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随机</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/news/"><i class="fa fa-calendar faa-tada"></i><span> 早报亭</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/?id=10051718332&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/gallery/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/xjj/"><i class="fa fa-rocket faa-tada"></i><span> 养生堂</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/flink/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comment/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">31</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">38</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">30</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">20</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url">学习笔记</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>尚硅谷</span></a><a class="article-meta__tags" href="/tags/RabbitMQ/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>RabbitMQ</span></a></span></div></div><h1 class="post-title" itemprop="name headline">【尚硅谷】RabbitMQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-10-10T12:30:47.000Z" title="发表于 2024-10-10 20:30:47">2024-10-10</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-12-15T13:17:07.922Z" title="更新于 2024-12-15 21:17:07">2024-12-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">27.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>120分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为上海"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>上海</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/10/10/3149a4506563/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope="" itemtype="https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/"><header><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url">学习笔记</a><a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/" tabindex="-1" itemprop="url">尚硅谷</a><a href="/tags/RabbitMQ/" tabindex="-1" itemprop="url">RabbitMQ</a><h1 id="CrawlerTitle" itemprop="name headline">【尚硅谷】RabbitMQ</h1><span itemprop="author" itemscope="" itemtype="http://schema.org/Person">時光</span><time itemprop="dateCreated datePublished" datetime="2024-10-10T12:30:47.000Z" title="发表于 2024-10-10 20:30:47">2024-10-10</time><time itemprop="dateCreated datePublished" datetime="2024-12-15T13:17:07.922Z" title="更新于 2024-12-15 21:17:07">2024-12-15</time></header><div id="postchat_postcontent"><blockquote>
<p>在线视频:<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sw4m1U7Qe">尚硅谷2024最新RabbitMQ教程，消息中间件RabbitMQ迅速上手！</a><br>官方资料: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/14quDrJSfphJfC6seNo6-CA?pwd=yyds">尚硅谷2024最新版RabbitMQ视频</a></p>
<p>代码<br>Gitee：<a target="_blank" rel="noopener" href="https://gitee.com/an_shiguang/learn-rabbitmq">https://gitee.com/an_shiguang/learn-rabbitmq</a><br>GitHub: <a target="_blank" rel="noopener" href="https://github.com/Shiguang-coding/learn-rabbitmq">https://github.com/Shiguang-coding/learn-rabbitmq</a></p>
</blockquote>
<h1 id="MQ的相关概念"><a href="#MQ的相关概念" class="headerlink" title="MQ的相关概念"></a>MQ的相关概念</h1><h2 id="什么是MQ"><a href="#什么是MQ" class="headerlink" title="什么是MQ"></a>什么是MQ</h2><p>MQ(message queue),从字面意思上看，本质是个队列，FIFO先入先出，只不过队列中存放的内容是message而已，还是一种跨进程的通信机制，用于上下游传递消息。在互联网架构中，MQ是一种非常常见的上下游“逻辑解耦+物理解耦”的消息通信服务。使用了MQ之后，消息发送上游只需要依赖MQ,不用依赖其他服务。</p>
<h2 id="为什么要用MQ"><a href="#为什么要用MQ" class="headerlink" title="为什么要用MQ"></a>为什么要用MQ</h2><h3 id="流量消峰"><a href="#流量消峰" class="headerlink" title="流量消峰"></a>流量消峰</h3><p>举个例子，如果订单系统最多能处理一万次订单，这个处理能力应付正常时段的下单时绰绰有余，正常时段我们下单一秒后就能返回结果。但是在高峰期，如果有两万次下单操作系统是处理不了的，只能限制订单超过一万后不允许用户下单。使用消息队列做缓冲，我们可以取消这个限制，把一秒内下的订单分散成一段时间来处理，这时有些用户可能在下单十几秒后才能收到下单成功的操作，但是比不能下单的体验要好。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707cd1d08c34.png" alt="image-20241010204828111"></p>
<h3 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h3><p>以电商应用为例，应用中有订单系统、库存系统、物流系统、支付系统。用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障，都会造成下单操作异常。当转变成基于消息队列的方式后，系统间调用的问题会减少很多，比如物流系统因为发生故障，需要几分钟来修复。在这几分钟的时间里，物流系统要处理的内存被缓存在消息队列中，用户的下单操作可以正常完成。当物流系统恢复后，继续处理订单信息即可，中单用户感受不到物流系统的故障，提升系统的可用性。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707cd9f9d363.png" alt="image-20241010205039359"></p>
<h3 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h3><p>有些服务间调用是异步的，例如A调用B,B需要花费很长时间执行，但是A需要知道B什么时候可以执行完，以前一般有两种方式，A过一段时间去调用B的查询api查询。或者A提供一个callback api,B执行完之后调用api通知A服务。这两种方式都不是很优雅，使用消息总线，可以很方便解决这个问题，A调用B服务后，只需要监听B处理完成的消息，当B处理完成后，会发送一条消息给MQ,MQ会将此消息转发给A服务。这样A服务既不用循环调用B的查询api,也不用提供callback api。同样B服务也不用做这些操作。A服务还能及时的得到异步处理成功的消息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707ce1983cc7.png" alt="image-20241010205241250"></p>
<h2 id="MQ的分类"><a href="#MQ的分类" class="headerlink" title="MQ的分类"></a>MQ的分类</h2><h3 id="消息队列底层实现的两大主流方式"><a href="#消息队列底层实现的两大主流方式" class="headerlink" title="消息队列底层实现的两大主流方式"></a>消息队列底层实现的两大主流方式</h3><ul>
<li>由于消息队列执行的是跨应用的信息传递，所以制定<strong>底层通信标准</strong>非常必要</li>
<li>目前主流的消息队列通信协议标准包括：<ul>
<li>AMQP(Advanced Message Queuing Protocol):<strong>通用</strong>协议，IBM公司研发</li>
<li>JMS(Java Message Service):<strong>专门</strong>为<strong>Java</strong>语言服务，SUN公司研发，一组由Java接口组成的Java标准</li>
</ul>
</li>
</ul>
<h3 id="AMQP与JMS对比"><a href="#AMQP与JMS对比" class="headerlink" title="AMQP与JMS对比"></a>AMQP与JMS对比</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707cf2221479.png" alt="image-20241010205705458"></p>
<h3 id="各主流MQ产品对比"><a href="#各主流MQ产品对比" class="headerlink" title="各主流MQ产品对比"></a>各主流MQ产品对比</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707cff25501d.png" alt="image-20241010210033971"></p>
<p><strong>1、ActiveMQ</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV164411G7aB">尚硅谷ActiveMQ教程(MQ消息中间件快速入门)</a></p>
</blockquote>
<p>优点：单机吞吐量万级，时效性ms级，可用性高，基于主从架构实现高可用性，消息可靠性较低的概率丢失数据<br>缺点：官方社区现在对ActiveMQ5.x维护越来越少，高吞吐量场景较少使用。</p>
<p><strong>2、Kafka</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Gp421m7UN">尚硅谷Kafka教程，2024新版kafka视频，零基础入门到实战</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vr4y1677k">【尚硅谷】Kafka3.x教程（从入门到调优，深入全面）</a></p>
</blockquote>
<p>大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开Kafka,这款<strong>为大数据而生</strong>的消息中间件，以其<strong>百万级TPS</strong>的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存诸的过程中发挥着举足轻重的作用。目前已经被LinkedIn，Uber，Twitter，Netflix等大公司所采纳。</p>
<p>优点：性能卓越，单机写入TPS约在百万条/秒，最大的优点，就是<strong>吞吐量高</strong>。时效性ms级可用性非常高，kafka是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用，消费者采用Pull方式获取消息，消息有序，通过控制能够保证所有消息被消费且仅被消费一次;有优秀的第三方Kafka Web管理界面Kafka-Manager;在日志领域比较成熟，被多家公司和多个开源项目使用；功能支持：功能较为简单，主要支持简单的MQ功能，在大数据领域的实时计算以及<strong>日志采集</strong>被大规模使用</p>
<p>缺点：Kafka单机超过64个队列/分区，Load会发生明显的飙高现象，队列越多，load越高，发送消息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序，但是一台代理宕机后，就会产生消息乱序，<strong>社区更新较慢</strong>；</p>
<p><strong>3、RocketMQ</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cf4y157sz">【尚硅谷】RocketMQ教程丨深度掌握MQ消息中间件</a></p>
</blockquote>
<p>RocketMQ出自阿里巴巴的开源产品，用java语言实现，在设计时参考了Kafka,并做出了自己的一些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog分发等场景。</p>
<p>优点：单<strong>机吞吐量十万级</strong>，可用性非常高，分布式架构，<strong>消息可以做到0丢失</strong>，MQ功能较为完善，还是分布式的，扩展性好，<strong>支持10亿级别的消息堆积</strong>，不会因为堆积导致性能下降，源码是jva我们可以自己阅读源码，定制自己公司的MQ</p>
<p>缺点：<strong>支持的客户端语言不多</strong>，目前是java及c++,其中c++不成熟；社区活跃度一般，没有在MQ核心中去实现JMS等接口，有些系统要迁移需要修改大量代码</p>
<p><strong>4、RabbitMQ</strong></p>
<p>2007年发布，是一个在AMQP(高级消息队列协议)基础上完成的，可复用的企业消息系统，是<strong>当前最主流的消息中间件之一</strong>。</p>
<p>优点：由于erlang语言的<strong>高并发特性</strong>，性能较好；<strong>吞吐量到万级</strong>，MQ功能比较完备，健壮、稳定、易用、跨平台、<strong>支持多种语言</strong>如：Python、Ruby、.NET、Java、JS、C、PHP、ActionScript、XMPP、STOMP等，支持A]AX文档齐全；开源提供的管理界面非常棒，用起来很好用，<strong>社区活跃度高</strong>；更新频率相当高</p>
<p>缺点：商业版需要收费，学习成本较高</p>
<h2 id="MQ的选择"><a href="#MQ的选择" class="headerlink" title="MQ的选择"></a>MQ的选择</h2><p><strong>1、Kafka</strong><br>Kafka主要特点是基于Pul的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输，适合产生<strong>大量数据</strong>的互联网服务的数据收集业务。<strong>大型公司</strong>建议可以选用，如果有<strong>日志采集</strong>功能，肯定是首选kafka了。</p>
<p><strong>2、RocketMQ</strong><br>天生为<strong>金融互联网</strong>领域而生，对于可靠性要求很高的场景，尤其是电商里面的订单扣款，以及业务削峰，在大量交易涌入时，后端可能无法及时处理的情况。RoketMQ在稳定性上可能更值得信赖，这些业务场景在阿里双11已经经历了多次考验，如果你的业务有上述并发场景，建议可以选择RocketMQ。</p>
<p><strong>3、RabbitMQ</strong><br>结合erlang语言本身的并发优势，性能好<strong>时效性微秒级</strong>，<strong>社区活跃度也比较高</strong>，管理界面用起来十分<br>方便，如果你的<strong>数据量没有那么大</strong>，中小型公司优先选择功能比较完备的RabbitMQ。</p>
<h1 id="RabbitMQ介绍"><a href="#RabbitMQ介绍" class="headerlink" title="RabbitMQ介绍"></a>RabbitMQ介绍</h1><h2 id="RabbitMQ的概念"><a href="#RabbitMQ的概念" class="headerlink" title="RabbitMQ的概念"></a>RabbitMQ的概念</h2><p>RabbitMQ是一个消息中间件：它接受并转发消息。你可以把它当做一个快递站点，当你要发送一个包裹时，你把你的包裹放到快递站，快递员最终会把你的快递送到收件人那里，按照这种逻辑RabbitMQ是一个快递站，一个快递员帮你传递快件。RabbitMQ与快递站的主要区别在于，它不处理快件而是接收，存储和转发消息数据。</p>
<h2 id="四大核心概念"><a href="#四大核心概念" class="headerlink" title="四大核心概念"></a>四大核心概念</h2><p><strong>生产者</strong><br>产生数据发送消息的程序是生产者</p>
<p><strong>交换机</strong><br>交换机是RabbitMQ非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个得有交换机类型决定。</p>
<p><strong>队列</strong></p>
<p>队列是RabbitMQ内部使用的一种数据结构，尽管消息流经RabbitMQ和应用程序，但它们只能存储在队列中。队列仅受主机的内存和滋盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者可以尝试从一个队列接收数据。这就是我们使用队列的方式。</p>
<p><strong>消费者</strong><br>消费与接收具有相似的含义。消费者大多时候是一个等待接收消息的程序。请注意生产者，消费者和消息中间件很多时候并不在同一机器上。同一个应用程序既可以是生产者又是可以是消费者。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707d6e7a8ae4.png" alt="image-20241010213015369"></p>
<h2 id="RabbitMQ核心部分"><a href="#RabbitMQ核心部分" class="headerlink" title="RabbitMQ核心部分"></a>RabbitMQ核心部分</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707d7fb6d265.png" alt="image-20241010213451006"></p>
<h2 id="各个名词介绍"><a href="#各个名词介绍" class="headerlink" title="各个名词介绍"></a>各个名词介绍</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707d81c1fa11.png" alt="image-20241010213523739"></p>
<p><strong>Broker</strong>：接收和分发消息的应用， RabbitMQ Server 就是 Message Broker</p>
<p><strong>Virtual host</strong>：出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个 vhost，每个用户在自己的 vhost 创建 exchange／ queue 等</p>
<p><strong>Connection</strong>： publisher／ consumer 和 broker 之间的 TCP 连接</p>
<p><strong>Channel</strong>：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。 Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个 thread 创建单独的 channel 进行通讯， AMQP method 包含了 channel id 帮助客户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。 Channel 作为轻量级的<strong>Connection 极大减少了操作系统建立 TCP connection 的开销</strong></p>
<p><strong>Exchange</strong>： message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到 queue 中去。常用的类型有： direct (point-to-point), topic (publish-subscribe) and fanout (multicast)</p>
<p><strong>Queue</strong>： 消息最终被送到这里等待 consumer 取走</p>
<p><strong>Binding</strong>： exchange 和 queue 之间的虚拟连接， binding 中可以包含 routing key， Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</p>
<h1 id="安装RabbitMQ"><a href="#安装RabbitMQ" class="headerlink" title="安装RabbitMQ"></a>安装RabbitMQ</h1><h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><p><strong>1、官网地址</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></p>
<p>2、<strong>文件上传上传到<code>/usr/local/software</code> 目录下</strong>(如果没有 software 需要自己创建)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707da33347fe.png" alt="image-20241010214418997"></p>
<p><strong>3、安装文件(分别按照以下顺序安装)</strong>  </p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh erlang-21.3-1.el7.x86_64.rpm</span><br><span class="line">yum install socat -y</span><br><span class="line">rpm -ivh rabbitmq-server-3.8.8-1.el7.noarch.rpm</span><br></pre></td></tr></tbody></table></figure>

<p><strong>4、常用命令(按照以下顺序执行)</strong></p>
<p>添加开机启动 RabbitMQ 服务</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig rabbitmq-server on</span><br></pre></td></tr></tbody></table></figure>

<p>启动服务</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service rabbitmq-server start</span><br></pre></td></tr></tbody></table></figure>

<p>查看服务状态</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service rabbitmq-server status</span><br></pre></td></tr></tbody></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707db57417c8.png" alt="image-20241010214909944"></p>
<p>停止服务(选择执行)</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/service rabbitmq-server stop</span><br></pre></td></tr></tbody></table></figure>

<p>开启 web 管理插件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br></pre></td></tr></tbody></table></figure>

<p>用默认账号密码(guest)访问地址 <code>http://47.115.185.244:15672</code>出现权限问题  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707db0cbee0a.png" alt="image-20241010214756433"></p>
<p><strong>5、添加一个新的用户</strong></p>
<p>创建账号</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user admin 123</span><br></pre></td></tr></tbody></table></figure>

<p>设置用户角色</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_user_tags admin administrator</span><br></pre></td></tr></tbody></table></figure>

<p>设置用户权限</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;read&gt; </span></span><br><span class="line">rabbitmqctl set_permissions -p <span class="string">"/"</span> admin <span class="string">".*"</span> <span class="string">".*"</span> <span class="string">".*"</span></span><br></pre></td></tr></tbody></table></figure>

<p>用户 user_admin 具有/vhost1 这个 virtual host 中所有资源的配置、写、读权限</p>
<p>当前用户和角色</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl list_users</span><br></pre></td></tr></tbody></table></figure>

<p><strong>6、再次利用 admin 用户登录</strong>  </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707dc2323d67.png" alt="image-20241010215234896"></p>
<p><strong>7、重置命令</strong></p>
<p>关闭应用的命令为:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></tbody></table></figure>

<p>清除的命令为</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl reset</span><br></pre></td></tr></tbody></table></figure>

<p>重新启动命令为</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><p><strong>1、安装</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line">docker pull rabbitmq:3.13-management</span><br><span class="line"></span><br><span class="line"><span class="comment"># -d 参数：后台运行 Docker 容器</span></span><br><span class="line"><span class="comment"># --name 参数：设置容器名称</span></span><br><span class="line"><span class="comment"># -p 参数：映射端口号,格式为 "宿主机端口号:容器内部端口号" 5672供客户端程序访问,15672供后台应用管理界面访问</span></span><br><span class="line"><span class="comment"># -v 参数：卷映射目录</span></span><br><span class="line"><span class="comment"># -e 参数：设置容器内的环境变量,这里我们设置了登录RabbitMQ管理后台的默认用户和密码</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq \</span><br><span class="line">-p 5672:5672 \</span><br><span class="line">-p 15672:15672 \</span><br><span class="line">-v rabbitmq-plugin:/plugins \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=guest \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line">rabbitmq:3.13-management</span><br></pre></td></tr></tbody></table></figure>

<p><strong>2、验证</strong></p>
<p>访问后台管理界面： <code>http://&lt;ip&gt;:15672</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707e83b952cd.png" alt="image-20241010224411426"></p>
<p>登录后界面如图:<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/10/6707e88738459.png" alt="image-20241010224526884"></p>
<h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><p>我们将用java编写两个程序。发送单个消息的生产者和接收消息并打印出来的消费者。<br>下图中，”P”是我们的生产者，”C”是我们的消费者。中间的框是一个队列-RabbitMQ 代表使用者保留的消息缓冲区</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670885105d9c1.png" alt="image-20241011095319454"></p>
<h2 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;</span><br><span class="line">   &lt;version&gt;5.20.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="消息发送端-生产者"><a href="#消息发送端-生产者" class="headerlink" title="消息发送端(生产者)"></a>消息发送端(生产者)</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 10:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException {</span><br><span class="line">        <span class="comment">// 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置主机地址</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">"192.168.10.66"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置端口号: 默认为5672</span></span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 虚拟主机名称: 默认为/</span></span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置连接用户名: 默认为guest</span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置连接密码: 默认为guest</span></span><br><span class="line">        connectionFactory.setPassword(<span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明队列</span></span><br><span class="line">        <span class="comment">// queue 名称</span></span><br><span class="line">        <span class="comment">// durable 是否持久化</span></span><br><span class="line">        <span class="comment">// exclusive 是否独占本次连接,若为true,则队列仅在本次连接可见,连接关闭后,队列自动删除</span></span><br><span class="line">        <span class="comment">// autoDelete 是否自动删除,若为true,则当最后一个消费者断开连接后,队列会被删除</span></span><br><span class="line">        <span class="comment">// arguments 其他参数</span></span><br><span class="line">        channel.queueDeclare(<span class="string">"simple_queue"</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发布消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"hello rabbitmq"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// routingKey 路由键,用于将消息路由到指定的队列,如果没有指定,消息将发送到默认的交换机,默认的交换机名称为空字符串</span></span><br><span class="line">        <span class="comment">// props 消息属性,用于设置消息的属性,如消息的优先级、过期时间等</span></span><br><span class="line">        <span class="comment">// body 消息体,即要发送的消息内容</span></span><br><span class="line">        channel.basicPublish(<span class="string">""</span>, <span class="string">"simple_queue"</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"消息已发送:"</span> + message + <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>执行后如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a1a724d9e.png" alt="image-20241011115518386"></p>
<p>可以在后台管理界面查看状态</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a15f7c5d7.png" alt="image-20241011115406548"></p>
<p>查看消息队列</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a1759f72f.png" alt="image-20241011115428733"></p>
<h2 id="消息接收端-消费者"><a href="#消息接收端-消费者" class="headerlink" title="消息接收端(消费者)"></a>消息接收端(消费者)</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 11:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 1、创建一个ConnectionFactory，并设置主机名、端口号、虚拟主机、用户名和密码。</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2、设置连接参数。</span></span><br><span class="line">        factory.setHost(<span class="string">"192.168.10.66"</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">"/"</span>);</span><br><span class="line">        factory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、通过工厂创建连接。</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、通过连接创建通道。</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5、创建队列，并指定队列名称、是否持久化、是否独占、是否自动删除、其他参数。</span></span><br><span class="line">        <span class="comment">// 生产者已经创建了队列，这里不需要再创建</span></span><br><span class="line"><span class="comment">//        channel.queueDeclare("simple.queue", true, false, false, null);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、消费消息</span></span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// consumerTag 消费者标签，用来标识消费者，在监听消息时使用。</span></span><br><span class="line">            <span class="comment">// envelope 消息的元数据，包括交换机、路由键、投递模式等。</span></span><br><span class="line">            <span class="comment">// properties 消息的属性，如消息的优先级、过期时间等。</span></span><br><span class="line">            <span class="comment">// body 消息的正文，即要发送的数据。</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"consumerTag: "</span> + consumerTag);</span><br><span class="line">                System.out.println(<span class="string">"Exchange: "</span> + envelope.getExchange());</span><br><span class="line">                System.out.println(<span class="string">"RoutingKey: "</span> + envelope.getRoutingKey());</span><br><span class="line">                System.out.println(<span class="string">"properties: "</span> + properties);</span><br><span class="line">                System.out.println(<span class="string">"body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7、注册消费者，指定队列名称、是否自动应答、消费者。</span></span><br><span class="line">        channel.basicConsume(<span class="string">"simple_queue"</span>, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8、关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>执行结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a2430c500.png" alt="image-20241011115754203"></p>
<p>再次查看状态</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a26b0a9ca.png" alt="image-20241011115834136"></p>
<p>再次查看消息队列</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a2856c188.png" alt="image-20241011115900482"></p>
<h1 id="RabbitMQ工作模式"><a href="#RabbitMQ工作模式" class="headerlink" title="RabbitMQ工作模式"></a>RabbitMQ工作模式</h1><h2 id="工作模式概述"><a href="#工作模式概述" class="headerlink" title="工作模式概述"></a>工作模式概述</h2><p>RabbitMQ有7种用法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708a47fbeda7.png" alt="image-20241011120726844"></p>
<p>以下是 RabbitMQ 的一些常见用法：</p>
<ol>
<li><p>消息队列：</p>
<p>RabbitMQ 最基本的用法是作为消息队列。生产者将消息发送到 RabbitMQ 服务器，消费者从队列中获取消息并进行处理。这种模式可以实现应用程序的解耦和异步通信。</p>
</li>
<li><p>发布/订阅模式：</p>
<p>RabbitMQ 支持发布/订阅模式，允许生产者将消息发布到一个或多个交换机（Exchange），消费者订阅感兴趣的队列。当有新消息到达时，RabbitMQ 会将消息路由到所有订阅了相应队列的消费者。</p>
</li>
<li><p>路由模式：</p>
<p>在路由模式中，生产者将消息发送到交换机，并指定一个路由键（Routing Key）。RabbitMQ 根据路由键将消息路由到绑定了相应路由键的队列。这种模式可以实现更精细的消息路由。</p>
</li>
<li><p>主题模式：</p>
<p>主题模式是路由模式的扩展，允许使用通配符来匹配路由键。例如，可以使用“*”通配符匹配一个单词，使用“#”通配符匹配任意数量的单词。这种模式可以实现更灵活的消息路由。</p>
</li>
<li><p>RPC（远程过程调用）：</p>
<p>RabbitMQ 可以用于实现 RPC 机制，允许客户端调用远程服务器上的方法。客户端将请求消息发送到 RabbitMQ，服务器处理请求并将响应消息发送回客户端。</p>
</li>
</ol>
<h2 id="Work-Queues"><a href="#Work-Queues" class="headerlink" title="Work Queues"></a>Work Queues</h2><p>工作队列(又称任务队列)的主要思想是避免立即执行资源密集型任务，而不得不等待它完成。相反我们安排任务在之后执行。我们把任务封装为消息并将其发送到队列。在后台运行的工作进程将弹出任务并最终执行作业。 当有多个工作线程时，这些工作线程将一起处理这些任务。 </p>
<p>本质上我们刚刚写的HelloWorld程序就是这种模式，只是简化到了最简单的情况：</p>
<ul>
<li>生产者只有一个</li>
<li>发送一个消息</li>
<li>消费者也只有一个，消息也只能被这个消费者消费</li>
</ul>
<p>所以HelloWorld也称为简单模式。</p>
<p>现在我们还原一下常规情况：</p>
<ul>
<li>生产者发送多个消息</li>
<li>由多个消费者来竞争</li>
<li>谁抢到算谁的</li>
</ul>
<p>结论：<br>多个消费者监听同一个队列，则各消费者之间对同一个消息是竞争的关系。<br>Work Queues工作模式适用于任务较重或任务较多的情况，多消费者分摊任务，可以提高消息处理的效率</p>
<h3 id="生产者代码"><a href="#生产者代码" class="headerlink" title="生产者代码"></a>生产者代码</h3><h4 id="封装工具类"><a href="#封装工具类" class="headerlink" title="封装工具类"></a>封装工具类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 12:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionUtil</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST_ADDRESS</span> <span class="operator">=</span> <span class="string">"192.168.10.66"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">5672</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VIRTUAL_HOST</span> <span class="operator">=</span> <span class="string">"/"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">"guest"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">"123456"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取与 RabbitMQ 服务器的连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 与 RabbitMQ 服务器的连接对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 如果在创建连接时发生错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 创建一个新的连接工厂对象</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 设置 RabbitMQ 服务器的主机地址</span></span><br><span class="line">        factory.setHost(HOST_ADDRESS);</span><br><span class="line">        <span class="comment">// 设置 RabbitMQ 服务器的端口号</span></span><br><span class="line">        factory.setPort(PORT);</span><br><span class="line">        <span class="comment">// 设置 RabbitMQ 服务器的虚拟主机</span></span><br><span class="line">        factory.setVirtualHost(VIRTUAL_HOST);</span><br><span class="line">        <span class="comment">// 设置连接 RabbitMQ 服务器的用户名</span></span><br><span class="line">        factory.setUsername(USERNAME);</span><br><span class="line">        <span class="comment">// 设置连接 RabbitMQ 服务器的密码</span></span><br><span class="line">        factory.setPassword(PASSWORD);</span><br><span class="line">        <span class="comment">// 返回新创建的连接对象</span></span><br><span class="line">        <span class="keyword">return</span> factory.newConnection();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection();</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="literal">null</span>) {</span><br><span class="line">            System.out.println(<span class="string">"连接成功!!"</span>);</span><br><span class="line">            System.out.println(<span class="string">"connection = "</span> + connection + <span class="string">""</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.println(<span class="string">"连接失败!!"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.work;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 12:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"work_queue"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> i + <span class="string">"hello rabbitmq"</span>;</span><br><span class="line">            channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="发送消息效果"><a href="#发送消息效果" class="headerlink" title="发送消息效果"></a>发送消息效果</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708ad5f0d0d5.png" alt="image-20241011124518118"></p>
<h3 id="消费者代码"><a href="#消费者代码" class="headerlink" title="消费者代码"></a>消费者代码</h3><h4 id="编写代码-1"><a href="#编写代码-1" class="headerlink" title="编写代码"></a>编写代码</h4><p>Consumer1：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.work;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 12:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"work_queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer1 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Consumer2：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.work;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 12:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"work_queue"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer2 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h4><p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708afb32f01c.png" alt="image-20241011125514415"></p>
<p>Consumer2:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708afdb74210.png" alt="image-20241011125554724"></p>
<h2 id="发布订阅模式（Publish-Subscribe）"><a href="#发布订阅模式（Publish-Subscribe）" class="headerlink" title="发布订阅模式（Publish/Subscribe）"></a>发布订阅模式（Publish/Subscribe）</h2><p>Publish/Subscribe模式需要引入新角色：交换机</p>
<ul>
<li>生产者不是把消息直接发送到队列，而是发送到交换机</li>
<li>交换机接收消息，而如何处理消息取决于交换机的类型</li>
<li>交换机有如下3种常见类型<ul>
<li>Fanout: 广播，将消息发送给所有绑定到交换机的队列</li>
<li>Direct: 定向，把消息交给符合指定routing key的队列</li>
<li>Topic: 通配符，把消息交给符合routing pattern(路由模式)的队列</li>
</ul>
</li>
</ul>
<p>注意：Exchange(交换机)<strong>只负责转发</strong>消息，<strong>不具备存储</strong>消息的能力，因此如果没有任何队列与Exchange绑定，或者没有符合路由规侧的队列，那么消息会丢失！</p>
<p>组件之间关系：</p>
<ul>
<li>生产者把消息发送到交换机</li>
<li>队列直接和交换机绑定</li>
</ul>
<p>工作机制：消息发送到交换机上，就会以<strong>广播</strong>的形式发送给所有已绑定队列</p>
<p>理解概念：</p>
<ul>
<li>Publish:发布，这里就是把消息发送到交换机上</li>
<li>Subscribe:订阅，这里只要把队列和交换机绑定，事实上就形成了一种订阅关系</li>
</ul>
<h3 id="生产者代码-1"><a href="#生产者代码-1" class="headerlink" title="生产者代码"></a>生产者代码</h3><h4 id="编写代码-2"><a href="#编写代码-2" class="headerlink" title="编写代码"></a>编写代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.fanout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 13:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">"fanout_exchange"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 1、获取连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、获取通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、声明交换机</span></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// type 交换机类型</span></span><br><span class="line">        <span class="comment">// durable 是否持久化</span></span><br><span class="line">        <span class="comment">// autoDelete 是否自动删除</span></span><br><span class="line">        <span class="comment">// arguments 其他参数</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、创建队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">"fanout_queue1"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">"fanout_queue2"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5、绑定队列到交换机</span></span><br><span class="line">        <span class="comment">// queue 队列名称</span></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// routingKey 路由键, 用于指定消息的路由规则</span></span><br><span class="line">        channel.queueBind(<span class="string">"fanout_queue1"</span>, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">        channel.queueBind(<span class="string">"fanout_queue2"</span>, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、发送消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"日志信息: 张三调用了findAll方法 "</span>;</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, <span class="string">""</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7、释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4 id="执行效果"><a href="#执行效果" class="headerlink" title="执行效果"></a>执行效果</h4><p>可以通过后台查看我们刚创建的交换机</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708b62baa05d.png" alt="image-20241011132250767"></p>
<p>点击 <code>Name</code> 栏的交换机名称跳转到详情页，展开<code>Bindings</code>查看该交换机绑定的消息队列</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708b6a8161c8.png" alt="image-20241011132455222"></p>
<p>可以看到新增两个消息队列并分别发送了一条消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708b72c07708.png" alt="image-20241011132707238"></p>
<p>点击<code>Name</code>栏的消息队列名称可查看详情</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708b7c48f285.png" alt="image-20241011132939726"></p>
<p>通过<code>Get Messages(s)</code>按钮可以查看消息详情</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708b8224c1e8.png" alt="image-20241011133113587"></p>
<h3 id="消费者代码-1"><a href="#消费者代码-1" class="headerlink" title="消费者代码"></a>消费者代码</h3><h4 id="编写代码-3"><a href="#编写代码-3" class="headerlink" title="编写代码"></a>编写代码</h4><p><strong>Consumer1：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.fanout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 13:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"fanout_queue1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer1 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                System.out.println(<span class="string">"队列1 消费者1 日志打印..."</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Consumer2：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.fanout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 13:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"fanout_queue2"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer2 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                System.out.println(<span class="string">"队列2 消费者2 日志打印..."</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="执行效果-1"><a href="#执行效果-1" class="headerlink" title="执行效果"></a>执行效果</h4><blockquote>
<p>示例代码两个Consumer分别绑定不同的消息队列，为非竞争关系，若绑定相同的消息队列则为竞争关系</p>
</blockquote>
<p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708ba78076b5.png" alt="image-20241011134111290"></p>
<p>Consumer2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708ba940f5bd.png" alt="image-20241011134139332"></p>
<h2 id="路由模式（Routing）"><a href="#路由模式（Routing）" class="headerlink" title="路由模式（Routing）"></a>路由模式（Routing）</h2><ul>
<li>通过 **路由绑定 **的方式，把交换机和队列关联起来</li>
<li>交换机和队列通过路由键进行绑定</li>
<li>生产者发送消息时不仅要指定交换机，还要指定路由键</li>
<li>交换机接收到消息会发送到路由键绑定的队列</li>
<li>在编码上与Publish/Subscribe发布与订阅模式的区别：<ul>
<li>交换机的类型为：Direct</li>
<li>队列绑定交换机的时候需要指定routing key。</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708bc347bd0f.png" alt="image-20241011134835789"></p>
<h3 id="生产者代码-2"><a href="#生产者代码-2" class="headerlink" title="生产者代码"></a>生产者代码</h3><h4 id="编写代码-4"><a href="#编写代码-4" class="headerlink" title="编写代码"></a>编写代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.routing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 13:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">"test_direct"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 1、获取连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、获取通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、声明交换机</span></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// type 交换机类型</span></span><br><span class="line">        <span class="comment">// durable 是否持久化</span></span><br><span class="line">        <span class="comment">// autoDelete 是否自动删除</span></span><br><span class="line">        <span class="comment">// arguments 其他参数</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"direct_queue1"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"direct_queue2"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、创建队列</span></span><br><span class="line">        channel.queueDeclare(queue1Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue2Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5、绑定队列到交换机</span></span><br><span class="line">        <span class="comment">// queue 队列名称</span></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// routingKey 路由键, 用于指定消息的路由规则</span></span><br><span class="line">        <span class="comment">// 队列1 绑定 error 路由键</span></span><br><span class="line">        channel.queueBind(queue1Name, EXCHANGE_NAME, <span class="string">"error"</span>);</span><br><span class="line">        <span class="comment">// 队列2 绑定info、error、warning 路由键</span></span><br><span class="line">        channel.queueBind(queue2Name, EXCHANGE_NAME, <span class="string">"info"</span>);</span><br><span class="line">        channel.queueBind(queue2Name, EXCHANGE_NAME, <span class="string">"error"</span>);</span><br><span class="line">        channel.queueBind(queue2Name, EXCHANGE_NAME, <span class="string">"warning"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、发送消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"日志信息: 张三调用了delete方法. 执行出错,日志级别warning"</span>;</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, <span class="string">"warning"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7、释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="运行效果-1"><a href="#运行效果-1" class="headerlink" title="运行效果"></a>运行效果</h4><p>新创建的交换机如图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c046f1a9e.png" alt="image-20241011140558047"></p>
<p>详情如图所示，可以看到绑定了两个消息队列<code>direct_queue1</code> 和<code>direct_queue2</code>，<code>direct_queue1</code>关联<code>error</code>一个路由键，<code>direct_queue2</code>关联了<code>error</code>、<code>info</code>、<code>warning</code>三个路由键</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c07e170b5.png" alt="image-20241011140653263"></p>
<h3 id="消费者代码-2"><a href="#消费者代码-2" class="headerlink" title="消费者代码"></a>消费者代码</h3><h4 id="编写代码-5"><a href="#编写代码-5" class="headerlink" title="编写代码"></a>编写代码</h4><p><strong>Consumer1：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.routing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 13:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"direct_queue1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer1 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                System.out.println(<span class="string">"队列1 消费者1 日志打印..."</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Consumer2：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.routing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 13:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"direct_queue2"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer2 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                System.out.println(<span class="string">"队列2 消费者2 日志打印..."</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="执行效果-2"><a href="#执行效果-2" class="headerlink" title="执行效果"></a>执行效果</h4><p>由于我们只往<code>warning</code>路由键发送消息，而 <code>direct_queue1</code>关联<code>error</code>一个路由键，<code>direct_queue2</code>关联了<code>error</code>、<code>info</code>、<code>warning</code>三个路由键，所以<code>Consumer1</code>收不到消息， <code>Consumer2</code>可以收到消息</p>
<p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c2f953c68.png" alt="image-20241011141728610"></p>
<p>Consumer2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c31643ee0.png" alt="image-20241011141757516"></p>
<p>我们可以修改为往<code>error</code>路由键发送消息，这样两个消费者就都能接收到消息了</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"日志信息: 张三调用了delete方法. 执行出错,日志级别error"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"error"</span>, <span class="literal">null</span>, body.getBytes());</span><br></pre></td></tr></tbody></table></figure>

<p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c451a5e53.png" alt="image-20241011142312968"></p>
<p>Consumer2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c46f0b97a.png" alt="image-20241011142342393"></p>
<h2 id="主题模式（Topics）"><a href="#主题模式（Topics）" class="headerlink" title="主题模式（Topics）"></a>主题模式（Topics）</h2><ul>
<li>Topic类型与Direct相比，都是可以根据RoutingKey把消息路由到不同的队列。只不过Topic类型Exchange可以让队列在绑定Routing key的时候使用通配符</li>
<li>Routingkey一般都是由一个或多个单词组成，多个单词之间以”<code>.</code>“分割，例如：<code>item.insert</code></li>
<li>通配符规则：<ul>
<li>#: 匹配零个或多个词</li>
<li>*: 匹配一个词、</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708c5bc94a7b.png" alt="image-20241011142915903"></p>
<p>假设有一个主题交换机 <code>logs</code>，并且有以下队列和绑定：</p>
<ul>
<li>队列 <code>critical_errors</code> 绑定键为 <code>*.error</code></li>
<li>队列 <code>user_logs</code> 绑定键为 <code>user.*</code></li>
<li>队列 <code>all_logs</code> 绑定键为 <code>#</code></li>
</ul>
<p>如果生产者发送一条路由键为 <code>user.info</code> 的消息，那么这条消息将被路由到 <code>user_logs</code> 和 <code>all_logs</code> 队列。</p>
<p>如果生产者发送一条路由键为 <code>system.error</code> 的消息，那么这条消息将被路由到 <code>critical_errors</code> 和 <code>all_logs</code> 队列。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708d1e8e698f.png" alt="image-20241011152112193"></p>
<h3 id="生产者代码-3"><a href="#生产者代码-3" class="headerlink" title="生产者代码"></a>生产者代码</h3><h4 id="编写代码-6"><a href="#编写代码-6" class="headerlink" title="编写代码"></a>编写代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 14:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">"test_topic"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 1、获取连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、获取通道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、声明交换机</span></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// type 交换机类型</span></span><br><span class="line">        <span class="comment">// durable 是否持久化</span></span><br><span class="line">        <span class="comment">// autoDelete 是否自动删除</span></span><br><span class="line">        <span class="comment">// arguments 其他参数</span></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"topic_queue1"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"topic_queue2"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、创建队列</span></span><br><span class="line">        channel.queueDeclare(queue1Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue2Name, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5、绑定队列到交换机</span></span><br><span class="line">        <span class="comment">// queue 队列名称</span></span><br><span class="line">        <span class="comment">// exchange 交换机名称</span></span><br><span class="line">        <span class="comment">// routingKey 路由键, 用于指定消息的路由规则</span></span><br><span class="line">        <span class="comment">// routingKey常用格式: 系统名称.日志级别</span></span><br><span class="line">        <span class="comment">// 需求: 所有error级别日志存入数据库,所有order系统的日志存入数据库</span></span><br><span class="line">        channel.queueBind(queue1Name, EXCHANGE_NAME, <span class="string">"#.error"</span>);</span><br><span class="line">        channel.queueBind(queue1Name, EXCHANGE_NAME, <span class="string">"order.*"</span>);</span><br><span class="line">        channel.queueBind(queue2Name, EXCHANGE_NAME, <span class="string">"*.*"</span>);</span><br><span class="line"><span class="comment">//        channel.queueBind(queue2Name, EXCHANGE_NAME, "#");</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、发送消息</span></span><br><span class="line">        <span class="comment">// 分别发送消息到队列: order.info、goods.info、goods.error</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"[所在系统：order][日志级别：info][日志内容: 订单生成,保存成功]"</span>;</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, <span class="string">"order.info"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">        System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"></span><br><span class="line"><span class="comment">//        body = "[所在系统：goods][日志级别：info][日志内容: 商品发布成功]";</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(EXCHANGE_NAME, "goods.info", null, body.getBytes());</span></span><br><span class="line"><span class="comment">//        System.out.println("body发送成功: " + body );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        body = "[所在系统：goods][日志级别：error][日志内容: 商品发布失败]";</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(EXCHANGE_NAME, "goods.error", null, body.getBytes());</span></span><br><span class="line"><span class="comment">//        System.out.println("body发送成功: " + body );</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7、释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4 id="执行效果-3"><a href="#执行效果-3" class="headerlink" title="执行效果"></a>执行效果</h4><p>创建的交换机信息如图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708cb287c4af.png" alt="image-20241011145223731"></p>
<p>创建的消息队列如图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708caf44daca.png" alt="image-20241011145131503"></p>
<h3 id="消费者代码-3"><a href="#消费者代码-3" class="headerlink" title="消费者代码"></a>消费者代码</h3><h4 id="编写代码-7"><a href="#编写代码-7" class="headerlink" title="编写代码"></a>编写代码</h4><p><strong>Consumer1：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 14:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"topic_queue1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer1 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                System.out.println(<span class="string">"队列1 消费者1 日志打印..."</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>Consumer2：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.shiguang.rabbitmq.util.ConnectionUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 14:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"topic_queue2"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();</span><br><span class="line"></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag,</span></span><br><span class="line"><span class="params">                                       Envelope envelope,</span></span><br><span class="line"><span class="params">                                       AMQP.BasicProperties properties,</span></span><br><span class="line"><span class="params">                                       <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                System.out.println(<span class="string">"Consumer2 Body: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                System.out.println(<span class="string">"队列2 消费者2 日志打印..."</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, consumer);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4 id="执行效果-4"><a href="#执行效果-4" class="headerlink" title="执行效果"></a>执行效果</h4><p><code>topic_queue1</code>匹配规则满足：所有error级别日志存入数据库,所有order系统的日志存入数据库</p>
<p><code>topic_queue2</code>则匹配所有消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">channel.queueBind(queue1Name, EXCHANGE_NAME, <span class="string">"#.error"</span>);</span><br><span class="line">channel.queueBind(queue1Name, EXCHANGE_NAME, <span class="string">"order.*"</span>);</span><br><span class="line">channel.queueBind(queue2Name, EXCHANGE_NAME, <span class="string">"*.*"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>我们先发送<code>order.info</code>规则的消息，执行并查看效果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6、发送消息</span></span><br><span class="line"><span class="comment">// 分别发送消息到队列: order.info、goods.info、goods.error</span></span><br><span class="line"><span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"[所在系统：order][日志级别：info][日志内容: 订单生成,保存成功]"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"order.info"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"></span><br><span class="line"><span class="comment">//        body = "[所在系统：goods][日志级别：info][日志内容: 商品发布成功]";</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(EXCHANGE_NAME, "goods.info", null, body.getBytes());</span></span><br><span class="line"><span class="comment">//        System.out.println("body发送成功: " + body );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        body = "[所在系统：goods][日志级别：error][日志内容: 商品发布失败]";</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(EXCHANGE_NAME, "goods.error", null, body.getBytes());</span></span><br><span class="line"><span class="comment">//        System.out.println("body发送成功: " + body );</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于<code>topic_queue1</code>与<code>topic_queue2</code>均能匹配<code>order.info</code>规则，所以<code>Consumer1</code>与<code>Consumer2</code>均能接收到消息。</p>
<p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708cbc7c3e9b.png" alt="image-20241011145503121"></p>
<p>Consumer2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708cbe52a6da.png" alt="image-20241011145532452"></p>
<p>我们再发送<code>goods.info</code>这个规则的消息，清空Consumer日志，重新发送消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6、发送消息</span></span><br><span class="line"><span class="comment">// 分别发送消息到队列: order.info、goods.info、goods.error</span></span><br><span class="line"><span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"[所在系统：order][日志级别：info][日志内容: 订单生成,保存成功]"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"order.info"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"></span><br><span class="line">body = <span class="string">"[所在系统：goods][日志级别：info][日志内容: 商品发布成功]"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"goods.info"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        body = "[所在系统：goods][日志级别：error][日志内容: 商品发布失败]";</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(EXCHANGE_NAME, "goods.error", null, body.getBytes());</span></span><br><span class="line"><span class="comment">//        System.out.println("body发送成功: " + body );</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于<code>topic_queue1</code>不能匹配<code>goods.info</code>规则，所以<code>Consumer1</code>只接收到一条消息，<code>Consumer2</code>接收到两条消息。</p>
<p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708ce87df55f.png" alt="image-20241011150647279"></p>
<p>Consumer2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708ceb642782.png" alt="image-20241011150733592"></p>
<p>我们继续追加<code>goods.error</code>这个规则的消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6、发送消息</span></span><br><span class="line"><span class="comment">// 分别发送消息到队列: order.info、goods.info、goods.error</span></span><br><span class="line"><span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"[所在系统：order][日志级别：info][日志内容: 订单生成,保存成功]"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"order.info"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"></span><br><span class="line">body = <span class="string">"[所在系统：goods][日志级别：info][日志内容: 商品发布成功]"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"goods.info"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br><span class="line"></span><br><span class="line">body = <span class="string">"[所在系统：goods][日志级别：error][日志内容: 商品发布失败]"</span>;</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, <span class="string">"goods.error"</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">System.out.println(<span class="string">"body发送成功: "</span> + body );</span><br></pre></td></tr></tbody></table></figure>

<p>同理可知<code>Consumer1</code>只接收到两条消息，<code>Consumer2</code>接收到三条消息。</p>
<p>Consumer1：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708d0ce0861b.png" alt="image-20241011151629375"></p>
<p>Consumer2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708d0dbd51f1.png" alt="image-20241011151643198"></p>
<h2 id="远程过程调用（RPC）"><a href="#远程过程调用（RPC）" class="headerlink" title="远程过程调用（RPC）"></a>远程过程调用（RPC）</h2><ul>
<li>远程过程调用，本质上是同步调用，和我们使用OpenFeign调用远程接口一样</li>
<li>所以这不是典型的消息队列工作方式，我们不展开说明</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708d2565e857.png" alt="image-20241011152301703"></p>
<h2 id="工作模式小结"><a href="#工作模式小结" class="headerlink" title="工作模式小结"></a>工作模式小结</h2><p>直接发送到队列：底层使用了默认交换机</p>
<p>经过交换机发送到队列</p>
<ul>
<li>Fanout: 没有Routing key直接绑定队列</li>
<li>Direct: 通过Routing key绑定队列，消息发送到绑定的队列上<ul>
<li>一个交换机绑定一个队列：定点发送</li>
<li>一个交换机绑定多个队列：广播发送</li>
</ul>
</li>
<li>Topic: 针对Routing key使用通配符</li>
</ul>
<h1 id="Spring-Boot-整合RabbitMQ"><a href="#Spring-Boot-整合RabbitMQ" class="headerlink" title="Spring Boot 整合RabbitMQ"></a>Spring Boot 整合RabbitMQ</h1><h2 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h2><ul>
<li>搭建环境</li>
<li>基础设定：交换机名称、队列名称、绑定关系</li>
<li>发送消息：使用<code>RabbitTemplate</code></li>
<li>接收消息：使用<code>@RabbitListener</code>注解</li>
</ul>
<h2 id="消费者操作步骤"><a href="#消费者操作步骤" class="headerlink" title="消费者操作步骤"></a>消费者操作步骤</h2><h3 id="创建项目并导入依赖"><a href="#创建项目并导入依赖" class="headerlink" title="创建项目并导入依赖"></a>创建项目并导入依赖</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.shiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>module03-springboot-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- springboot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.shiguang.mq.listener.MyMessageListener:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建启动类"><a href="#创建启动类" class="headerlink" title="创建启动类"></a>创建启动类</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConsumerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQConsumerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="MyMessageListener"><a href="#MyMessageListener" class="headerlink" title="MyMessageListener"></a>MyMessageListener</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"queue.order"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写法一: 监听 + 在 RabbitMQ 服务器上创建交换机、队列、绑定关系</span></span><br><span class="line"><span class="comment">//    @RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="comment">//            value = @Queue(value = QUEUE_NAME, durable = "true"),</span></span><br><span class="line"><span class="comment">//            exchange = @Exchange(value = EXCHANGE_DIRECT),</span></span><br><span class="line"><span class="comment">//            key = {ROUTING_KEY}</span></span><br><span class="line"><span class="comment">//    ))</span></span><br><span class="line"><span class="comment">//    public void processMessage(String dataString, Message message, Channel channel) {</span></span><br><span class="line"><span class="comment">//        log.info("消费端接收到消息：{}", dataString);</span></span><br><span class="line"><span class="comment">//        System.out.println("消费端接收到消息：" + dataString);</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写法二: 只监听</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> {</span><br><span class="line">        log.info(<span class="string">"消费端接收到消息：{}"</span>, dataString);</span><br><span class="line">        System.out.println(<span class="string">"消费端接收到消息："</span> + dataString);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>启动服务，登录RabbitMQ管理界面查看交换机，消息队列是否创建成功并建立绑定关系</p>
<p><strong>交换机：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e2d4c1531.png" alt="image-20241011163324060"></p>
<p><strong>消息队列：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e2fad2e01.png" alt="image-20241011163402237"></p>
<p><strong>绑定关系：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e326ea4f9.png" alt="image-20241011163446266"></p>
<h3 id="图形化界面操作"><a href="#图形化界面操作" class="headerlink" title="图形化界面操作"></a>图形化界面操作</h3><p><strong>创建交换机：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e3deac9fd.png" alt="image-20241011163749986"></p>
<p><strong>创建消息队列：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e42df31c6.png" alt="image-20241011163909201"></p>
<p><strong>建立绑定关系：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e49205b0a.png" alt="image-20241011164049337"></p>
<p>添加后如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6708e4a7aeefd.png" alt="image-20241011164111141"></p>
<h2 id="生产者操作步骤"><a href="#生产者操作步骤" class="headerlink" title="生产者操作步骤"></a>生产者操作步骤</h2><h3 id="创建项目并导入依赖-1"><a href="#创建项目并导入依赖-1" class="headerlink" title="创建项目并导入依赖"></a>创建项目并导入依赖</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.shiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>modul04-springboot-producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建配置文件-1"><a href="#创建配置文件-1" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>

<p>创建启动类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>创建测试类</p>
<blockquote>
<p>注意测试类包路径应与项目启动类所属包路径一致，否则@Autowired无法自动装配</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"queue.order"</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01SendMessage</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Hello Rabbit!!"</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT,ROUTING_KEY,message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>执行测试代码，查看后台监控，有一条消息待消费</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670907b38d80e.png" alt="image-20241011191042896"></p>
<p>启动消费者服务进行消费</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709080a8d4ab.png" alt="image-20241011191209907"></p>
<h1 id="消息可靠性投递"><a href="#消息可靠性投递" class="headerlink" title="消息可靠性投递"></a>消息可靠性投递</h1><h2 id="问题场景及解决方案"><a href="#问题场景及解决方案" class="headerlink" title="问题场景及解决方案"></a>问题场景及解决方案</h2><h3 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h3><p>下单操作的正常流程如下图所示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709094f6ed58.png" alt="image-20241011191734902"></p>
<p>故障情况1：消息没有发送到消息队列上<br>后果：消费者拿不到消息，业务功能缺失，数据错误</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709099187a59.png" alt="image-20241011191841070"></p>
<p>故障情况2：消息成功存入消息队列，但是消息队列服务器宕机了<br>原本保存在**<font color="red">内存中的消息</font><strong>也</strong><font color="red">丢失</font>**了<br>即使服务器重新启动，消息也找不回来了<br>后果：消费者拿不到消息，业务功能缺失，数据错误</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670909c226d6e.png" alt="image-20241011191929644"></p>
<p>故障情况3：消息成功存入消息队列，但是消费端出现问题，例如：宕机、抛异常等等</p>
<p>后果：业务功能缺失，数据错误</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67090a7d3dbb9.png" alt="image-20241011192236717"></p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>故障情况1：消息没有发送到消息队列</p>
<ul>
<li>解决思路A：在<strong>生产者端</strong>进行确认，具体操作中我们会分别针对<strong>交换机</strong>和<strong>队列</strong>来确认<br>如果没有成功发送到消息队列服务器上，那就可以尝试重新发送</li>
<li>解决思路B：为目标交换机指定<strong>备份交换机</strong>，当目标交换机投递失败时，把消息投递至<br>备份交换机</li>
</ul>
<p>故障情况2：消息队列服务器宕机导致内存中消息丢失</p>
<ul>
<li>解决思路：<strong>消息持久化</strong>到硬盘上，哪怕服务器重启也不会导致消息丢失</li>
</ul>
<p>故障情况3：消费端宕机或抛异常导致消息没有成功被消费</p>
<ul>
<li>消费端消费消息<strong>成功</strong>，给服务器返回<strong>ACK信息</strong>，然后消息队列删除该消息</li>
<li>消费端消费消息<strong>失败</strong>，给服务器端返回<strong>NACK信息</strong>，同时把消息恢复为<strong>待消费</strong>的状态，<br>这样就可以再次取回消息，<strong>重试</strong>一次（当然，这就需要消费端接口支持幂等性）</li>
</ul>
<h2 id="故障情况1"><a href="#故障情况1" class="headerlink" title="故障情况1"></a>故障情况1</h2><h3 id="生产者端实现"><a href="#生产者端实现" class="headerlink" title="生产者端实现"></a>生产者端实现</h3><h4 id="创建项目并导入依赖-2"><a href="#创建项目并导入依赖-2" class="headerlink" title="创建项目并导入依赖"></a>创建项目并导入依赖</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.shiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>module05-confirm-producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="主启动类"><a href="#主启动类" class="headerlink" title="主启动类"></a>主启动类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><blockquote>
<p>注意：publisher-confirm-type和publisher-returns是两个必须要增加的配置，如果没有则本节功能不生效</p>
</blockquote>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span> <span class="comment">#交换机的确认</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment">#队列的确认</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.shiguang.mq.config.MQProducerAckConfig:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h4><p><strong>目标</strong>：首先我们需要声明回调函数来接收RabbitMQ服务器返回的确认信息：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>方法功能</th>
<th>所属接口</th>
<th>接口所属类</th>
</tr>
</thead>
<tbody><tr>
<td>confirm()</td>
<td>确认消息是否发送到交换机</td>
<td>ConfirmCallback</td>
<td>RabbitTemplate</td>
</tr>
<tr>
<td>returnedMessage()</td>
<td>确认消息是否发送到队列</td>
<td>ReturnsCallback</td>
<td>RabbitTemplate</td>
</tr>
</tbody></table>
<p>然后，就是对RabbitTemplate的功能进行增强，因为回调函数所在对象必须设置到RabbitTemplate对象中才能生效<br>原本RabbitTemplate对象并没有生产者端消息确认的功能，要给它设置对应的组件才可以。<br>而设置对应的组件，需要调用RabbitTemplate对象下面两个方法：</p>
<table>
<thead>
<tr>
<th>设置组件调用的方法</th>
<th>所需对象类型</th>
</tr>
</thead>
<tbody><tr>
<td>setConfirmCallback()</td>
<td>ConfirmCallback接口类型</td>
</tr>
<tr>
<td>setReturnCallback()</td>
<td>ReturnCallback:接口类型</td>
</tr>
</tbody></table>
<p>代码如下：</p>
<blockquote>
<p>① 要点1<br>加@Component注解，加入IOC容器（@Configuration已经包含了@Component）<br>② 要点2<br>配置类自身实现ConfirmCallback、ReturnCallbacki这两个接口，然后通过this指针把配置类的对象设置到RabbitTemplate对象中。<br>操作封装到了一个专门的void init()方法中。<br>为了保证这个void init()方法在应用启动时被调用，我们使用@PostConstruct注解来修饰这个方法。<br>关于@PostConstruct注解大家可以参照以下说明：</p>
<p>@PostConstruct注解是<strong>java中的一个标准注解</strong>，它用于指定在<strong>对象创建之后立即执行</strong>的方法。当使用依赖注入（如Spring框架）或者其他方式创建对象时，@PostConstruct注解可以确保在对象完全初始化之后，执行相应的方法。</p>
<p>使用@PostConstructi注解的方法必须满足以下条件：</p>
<ol>
<li>方法不能有任何参数</li>
<li>方法必须是非静态的</li>
<li>方法不能返回任何值。</li>
</ol>
<p>当容器实例化一个带有@PostConstruct注解的Bean时，它会在<strong>调用构造函数之后</strong>，并在<strong>依赖注入完成之前</strong>调用被@PostConstruct注解标记的方法。这样，我们可以在该方法中进行一些初始化操作，比如读取配置文件、建立数据库连接等。</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 19:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnsCallback {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRabbitTemplate</span><span class="params">()</span>{</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息发送到交换机成功或失败时调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData 用于关联消息的唯一标识符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack             表示消息是否被成功确认</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause           如果消息确认失败，这里会包含失败的原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> {</span><br><span class="line">        log.info(<span class="string">"confirm() 回调函数打印 CorrelationData: "</span> + correlationData);</span><br><span class="line">        log.info(<span class="string">"confirm() 回调函数打印 ack: "</span> + ack);</span><br><span class="line">        log.info(<span class="string">"confirm() 回调函数打印 cause: "</span> + cause);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当消息无法路由到队列时调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> returnedMessage 包含无法路由的消息的详细信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span> {</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 消息主体: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(returnedMessage.getMessage().getBody()));</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 应答码: "</span> + returnedMessage.getReplyCode());</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 描述: "</span> + returnedMessage.getReplyText());</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 消息使用的交换器 exchange: "</span> + returnedMessage.getExchange());</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 消息使用的路由键 routing: "</span> + returnedMessage.getRoutingKey());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 20:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01SendMessage</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Message Confirm Test !!"</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT,ROUTING_KEY,message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p>正常执行测试代码，查看日志输出，ack为<code>true</code>，cause为<code>null</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67091852e853f.png" alt="image-20241011202138328"></p>
<p>调整交换机名称，故意使其发送失败</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01SendMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Message Confirm Test !!"</span>;</span><br><span class="line">    <span class="comment">//        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT,ROUTING_KEY,message);</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_DIRECT + <span class="string">"~"</span>, ROUTING_KEY, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>重新执行并查看日志输出，ack为<code>false</code>，cause有相应错误原因</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709199aa83f7.png" alt="image-20241011202706175"></p>
<p>调整路由键名称，故意使其无法匹配</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01SendMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Message Confirm Test !!"</span>;</span><br><span class="line">    <span class="comment">//        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT,ROUTING_KEY,message);</span></span><br><span class="line">    <span class="comment">//        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT + "~", ROUTING_KEY, message);</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_DIRECT, ROUTING_KEY + <span class="string">"~"</span>, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>重新执行并查看日志输出，打印了<code>returnedMessage()</code>回到函数日志</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67091aacbb997.png" alt="image-20241011203140202"></p>
<h3 id="备份交换机实现"><a href="#备份交换机实现" class="headerlink" title="备份交换机实现"></a>备份交换机实现</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67091bc963bbf.png" alt="image-20241011203624907"></p>
<p><strong>1、创建备份交换机</strong></p>
<p>类型必须为<code>fanout</code>，因为消息从目标交换机转至备份交换机时是没有路由键的，只能通过广播的方式查找队列。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709215299a4b.png" alt="image-20241011210002157"></p>
<p><strong>2、创建队列</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709221e137cb.png" alt="image-20241011210325574"></p>
<p><strong>3、交换机绑定队列</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67092270c6687.png" alt="image-20241011210448331"></p>
<p><strong>4、执行目标交换机的备份交换机</strong></p>
<p>由于交换机创建后参数无法修改，所以需要将原来的目标删除重新创建并执行备份交换机</p>
<p>删除原来的目标交换机：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/6709237572ecc.png" alt="image-20241011210908870"></p>
<p>重新创建目标交换机：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670924133a9ef.png" alt="image-20241011211146489"></p>
<p>队列重新绑定交换机：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67092523b71bb.png" alt="image-20241011211619274"></p>
<p><strong>5、重新执行测试</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01SendMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Message Confirm Test !!"</span>;</span><br><span class="line">    <span class="comment">//        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT,ROUTING_KEY,message);</span></span><br><span class="line">    <span class="comment">//        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT + "~", ROUTING_KEY, message);</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_DIRECT, ROUTING_KEY + <span class="string">"~"</span>, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>测试结果：ack为<code>true</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670925d05eceb.png" alt="image-20241011211911885"></p>
<p><code>queue.test.backup</code>有一条消息待消费<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67092620e9231.png" alt="image-20241011212032489"></p>
<h2 id="故障情况2"><a href="#故障情况2" class="headerlink" title="故障情况2"></a>故障情况2</h2><p>默认情况下，RabbitMQ服务宕机后，消息会丢失吗?</p>
<p>我们手动重启下RabbitMQ服务，然后查看消息消费情况</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart rabbitmq</span><br></pre></td></tr></tbody></table></figure>

<p>原来有一条消息待消费</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670927e8711d7.png" alt="image-20241011212807995"></p>
<p>重启后重新查看，发现带消费消息从0条转变为1条，我们并未重新发送消息，但消息并未丢失</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/670928d33cb1e.png" alt="image-20241011213202836"></p>
<p>其实默认情况下，RabbitMQ是支持持久化数据的，重启后会将保存到磁盘的数据重新加载到内存中</p>
<p>我们可以查看下<code>@RabbitListener</code> 注解的源码，找到<code>Queue</code>这个接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Queue[] queuesToDeclare() <span class="keyword">default</span> {};</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，<code>durable()</code>和 <code>autoDelete()</code>虽然默认值都为空，但源码注释中有说明，默认是支持持久化但是并不会自动删除的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Specifies if this queue should be durable.</span></span><br><span class="line"><span class="comment">	 * By default if queue name is provided it is durable.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> true if the queue is to be declared as durable.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.amqp.core.Queue#isDurable()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">String <span class="title function_">durable</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Specifies if this queue should be auto deleted when not used.</span></span><br><span class="line"><span class="comment">	 * By default if queue name is provided it is not auto-deleted.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> true if the queue is to be declared as auto-delete.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> org.springframework.amqp.core.Queue#isAutoDelete()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">String <span class="title function_">autoDelete</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">""</span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="故障情况3"><a href="#故障情况3" class="headerlink" title="故障情况3"></a>故障情况3</h2><h3 id="消费者端实现"><a href="#消费者端实现" class="headerlink" title="消费者端实现"></a>消费者端实现</h3><h4 id="创建项目并导入依赖-3"><a href="#创建项目并导入依赖-3" class="headerlink" title="创建项目并导入依赖"></a>创建项目并导入依赖</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.shiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>module06-confirm-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- springboot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="主启动类-1"><a href="#主启动类-1" class="headerlink" title="主启动类"></a>主启动类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConsumerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQConsumerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span> <span class="comment"># 把消息确认模式改为手动确认</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.shiguang.mq.listener.MyMessageListener:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h4><blockquote>
<p>channel.basicNack与channel.basicReject的区别</p>
<p>channel.basicReject(long deliveryTag, boolean requeue)</p>
<p>channel.basicReject比channel.basicNack少了个是否批量操作的参数<code>multiple</code>，不能控制是否批量操作</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"queue.order"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = QUEUE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="comment">// 获取当前消息的唯一标识</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 核心操作</span></span><br><span class="line">            log.info(<span class="string">"消费端接收到消息：{}"</span>, dataString);</span><br><span class="line">            <span class="comment">// 核心操作成功,返回 ACK 信息</span></span><br><span class="line">            <span class="comment">// deliveryTag: 消息的唯一标识,64 位的长整型,消息往消费端投递时,会分配一个唯一的 deliveryTag 值</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">false</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="comment">// 获取当前消息是否是重复投递的,true 说明当前消息已经重试过一次了, false 说明当前消息是第一次投递</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">redelivered</span> <span class="operator">=</span> message.getMessageProperties().getRedelivered();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 核心操作失败,返回 NACK 信息</span></span><br><span class="line">            <span class="comment">// requeue: 是否重新入队,true 表示重新入队, false 表示丢弃</span></span><br><span class="line">            <span class="keyword">if</span> (redelivered){</span><br><span class="line">                <span class="comment">// 如果当前消息已经是重复投递的,则说明此前已经重试过一次了,则不再重试过了,直接丢弃</span></span><br><span class="line">                channel.basicNack(deliveryTag, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            }<span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 如果当前消息不是重复投递的,则说明此前没有重试过一次,则重试过一次,重新入队</span></span><br><span class="line">                channel.basicNack(deliveryTag, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="消息确认相关方法参数说明"><a href="#消息确认相关方法参数说明" class="headerlink" title="消息确认相关方法参数说明"></a>消息确认相关方法参数说明</h4><p><strong>1、delivery Tag: 交付标签机制</strong><br>消费端把消息处理结果ACK、NACK、Reject等返回给Broker之后，Broker需要对对应的消息执行后续操作，例如删除消息、重新排队或标记为死信等等。那么Broker就必须知道它现在要操作的消息具体是哪一条。而delivery Tag作为消息的唯一标识就很好的满足了这个需求。</p>
<p>提问：如果交换机是Fanout模式，同一个消息广播到了不同队列，delivery Tag会重复吗？</p>
<p>答：不会，deliveryTag在Broker范围内唯一</p>
<p>思考：更新购物车的微服务消费了消息返回ACK确认信息，然后Broker删除了消息，进而导致更新库存<br>更新积分的功能拿不到消息一这种情况会发生吗？</p>
<p><strong>2、multiple: 是否批量处理</strong></p>
<p>multiple为 <code>true</code> 时，采用批量处理</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67092faf85b10.png" alt="image-20241011220119070"></p>
<p>multiple为<code>false </code>时，进行单独处理</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/11/67092fa1ee2a8.png" alt="image-20241011220105475"></p>
<p>由于批量操作可能导致误操作，所以一般将<code>multiple</code> 设为<code>false</code></p>
<p><strong>3、requeue：是否重新入队</strong></p>
<p>true 表示重新入队, false 表示丢弃</p>
<h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><p><strong>1、以Debug模式启动Consumer服务</strong></p>
<p><strong>2、在图形化界面生成一条消息</strong></p>
<p>找到<code>exchange.direct.order</code>交换机，然后手动发布一条消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709d0863d22f.png" alt="image-20241012092733091"></p>
<p>消息发布成功，Debug进入到方法内部</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709d4d73a565.png" alt="image-20241012094558111"></p>
<p><strong>3、再查看<code>queue.order</code>队列情况</strong></p>
<p>发现消息已经被消费尚未ACK确认</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709d6ebe5c18.png" alt="image-20241012095451081"></p>
<p><strong>4、消费端正常放行，返回ACK进行确认</strong></p>
<p>再次查看队列情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709d7e249d1c.png" alt="image-20241012095857461"></p>
<p>接下来我们模拟异常场景，修改代码，手动打印 <code>1/0</code>使程序出错，重启服务</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">"消费端接收到消息：{}"</span>, dataString);</span><br><span class="line">System.out.println(<span class="number">1</span>/<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<p><strong>1、重新发布一条消息</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709dc5db05bf.png" alt="image-20241012101804618"></p>
<p><strong>2、debug逐条执行，观察运行情况</strong></p>
<p>出现异常被catch捕获，此时 <code>redelivered </code>的值为<code>false</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709dd5b09135.png" alt="image-20241012101747485"></p>
<p>继续执行，方法进入else ，重新放入队列</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709dd8c64f7f.png" alt="image-20241012102307570"></p>
<p>放行，此时消息仍是待确认</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709ddd54036c.png" alt="image-20241012102420402"></p>
<p>重新进入Debug，继续逐条执行，这次<code>redelivered </code>的值为<code>true</code>，不再重试，直接丢弃</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709de27302dd.png" alt="image-20241012102542308"></p>
<p>放行，此时再查看队列情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709decda8a13.png" alt="image-20241012102828818"></p>
<h1 id="消费端限流"><a href="#消费端限流" class="headerlink" title="消费端限流"></a>消费端限流</h1><p>消费端限流可以实现削峰减谷的作用，假设消息总量为1万条，如果一次性取出所有消息会导致消费端并发压力过大，我们可以限制<strong>每次最多</strong>从队列取出1000条消息，这样就可以对消费端进行很好的保护。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e0be28361.png" alt="image-20241012103645282"></p>
<p>实现也比较简单，只需添加<code>prefetch</code>参数即可</p>
<p>先观察下默认情况下是如何处理的</p>
<p><strong>1、我们重写一个测试方法，生产端发布100条消息</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test02SendMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Test Rrefetch!!"</span> + i;</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_DIRECT, ROUTING_KEY, message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>消息发布后查看下队列情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e2fbbc738.png" alt="image-20241012104618929"></p>
<p>2、消费端Listener注释掉原来的方法，新增一个方法进行处理</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = QUEUE_NAME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">    <span class="comment">// 核心操作</span></span><br><span class="line">    log.info(<span class="string">"消费端接收到消息：{}"</span>, dataString);</span><br><span class="line"></span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>); <span class="comment">//延迟 1 秒</span></span><br><span class="line"></span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3、运行消费端服务并查看队列情况</strong></p>
<p>观察发现 <code>Ready</code>数量直接从<code>100</code>变为<code>0</code>，<code>Unacked</code>和<code>Total</code>随着消息被消费端消费逐渐减少，说明消费时一次性取出队列中的所有消息，然后逐条消费。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e50531022.png" alt="image-20241012105500366"></p>
<p>接下来我们限制每次从队列中获取的数量并观察队列运行情况</p>
<p><strong>1、添加配置，设置每次从队列中获取消息的数量</strong></p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次只消费一个消息</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>2、重新发布消息以及重启消费端服务并观察队列运行情况</strong></p>
<p>我们可以看到<code>Ready</code>数量每次变化减<code>5</code>，这是因为图形化界面每<code>5</code>秒刷新一次</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e7aaec766.png" alt="image-20241012110618114"></p>
<h1 id="消息超时"><a href="#消息超时" class="headerlink" title="消息超时"></a>消息超时</h1><p>给消息设定一个过期时间，超过这个时间没有被取走的消息就会被删除<br>我们可以从两个层面来给消息设定过期时间：</p>
<ul>
<li>队列层面：在队列层面设定消息的过期时间，并不是队列的过期时间。意思是这个队列中的消息全部使用同一个过期时间。</li>
<li>消息本身：给具体的某个消息设定过期时间</li>
<li>如果两个层面都做了设置，那么哪个时间短，哪个生效</li>
</ul>
<h2 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h2><h3 id="给队列设置超时时间"><a href="#给队列设置超时时间" class="headerlink" title="给队列设置超时时间"></a>给队列设置超时时间</h3><p><strong>1、创建交换机和队列并建立绑定关系</strong></p>
<p>交换机：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e91b00fef.png" alt="image-20241012111226196"></p>
<p>队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e96fdf9ac.png" alt="image-20241012111351079"></p>
<p>交换机绑定队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709e9c701640.png" alt="image-20241012111518137"></p>
<p><strong>2、新增测试方法并执行测试</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_TIMEOUT</span> <span class="operator">=</span> <span class="string">"exchange.test.timeout"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_TIMEOUT</span> <span class="operator">=</span> <span class="string">"routing.key.test.timeout"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test03SendMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Test Timeout!!"</span>;</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_TIMEOUT, ROUTING_KEY_TIMEOUT, message);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时观察队列情况，发现<code>Total</code>数量从<code>0</code>变为<code>1</code>，而我们并未运行消费端进行消费，这是因为我们给队列设置了过期时间，队列内的消息超出过期时间后被丢弃</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709ec2431911.png" alt="image-20241012112523300"></p>
<h3 id="给消息设置超时时间"><a href="#给消息设置超时时间" class="headerlink" title="给消息设置超时时间"></a>给消息设置超时时间</h3><p><strong>1、删除原来的队列并重新创建，不设置超时时间</strong></p>
<p>队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709ef4dcab2d.png" alt="image-20241012113853021"></p>
<p>重新绑定：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709ef6b5b631.png" alt="image-20241012113922487"></p>
<p>2、新增测试方法，添加后置处理器对象参数</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test04SendMessage</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建消息后置处理器对象</span></span><br><span class="line">    <span class="type">MessagePostProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> message -&gt; {</span><br><span class="line">        <span class="comment">// 设置消息的过期时间为 7 秒</span></span><br><span class="line">        message.getMessageProperties().setExpiration(<span class="string">"7000"</span>);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Test Timeout!!"</span>;</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_TIMEOUT, ROUTING_KEY_TIMEOUT, message,processor);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3、设置<code>Ack Mode</code>为<code>Automatic ack</code></strong></p>
<p>这样消息处理失败不会重新加入队列</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709f0979a4aa.png" alt="image-20241012114422686"></p>
<p><strong>4、执行测试方法并观察队列情况</strong></p>
<p>消息超出超时时间后被清除</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709f15547536.png" alt="image-20241012114732505"></p>
<h1 id="死信和死信队列"><a href="#死信和死信队列" class="headerlink" title="死信和死信队列"></a>死信和死信队列</h1><p>概念：当一个消息无法被消费，它就变成了死信。<br>死信产生的原因大致有下面三种：</p>
<ul>
<li>拒绝：消费者拒接消息，basicNack(/basicReject(),并且不把消息重新放入原目标队列，requeue=false</li>
<li>溢出：队列中消息数量到达限制。比如队列最大只能存储10条消息，且现在已经存储了10条，此时如果再发送一条消息进来，根据先进先出原则，队列中最早的消息会变成死信</li>
<li>超时：消息到达超时时间未被消费</li>
</ul>
<p>死信的处理方式大致有下面三种：</p>
<ul>
<li>丢弃：对不重要的消息直接丢弃，不做处理</li>
<li>入库：把死信写入数据库，日后处理</li>
<li>监听：消息变成死信后进入死信队列，我们专门设置消费端监听死信队列，做后续处理（通常采用）</li>
</ul>
<h2 id="测试相关准备"><a href="#测试相关准备" class="headerlink" title="测试相关准备"></a>测试相关准备</h2><h3 id="创建死信交换机和死信队列"><a href="#创建死信交换机和死信队列" class="headerlink" title="创建死信交换机和死信队列"></a>创建死信交换机和死信队列</h3><ul>
<li>死信交换机: <code>exchange.dead.letter.video</code></li>
<li>死信队列：<code>queue.dead.letter.video</code></li>
<li>死信路由键：<code>routing.key.dead.letter.video</code></li>
</ul>
<h3 id="创建正常交换机和正常队列"><a href="#创建正常交换机和正常队列" class="headerlink" title="创建正常交换机和正常队列"></a>创建正常交换机和正常队列</h3><blockquote>
<p>注意：一定要注意正常队列有诸多限定和设置，这样才能让无法处理的消息进入死信交换机</p>
<p>x-dead-letter-exchange: 关联的死信交换机</p>
<p>x-dead-letter-routing-key：关联的死信路由键</p>
<p>x-max-length：队列最大容量长度</p>
<p>x-message-ttl：队列超时时间</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709f57a2079d.png" alt="image-20241012120513217"></p>
<ul>
<li>正常交换机：<code>exchange.normal.video</code></li>
<li>正常队列: <code>queue.normal.video</code></li>
<li>正常路由键：<code>routing.key.normal.video</code></li>
</ul>
<h3 id="java代码中的相关常量声明"><a href="#java代码中的相关常量声明" class="headerlink" title="java代码中的相关常量声明"></a>java代码中的相关常量声明</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NORMAL</span> <span class="operator">=</span> <span class="string">"exchange.normal.video"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DEAD_LETTER</span> <span class="operator">=</span> <span class="string">"exchange.dead.letter.video"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_NORMAL</span> <span class="operator">=</span> <span class="string">"routing.key.normal.video"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_DEAD_LETTER</span> <span class="operator">=</span> <span class="string">"routing.key.dead.letter.video"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NORMAL</span> <span class="operator">=</span> <span class="string">"queue.normal.video"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_DEAD_LETTER</span> <span class="operator">=</span> <span class="string">"queue.dead.letter.video"</span>;</span><br></pre></td></tr></tbody></table></figure>



<h2 id="消费端拒收消息"><a href="#消费端拒收消息" class="headerlink" title="消费端拒收消息"></a>消费端拒收消息</h2><h3 id="发送消息的代码"><a href="#发送消息的代码" class="headerlink" title="发送消息的代码"></a>发送消息的代码</h3><blockquote>
<p>也可直接在图形化界面操作</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendRejectMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NORMAL, ROUTING_KEY_DEAD_LETTER, <span class="string">"测试死信情况1:消息被拒绝"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="接收消息的代码"><a href="#接收消息的代码" class="headerlink" title="接收消息的代码"></a>接收消息的代码</h3><blockquote>
<p>由于监听正常队列的方法一定会拒绝并且不会重新加入队列，那么队列中的消息就会成为死信并加入到死信队列中，死信队列正常返回。</p>
</blockquote>
<p>① 监听正常队列</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 监听正常队列</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = QUEUE_NORMAL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processNormalMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">// 监听正常队列,但是拒绝消息</span></span><br><span class="line">    log.info(<span class="string">"★[normal] 消息接收到,但我拒绝。"</span>);</span><br><span class="line">    channel.basicReject(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>② 监听死信队列</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 监听死信队列</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = QUEUE_DEAD_LETTER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeadMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//监听死信队列</span></span><br><span class="line">    log.info(<span class="string">"★[dead letter] dataString = "</span> + dataString);</span><br><span class="line">    log.info(<span class="string">"★[dead1 etter] 我是死信监听方法,我接收到了死信消息"</span>);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><p><strong>1、正常队列发布消息</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709fda2dfd30.png" alt="image-20241012124002121"></p>
<p><strong>2、重启消费端服务</strong></p>
<p>后台日志输出情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709feb7e0e1a.png" alt="image-20241012124439157"></p>
<p><strong>3、观察队列情况</strong></p>
<p>正常队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709ff54bc1cb.png" alt="image-20241012124716010"></p>
<p>死信队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/6709ff4e73188.png" alt="image-20241012124709660"></p>
<h2 id="消费数量超过队列容量极限"><a href="#消费数量超过队列容量极限" class="headerlink" title="消费数量超过队列容量极限"></a>消费数量超过队列容量极限</h2><h3 id="发送消息的代码-1"><a href="#发送消息的代码-1" class="headerlink" title="发送消息的代码"></a>发送消息的代码</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMultiMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) {</span><br><span class="line">        rabbitTemplate.</span><br><span class="line">            convertAndSend(</span><br><span class="line">            EXCHANGE_NORMAL,</span><br><span class="line">            ROUTING_KEY_NORMAL,</span><br><span class="line">            <span class="string">"测试死信情况2:数量超过队列最大容量"</span> + i);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="接收消息的代码-1"><a href="#接收消息的代码-1" class="headerlink" title="接收消息的代码"></a>接收消息的代码</h3><h3 id="执行效果-5"><a href="#执行效果-5" class="headerlink" title="执行效果"></a>执行效果</h3><p><strong>1、停止消费端服务，批量发送20条消息</strong></p>
<p><strong>2、观察队列情况</strong></p>
<p>正常队列：</p>
<p>由于我们设置的最容量为<code>10</code>，所以我们最多接收<code>10</code>条消息，超出设定的超时时间后消息被废弃，数量变为<code>0</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a0155bd920.png" alt="image-20241012125548969"></p>
<p>死信队列：</p>
<p>由于我们设置的最大容量为<code>10</code>，消息成为死信后每<code>10</code>条消息为一个批次加入死信队列</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a0165cecc9.png" alt="image-20241012125605016"></p>
<p>此时我们启动消费端服务，观察日志输出情况，可以发现都是<code>dead</code>级别的日志，因为此时队列里的所有消息都变为死信了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a03f652392.png" alt="image-20241012130701315"></p>
<h2 id="消息超时未消费"><a href="#消息超时未消费" class="headerlink" title="消息超时未消费"></a>消息超时未消费</h2><h3 id="发送消息的代码-2"><a href="#发送消息的代码-2" class="headerlink" title="发送消息的代码"></a>发送消息的代码</h3><blockquote>
<p>由于我们设置的队列最大容量为10，为了避免由于溢出产生死信的影响，我们发送小于10条的数据</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDelayMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) {</span><br><span class="line">        rabbitTemplate.</span><br><span class="line">            convertAndSend(</span><br><span class="line">            EXCHANGE_NORMAL,</span><br><span class="line">            ROUTING_KEY_NORMAL,</span><br><span class="line">            <span class="string">"测试死信情况3:消息超时未消费"</span> + i);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="执行效果-6"><a href="#执行效果-6" class="headerlink" title="执行效果"></a>执行效果</h3><p><strong>1、停止消费端服务，发送消息</strong></p>
<p><strong>2、查看队列情况</strong></p>
<p>正常队列：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a0b21d5eb5.png" alt="image-20241012133737142"></p>
<p>死信队列：</p>
<p>死信队列从原始的<code>30</code>条数量增至<code>38</code>条，我们发送的<code>8</code>条数据因为超时未消费加入到死信队列中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a0b0c29ff9.png" alt="image-20241012133715332"></p>
<h1 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h1><h2 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h2><p>在限定时间内进行支付，否则订单自动取消</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a0c2b08952.png" alt="image-20241012134202272"></p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="方案1：设置消息超时时间-死信队列"><a href="#方案1：设置消息超时时间-死信队列" class="headerlink" title="方案1：设置消息超时时间 + 死信队列"></a><strong>方案1：设置消息超时时间 + 死信队列</strong></h3><blockquote>
<p>可参考上文介绍，不再演示</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a0cc76665e.png" alt="image-20241012134438561"></p>
<h3 id="方案2：给RabbitMQ安装插件"><a href="#方案2：给RabbitMQ安装插件" class="headerlink" title="方案2：给RabbitMQ安装插件"></a><strong>方案2：给RabbitMQ安装插件</strong></h3><h4 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h4><p>官网地址：https:/github.com/rabbitmq/rabbitmq-delayed-message-exchange<br>延迟极限：最多两天</p>
<h4 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h4><h4 id="确定卷映射目录"><a href="#确定卷映射目录" class="headerlink" title="确定卷映射目录"></a>确定卷映射目录</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect rabbitmq</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"Id"</span><span class="punctuation">:</span> <span class="string">"3767efc3f46e05b63dbb6a244f2f5a850a60febe52cc1bdf96e75f5449d7979e"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Created"</span><span class="punctuation">:</span> <span class="string">"2024-10-10T14:41:39.651931938Z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Path"</span><span class="punctuation">:</span> <span class="string">"docker-entrypoint.sh"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Args"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"rabbitmq-server"</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"State"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"Status"</span><span class="punctuation">:</span> <span class="string">"running"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Running"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Paused"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Restarting"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"OOMKilled"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Dead"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Pid"</span><span class="punctuation">:</span> <span class="number">2671</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ExitCode"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Error"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"StartedAt"</span><span class="punctuation">:</span> <span class="string">"2024-10-12T01:18:16.845798068Z"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"FinishedAt"</span><span class="punctuation">:</span> <span class="string">"2024-10-12T01:15:50.852558669Z"</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Image"</span><span class="punctuation">:</span> <span class="string">"sha256:c7383e9ad93d65dea7219907c8ac08e6f8cdad481f17c78b3864f29b2cd50a7b"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"ResolvConfPath"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/containers/3767efc3f46e05b63dbb6a244f2f5a850a60febe52cc1bdf96e75f5449d7979e/resolv.conf"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"HostnamePath"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/containers/3767efc3f46e05b63dbb6a244f2f5a850a60febe52cc1bdf96e75f5449d7979e/hostname"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"HostsPath"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/containers/3767efc3f46e05b63dbb6a244f2f5a850a60febe52cc1bdf96e75f5449d7979e/hosts"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"LogPath"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/containers/3767efc3f46e05b63dbb6a244f2f5a850a60febe52cc1bdf96e75f5449d7979e/3767efc3f46e05b63dbb6a244f2f5a850a60febe52cc1bdf96e75f5449d7979e-json.log"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"RestartCount"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"overlay2"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Platform"</span><span class="punctuation">:</span> <span class="string">"linux"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"MountLabel"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"ProcessLabel"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"AppArmorProfile"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"ExecIDs"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"HostConfig"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"Binds"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"rabbitmq-plugin:/plugins"</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ContainerIDFile"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"LogConfig"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"json-file"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Config"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"NetworkMode"</span><span class="punctuation">:</span> <span class="string">"bridge"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"PortBindings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"15672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"HostIp"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"HostPort"</span><span class="punctuation">:</span> <span class="string">"15672"</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"5672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"HostIp"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"HostPort"</span><span class="punctuation">:</span> <span class="string">"5672"</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"RestartPolicy"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"no"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"MaximumRetryCount"</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"AutoRemove"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"VolumeDriver"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"VolumesFrom"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ConsoleSize"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">108</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CapAdd"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CapDrop"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CgroupnsMode"</span><span class="punctuation">:</span> <span class="string">"host"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Dns"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"DnsOptions"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"DnsSearch"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ExtraHosts"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"GroupAdd"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"IpcMode"</span><span class="punctuation">:</span> <span class="string">"private"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Cgroup"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Links"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"OomScoreAdj"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"PidMode"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Privileged"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"PublishAllPorts"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ReadonlyRootfs"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"SecurityOpt"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"UTSMode"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"UsernsMode"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ShmSize"</span><span class="punctuation">:</span> <span class="number">67108864</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Runtime"</span><span class="punctuation">:</span> <span class="string">"runc"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Isolation"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuShares"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Memory"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"NanoCpus"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CgroupParent"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"BlkioWeight"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"BlkioWeightDevice"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"BlkioDeviceReadBps"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"BlkioDeviceWriteBps"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"BlkioDeviceReadIOps"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"BlkioDeviceWriteIOps"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuPeriod"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuQuota"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuRealtimePeriod"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuRealtimeRuntime"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpusetCpus"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpusetMems"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Devices"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"DeviceCgroupRules"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"DeviceRequests"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"MemoryReservation"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"MemorySwap"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"MemorySwappiness"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"OomKillDisable"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"PidsLimit"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Ulimits"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuCount"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"CpuPercent"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"IOMaximumIOps"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"IOMaximumBandwidth"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"MaskedPaths"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"/proc/asound"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/acpi"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/kcore"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/keys"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/latency_stats"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/timer_list"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/timer_stats"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/sched_debug"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/scsi"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/sys/firmware"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/sys/devices/virtual/powercap"</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ReadonlyPaths"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"/proc/bus"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/fs"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/irq"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/sys"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"/proc/sysrq-trigger"</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"GraphDriver"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"Data"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"LowerDir"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/overlay2/7f9ec2fa1e82857b9f69c15ff993393a2787d8b854cd0b8a56ac6131ec7e6fb2-init/diff:/var/lib/docker/overlay2/cdd788016ee61771c380142548344cbed891addecfd97646c4cf42d9edd3ce8c/diff:/var/lib/docker/overlay2/0b656bd93fa5cdda1adac4843dc83a1d08cf0af5bb45c5a2b73aafed4f90838e/diff:/var/lib/docker/overlay2/6252d4ba56e7b90f4d9e87bf441483853dcefb58e49784cfedfe67e8a48d8d79/diff:/var/lib/docker/overlay2/3383c7042c8fba359d23128aa2c41964e30a96c18e7c3db2f7032dfe17399201/diff:/var/lib/docker/overlay2/78a8fa92f9e0114da9aa6e61acd4977c8a9b954a669bfb2aa90419923573f4da/diff:/var/lib/docker/overlay2/cff69ece62be74cc51d8bbef3742b39f6cc400c7ee3f24058a7a0527e6827d3a/diff:/var/lib/docker/overlay2/8cabb7d5fb5e7367ad9b66f8e17fd900ee3ef0314b2688a2934e780946484861/diff:/var/lib/docker/overlay2/845a32b37870732f9007b1be2e7ab61e6df0bd6292b1fc5198f4306c623b2ab1/diff:/var/lib/docker/overlay2/69d0a01812c1cd2d1f040967b9d0a7a2d79c3ef10413e992762079b9a2ad5b2d/diff:/var/lib/docker/overlay2/e641dae2802f486d2f4b0f8f29b81903470684e403dd74ced36e0146be9a34ea/diff"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"MergedDir"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/overlay2/7f9ec2fa1e82857b9f69c15ff993393a2787d8b854cd0b8a56ac6131ec7e6fb2/merged"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"UpperDir"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/overlay2/7f9ec2fa1e82857b9f69c15ff993393a2787d8b854cd0b8a56ac6131ec7e6fb2/diff"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"WorkDir"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/overlay2/7f9ec2fa1e82857b9f69c15ff993393a2787d8b854cd0b8a56ac6131ec7e6fb2/work"</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"overlay2"</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Mounts"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"volume"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"rabbitmq-plugin"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Source"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/volumes/rabbitmq-plugin/_data"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Destination"</span><span class="punctuation">:</span> <span class="string">"/plugins"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Mode"</span><span class="punctuation">:</span> <span class="string">"z"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"RW"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Propagation"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"volume"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"b7b13350e8b0d3596aff94385354a1b9366dffeb6b38f8e82a519638f22d74a0"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Source"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/volumes/b7b13350e8b0d3596aff94385354a1b9366dffeb6b38f8e82a519638f22d74a0/_data"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Destination"</span><span class="punctuation">:</span> <span class="string">"/var/lib/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Mode"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"RW"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"Propagation"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Config"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"Hostname"</span><span class="punctuation">:</span> <span class="string">"3767efc3f46e"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Domainname"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"User"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"AttachStdin"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"AttachStdout"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"AttachStderr"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"ExposedPorts"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"15671/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"15672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"15691/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"15692/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"25672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"4369/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"5671/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"5672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Tty"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"OpenStdin"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"StdinOnce"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Env"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"RABBITMQ_DEFAULT_USER=guest"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"RABBITMQ_DEFAULT_PASS=123456"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"PATH=/opt/rabbitmq/sbin:/opt/erlang/bin:/opt/openssl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"ERLANG_INSTALL_PATH_PREFIX=/opt/erlang"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"OPENSSL_INSTALL_PATH_PREFIX=/opt/openssl"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"RABBITMQ_DATA_DIR=/var/lib/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"RABBITMQ_VERSION=3.13.7"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"RABBITMQ_PGP_KEY_ID=0x0A9AF2115F4687BD29803A206B73A36E6026DFCA"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"RABBITMQ_HOME=/opt/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"HOME=/var/lib/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"LANG=C.UTF-8"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"LANGUAGE=C.UTF-8"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">"LC_ALL=C.UTF-8"</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Cmd"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"rabbitmq-server"</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Image"</span><span class="punctuation">:</span> <span class="string">"rabbitmq:3.13-management"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Volumes"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"/var/lib/rabbitmq"</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"WorkingDir"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Entrypoint"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">"docker-entrypoint.sh"</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"OnBuild"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Labels"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"org.opencontainers.image.ref.name"</span><span class="punctuation">:</span> <span class="string">"ubuntu"</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"org.opencontainers.image.version"</span><span class="punctuation">:</span> <span class="string">"22.04"</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"NetworkSettings"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">            <span class="attr">"Bridge"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"SandboxID"</span><span class="punctuation">:</span> <span class="string">"8e3bdc85876ee83c4dc6f9e6501e1cdf6a2f6eba255424d3b541ca4043ff6f91"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"SandboxKey"</span><span class="punctuation">:</span> <span class="string">"/var/run/docker/netns/8e3bdc85876e"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Ports"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"15671/tcp"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"15672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"HostIp"</span><span class="punctuation">:</span> <span class="string">"0.0.0.0"</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"HostPort"</span><span class="punctuation">:</span> <span class="string">"15672"</span></span><br><span class="line">                    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"HostIp"</span><span class="punctuation">:</span> <span class="string">"::"</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"HostPort"</span><span class="punctuation">:</span> <span class="string">"15672"</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"15691/tcp"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"15692/tcp"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"25672/tcp"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"4369/tcp"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"5671/tcp"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">"5672/tcp"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"HostIp"</span><span class="punctuation">:</span> <span class="string">"0.0.0.0"</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"HostPort"</span><span class="punctuation">:</span> <span class="string">"5672"</span></span><br><span class="line">                    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">{</span></span><br><span class="line">                        <span class="attr">"HostIp"</span><span class="punctuation">:</span> <span class="string">"::"</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">"HostPort"</span><span class="punctuation">:</span> <span class="string">"5672"</span></span><br><span class="line">                    <span class="punctuation">}</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"HairpinMode"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"LinkLocalIPv6Address"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"LinkLocalIPv6PrefixLen"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"SecondaryIPAddresses"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"SecondaryIPv6Addresses"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"EndpointID"</span><span class="punctuation">:</span> <span class="string">"6fd5e5f59233ec528be7df6e5f500d800b7abb4df049f2576bb92c5b859d3137"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Gateway"</span><span class="punctuation">:</span> <span class="string">"172.17.0.1"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"GlobalIPv6Address"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"GlobalIPv6PrefixLen"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"IPAddress"</span><span class="punctuation">:</span> <span class="string">"172.17.0.2"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"IPPrefixLen"</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"IPv6Gateway"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"MacAddress"</span><span class="punctuation">:</span> <span class="string">"02:42:ac:11:00:02"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">"Networks"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                <span class="attr">"bridge"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">                    <span class="attr">"IPAMConfig"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"Links"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"Aliases"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"MacAddress"</span><span class="punctuation">:</span> <span class="string">"02:42:ac:11:00:02"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"NetworkID"</span><span class="punctuation">:</span> <span class="string">"7cba32bdc71b92580e2873585313c97476d61b466b33335116931c7f3b7dbb8b"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"EndpointID"</span><span class="punctuation">:</span> <span class="string">"6fd5e5f59233ec528be7df6e5f500d800b7abb4df049f2576bb92c5b859d3137"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"Gateway"</span><span class="punctuation">:</span> <span class="string">"172.17.0.1"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"IPAddress"</span><span class="punctuation">:</span> <span class="string">"172.17.0.2"</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"IPPrefixLen"</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"IPv6Gateway"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"GlobalIPv6Address"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"GlobalIPv6PrefixLen"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"DriverOpts"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">"DNSNames"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">                <span class="punctuation">}</span></span><br><span class="line">            <span class="punctuation">}</span></span><br><span class="line">        <span class="punctuation">}</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure>

<p>查看<code>Mounts</code>中Name为<code>rabbitmq-plugin</code>对应的<code>Source</code>值</p>
<p>可以看到值为<code>/var/lib/docker/volumes/rabbitmq-plugin/_data</code></p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"Mounts"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"volume"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"rabbitmq-plugin"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Source"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/volumes/rabbitmq-plugin/_data"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Destination"</span><span class="punctuation">:</span> <span class="string">"/plugins"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Mode"</span><span class="punctuation">:</span> <span class="string">"z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"RW"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Propagation"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"volume"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"b7b13350e8b0d3596aff94385354a1b9366dffeb6b38f8e82a519638f22d74a0"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Source"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/volumes/b7b13350e8b0d3596aff94385354a1b9366dffeb6b38f8e82a519638f22d74a0/_data"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Destination"</span><span class="punctuation">:</span> <span class="string">"/var/lib/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Mode"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"RW"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Propagation"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="下载延迟插件"><a href="#下载延迟插件" class="headerlink" title="下载延迟插件"></a>下载延迟插件</h4><p>官方文档说明页地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins">https://www.rabbitmq.com/community-plugins</a></p>
<p><strong>rabbitmq_delayed_message_exchange</strong></p>
<p>A plugin that adds delayed-messaging (or scheduled-messaging) to RabbitMQ.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases">Releases</a></li>
<li>Author: <strong>Alvaro Videla</strong></li>
<li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">rabbitmq/rabbitmq-delayed-message-exchange</a></li>
</ul>
<p>下载插件安装文件：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/lib/docker/volumes/rabbitmq-plugin/_data</span><br><span class="line">wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.13.0/rabbitmq_delayed_message_exchange-3.13.0.ez</span><br></pre></td></tr></tbody></table></figure>

<p>若连接被拒绝可多次尝试，或手动下载</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a1371eaf32.png" alt="image-20241012141305073"></p>
<h3 id="启用插件"><a href="#启用插件" class="headerlink" title="启用插件"></a>启用插件</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录进入容器内部</span></span><br><span class="line">docker exec -it rabbitmq /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rabbitmq-plugins命令所在目录已经配置到<span class="variable">$PATH</span>环境变量中了,可以直接调用</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看插件列表，检查插件是否启用 有E*标识即为已启用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[E*] rabbitmq_delayed_message_exchange 3.13.0</span></span><br><span class="line">rabbitmq-plugins list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出Docker容器</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启Docker容器</span></span><br><span class="line">docker restart rabbitmq</span><br></pre></td></tr></tbody></table></figure>



<h4 id="确认"><a href="#确认" class="headerlink" title="确认"></a>确认</h4><p>确认点1：查看当前节点已启用插件的列表：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a15ff657d8.png" alt="image-20241012142358715"></p>
<p>确认点2：如果创建新交换机时在<code>Type</code>中可以看到<code>x-delayed-message</code>选项，则说明插件安装好了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a19aadf4f8.png" alt="image-20241012143937188"></p>
<h3 id="创建交换机及队列"><a href="#创建交换机及队列" class="headerlink" title="创建交换机及队列"></a>创建交换机及队列</h3><p><strong>创建交换机：</strong></p>
<p>Type选择<code>x-delayed-message</code>，添加<code>x-delayed-type</code>来指定交换机类型</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a16a8d31da.png" alt="image-20241012142648189"></p>
<p><strong>创建队列：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a172def313.png" alt="image-20241012142901241"></p>
<p><strong>队列绑定交换机：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a17d60254c.png" alt="image-20241012143149354"></p>
<h3 id="代码测试"><a href="#代码测试" class="headerlink" title="代码测试"></a>代码测试</h3><h4 id="生产者端代码"><a href="#生产者端代码" class="headerlink" title="生产者端代码"></a>生产者端代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DELAY</span> <span class="operator">=</span> <span class="string">"exchange.test.delay"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_DELAY</span> <span class="operator">=</span> <span class="string">"routing.key.test.delay"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayMessageByPlugin</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 创建消息后置处理器对象</span></span><br><span class="line">    <span class="type">MessagePostProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> message -&gt; {</span><br><span class="line">        <span class="comment">// x-delay: 消息的过期时间 (单位:毫秒)</span></span><br><span class="line">        <span class="comment">// 安装 rabbitmq_delayed_message_exchange 插件才生效</span></span><br><span class="line">        message.getMessageProperties().setHeader(<span class="string">"x-delay"</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.</span><br><span class="line">        convertAndSend(</span><br><span class="line">        EXCHANGE_DELAY,</span><br><span class="line">        ROUTING_KEY_DELAY,</span><br><span class="line">        <span class="string">"Test Delay Message By Plugin"</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()),</span><br><span class="line">        processor);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="消费者端代码"><a href="#消费者端代码" class="headerlink" title="消费者端代码"></a>消费者端代码</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_DELAY</span> <span class="operator">=</span> <span class="string">"queue.test.delay"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_DELAY})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDelayMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">//监听死信队列</span></span><br><span class="line">    log.info(<span class="string">"[delay message] [消息本身] "</span> + dataString);</span><br><span class="line">    log.info(<span class="string">"[delay message] [当前时间] "</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>启动消费者端服务并发送消息，查看日志输出情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a1e98aa942.png" alt="image-20241012150040029"></p>
<p>注意：启用插件后，returnedMessage方法始终会执行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a1f2319d8d.png" alt="image-20241012150258397"></p>
<h1 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h1><blockquote>
<p>RabbitMQ的事务只是作用到生产者端，而且只起到局部作用</p>
</blockquote>
<p>RabbitMQ的事务功能非常有限，只是控制是否将缓存中的消息发送到Broker，并不能保证消息的可靠性投递</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a21f0d0051.png" alt="image-20241012151455965"></p>
<h2 id="实操演示"><a href="#实操演示" class="headerlink" title="实操演示"></a>实操演示</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="创建项目并导入依赖-4"><a href="#创建项目并导入依赖-4" class="headerlink" title="创建项目并导入依赖"></a>创建项目并导入依赖</h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.shiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>module07-tx-producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- springboot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置文件-2"><a href="#配置文件-2" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.shiguang.mq:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/12 15:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class,args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置类-1"><a href="#配置类-1" class="headerlink" title="配置类"></a>配置类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/12 15:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> {</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTransactionManager <span class="title function_">transactionManager</span><span class="params">(CachingConnectionFactory connectionFactory)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RabbitTransactionManager</span>(connectionFactory);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTemplate <span class="title function_">rabbitTemplate</span><span class="params">(CachingConnectionFactory connectionFactory)</span> {</span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>(connectionFactory);</span><br><span class="line">        rabbitTemplate.setChannelTransacted(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="测试类-1"><a href="#测试类-1" class="headerlink" title="测试类"></a>测试类</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/12 15:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">"exchange.tx.dragon"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"routing.key.tx.dragon"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageTx</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">// 1、 发送一条消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"hello rabbitmq tx message 1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、抛出异常</span></span><br><span class="line">        log.info(<span class="string">"do bad: "</span>+ <span class="number">10</span>/<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、发送第二条消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"hello rabbitmq tx message 2"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="测试-5"><a href="#测试-5" class="headerlink" title="测试"></a>测试</h3><blockquote>
<p>我们分别发送两条消息，两条消息中间手动抛出异常，来观察启用事务前后的区别</p>
</blockquote>
<p><strong>1、创建交换机、队列并绑定关系</strong></p>
<p>交换机名称：exchange.tx.dragon</p>
<p>队列名称：queue.test.tx</p>
<p>路由键：routing.key.tx.dragon</p>
<p><strong>2、发送消息并观察队列情况</strong></p>
<p>默认未使用事务的情况：第一条事务发送成功，消息能够正常获取</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a2a8802691.png" alt="image-20241012155135362"></p>
<p>开启事务：</p>
<p>测试类添加<code>@Transactional</code>注解，由于JUnit中是默认回滚的，我们想要提交事务，需要添加<code>@Rollback(value = false)</code>注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="comment">//@Rollback(value = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageTx</span><span class="params">()</span>{</span><br><span class="line">    <span class="comment">// 1、 发送一条消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"hello rabbitmq tx message 1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、抛出异常</span></span><br><span class="line">    log.info(<span class="string">"do bad: "</span>+ <span class="number">10</span>/<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、发送第二条消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"hello rabbitmq tx message 2"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们保持默认回滚事务，执行测试方法，观察队列情况</p>
<p>由于出现异常，事务被回滚，消息未发送</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a2e64e3dbc.png" alt="image-20241012160804246"></p>
<h1 id="惰性队列"><a href="#惰性队列" class="headerlink" title="惰性队列"></a>惰性队列</h1><p>惰性队列：未设置惰性模式时队列的持久化机制</p>
<p>创建队列时，在Durabilityi这里有两个选项可以选择</p>
<ul>
<li>Durable: 持久化队列，消息会持久化到硬盘上</li>
<li>Transient: 临时队列，不做持久化操作，broker重启后消息会丢失</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a2f1969856.png" alt="image-20241012161104810"></p>
<blockquote>
<p>思考：Durable队列在存入消息之后，是否是立即保存到硬盘呢？</p>
</blockquote>
<p>其实并不会立即保存到硬盘，当内存中的队列达到一定容量或者Broker关闭时才会保存到硬盘</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a2f8b26856.png" alt="image-20241012161258471"></p>
<p>官网上对于惰性队列的介绍</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a303c6f78a.png" alt="image-20241012161555727"></p>
<p>比较下面两个说法是否是相同的意思：</p>
<ul>
<li>立即移动到硬盘</li>
<li>尽早移动到硬盘</li>
</ul>
<p>理解：</p>
<ul>
<li><p>立即：消息刚进入队列时</p>
</li>
<li><p>尽早：服务器不繁忙时</p>
</li>
</ul>
<p>惰性队列应用场景</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a30d7b419f.png" alt="image-20241012161831032"></p>
<p>原文翻译：使用惰性队列的主要原因之一是支持非常长的队列（数百万条消息）<br>由于各种原因，排队可能会变得很长：</p>
<ul>
<li>消费者离线/崩溃/停机进行维护</li>
<li>突然出现消息进入高峰生产者的速度超过了消费者</li>
<li>消费者比正常情况慢</li>
</ul>
<h1 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列"></a>优先级队列</h1><p>机制说明<br>默认情况：基于队列先进先出的特性，通常来说，先入队的先投递<br>设置优先级之后：优先级高的消息更大几率先投递<br>关键参数：<code>x-max-priority</code></p>
<p>RabbitMQ允许我们使用一个正整数给消息设定优先级<br>消息的优先级数值取值范围：<code>1~255</code><br>RabbitMQ官网建议在<code>1~5</code>之间设置消息的优先级（优先级越高，占用CPU、内存等资源越多)</p>
<p>队列在声明时可以指定参数：<code>x-max-priority</code><br>默认值：<code>0</code> ，此时消息即使设置优先级也无效<br>指定一个正整数值：消息的优先级数值不能超过这个值</p>
<h2 id="实操演示-1"><a href="#实操演示-1" class="headerlink" title="实操演示"></a>实操演示</h2><p><strong>1、创建交换机及队列并绑定</strong></p>
<p>交换机名称：exchange.test.priority</p>
<p>队列名称：queue.test.priority</p>
<blockquote>
<p>x-max-priority的类型必须是Number</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a33f343577.png" alt="image-20241012163146628"></p>
<p>路由键：routing.key.test.priority</p>
<p><strong>2、分别发送三条消息，优先级从低到高，后面观察入队情况</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_PRIORITY</span> <span class="operator">=</span> <span class="string">"exchange.test.priority"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_PRIORITY</span> <span class="operator">=</span> <span class="string">"routing.key.test.priority"</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>发送第一条消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendPriorityMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.</span><br><span class="line">        convertAndSend(</span><br><span class="line">        EXCHANGE_PRIORITY,</span><br><span class="line">        ROUTING_KEY_PRIORITY,</span><br><span class="line">        <span class="string">"Test Priority Message 1"</span>,message -&gt; {</span><br><span class="line">            <span class="comment">//消息本身的优先级数据,不能超过队列配置的最大值 x-max-priority</span></span><br><span class="line">            message.getMessageProperties().setPriority(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>发送第二条消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendPriorityMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.</span><br><span class="line">        convertAndSend(</span><br><span class="line">        EXCHANGE_PRIORITY,</span><br><span class="line">        ROUTING_KEY_PRIORITY,</span><br><span class="line">        <span class="string">"Test Priority Message 2"</span>,message -&gt; {</span><br><span class="line">            <span class="comment">//消息本身的优先级数据,不能超过队列配置的最大值 x-max-priority</span></span><br><span class="line">            message.getMessageProperties().setPriority(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>发送第三条消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendPriorityMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.</span><br><span class="line">        convertAndSend(</span><br><span class="line">        EXCHANGE_PRIORITY,</span><br><span class="line">        ROUTING_KEY_PRIORITY,</span><br><span class="line">        <span class="string">"Test Priority Message 3"</span>,message -&gt; {</span><br><span class="line">            <span class="comment">//消息本身的优先级数据,不能超过队列配置的最大值 x-max-priority</span></span><br><span class="line">            message.getMessageProperties().setPriority(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3、启动客户端服务，查看日志输出情况</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_PRIORITY</span> <span class="operator">=</span> <span class="string">"queue.test.priority"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_PRIORITY})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPriorityMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    log.info(<span class="string">"[priority]: "</span> + dataString);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以看到优先级高的先输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a38faf33bd.png" alt="image-20241012165314324"></p>
<h1 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h1><h2 id="安装RabbitMQ-1"><a href="#安装RabbitMQ-1" class="headerlink" title="安装RabbitMQ"></a>安装RabbitMQ</h2><h3 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h3><blockquote>
<p>课程要求CentOS发行版的版本≥8，CentOS 7.x  其实也可以，后面有详细介绍</p>
</blockquote>
<p>下载地址：<a target="_blank" rel="noopener" href="https://mirrors.163.com/centos/">https://mirrors.163.com/centos/</a></p>
<p>查看当前系统发行版本：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost _data]# hostnamectl </span><br><span class="line">   Static hostname: localhost.localdomain</span><br><span class="line">         Icon name: computer-vm</span><br><span class="line">           Chassis: vm</span><br><span class="line">        Machine ID: 1e9464680b694994bb37fa7013bd3ea7</span><br><span class="line">           Boot ID: e0865df1adfa476eb633daed2637bff1</span><br><span class="line">    Virtualization: vmware</span><br><span class="line">  Operating System: CentOS Linux 7 (Core)</span><br><span class="line">       CPE OS Name: cpe:/o:centos:centos:7</span><br><span class="line">            Kernel: Linux 3.10.0-1160.90.1.el7.x86_64</span><br><span class="line">      Architecture: x86-64</span><br></pre></td></tr></tbody></table></figure>



<p>RabbitMQ安装方式官方指南：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/install-rpm">https://www.rabbitmq.com/docs/install-rpm</a></p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a3c110e06a.png" alt="image-20241012170624420"></p>
<h3 id="安装Erlang环境"><a href="#安装Erlang环境" class="headerlink" title="安装Erlang环境"></a>安装Erlang环境</h3><h4 id="创建yum库配置文件"><a href="#创建yum库配置文件" class="headerlink" title="创建yum库配置文件"></a><strong>创建yum库配置文件</strong></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/rabbitmq.repo</span><br></pre></td></tr></tbody></table></figure>

<h4 id="加入配置内容"><a href="#加入配置内容" class="headerlink" title="加入配置内容"></a><strong>加入配置内容</strong></h4><blockquote>
<p>以下内容来自官网文档：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/install-rpm">https://www.rabbitmq.com/docs/install-rpm</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"># In /etc/yum.repos.d/rabbitmq.repo</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line">## Zero dependency Erlang RPM</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">[modern-erlang]</span><br><span class="line">name=modern-erlang-el9</span><br><span class="line"># Use a set of mirrors maintained by the RabbitMQ core team.</span><br><span class="line"># The mirrors have significantly higher bandwidth quotas.</span><br><span class="line">baseurl=https://yum1.rabbitmq.com/erlang/el/9/$basearch</span><br><span class="line">        https://yum2.rabbitmq.com/erlang/el/9/$basearch</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key</span><br><span class="line">gpgcheck=1</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">metadata_expire=300</span><br><span class="line">pkg_gpgcheck=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br><span class="line"></span><br><span class="line">[modern-erlang-noarch]</span><br><span class="line">name=modern-erlang-el9-noarch</span><br><span class="line"># Use a set of mirrors maintained by the RabbitMQ core team.</span><br><span class="line"># The mirrors have significantly higher bandwidth quotas.</span><br><span class="line">baseurl=https://yum1.rabbitmq.com/erlang/el/9/noarch</span><br><span class="line">        https://yum2.rabbitmq.com/erlang/el/9/noarch</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key</span><br><span class="line">       https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span><br><span class="line">gpgcheck=1</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">metadata_expire=300</span><br><span class="line">pkg_gpgcheck=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br><span class="line"></span><br><span class="line">[modern-erlang-source]</span><br><span class="line">name=modern-erlang-el9-source</span><br><span class="line"># Use a set of mirrors maintained by the RabbitMQ core team.</span><br><span class="line"># The mirrors have significantly higher bandwidth quotas.</span><br><span class="line">baseurl=https://yum1.rabbitmq.com/erlang/el/9/SRPMS</span><br><span class="line">        https://yum2.rabbitmq.com/erlang/el/9/SRPMS</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key</span><br><span class="line">       https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span><br><span class="line">gpgcheck=1</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">metadata_expire=300</span><br><span class="line">pkg_gpgcheck=1</span><br><span class="line">autorefresh=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##</span><br><span class="line">## RabbitMQ Server</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">[rabbitmq-el9]</span><br><span class="line">name=rabbitmq-el9</span><br><span class="line">baseurl=https://yum2.rabbitmq.com/rabbitmq/el/9/$basearch</span><br><span class="line">        https://yum1.rabbitmq.com/rabbitmq/el/9/$basearch</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line"># Cloudsmith's repository key and RabbitMQ package signing key</span><br><span class="line">gpgkey=https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key</span><br><span class="line">       https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span><br><span class="line">gpgcheck=1</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">metadata_expire=300</span><br><span class="line">pkg_gpgcheck=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br><span class="line"></span><br><span class="line">[rabbitmq-el9-noarch]</span><br><span class="line">name=rabbitmq-el9-noarch</span><br><span class="line">baseurl=https://yum2.rabbitmq.com/rabbitmq/el/9/noarch</span><br><span class="line">        https://yum1.rabbitmq.com/rabbitmq/el/9/noarch</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line"># Cloudsmith's repository key and RabbitMQ package signing key</span><br><span class="line">gpgkey=https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key</span><br><span class="line">       https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span><br><span class="line">gpgcheck=1</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">metadata_expire=300</span><br><span class="line">pkg_gpgcheck=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br><span class="line"></span><br><span class="line">[rabbitmq-el9-source]</span><br><span class="line">name=rabbitmq-el9-source</span><br><span class="line">baseurl=https://yum2.rabbitmq.com/rabbitmq/el/9/SRPMS</span><br><span class="line">        https://yum1.rabbitmq.com/rabbitmq/el/9/SRPMS</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key</span><br><span class="line">gpgcheck=0</span><br><span class="line">sslverify=1</span><br><span class="line">sslcacert=/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">metadata_expire=300</span><br><span class="line">pkg_gpgcheck=1</span><br><span class="line">autorefresh=1</span><br><span class="line">type=rpm-md</span><br></pre></td></tr></tbody></table></figure>

<h4 id="更新yum库"><a href="#更新yum库" class="headerlink" title="更新yum库"></a><strong>更新yum库</strong></h4><blockquote>
<p>–nobest 表示所需安装包即使不是最佳选择也接收</p>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y --nobest</span><br></pre></td></tr></tbody></table></figure>

<p>若不支持系统<code>--nobest</code>参数则可不使用</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y </span><br></pre></td></tr></tbody></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/12/670a3f3c5005e.png" alt="image-20241012171955556"></p>
<h4 id="正式安装Erlang"><a href="#正式安装Erlang" class="headerlink" title="正式安装Erlang"></a><strong>正式安装Erlang</strong></h4><h5 id="CentOS-8"><a href="#CentOS-8" class="headerlink" title="CentOS 8"></a>CentOS 8</h5><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y erlang</span><br></pre></td></tr></tbody></table></figure>

<h5 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS 7"></a><strong>CentOS 7</strong></h5><p><strong>卸载旧版本</strong></p>
<p>若未安装过，可跳过</p>
<blockquote>
<p><strong>卸载旧版本的 Erlang</strong></p>
<ol>
<li><p><strong>查找已安装的 Erlang 包：</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep erlang</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><strong>卸载旧版本的 Erlang</strong>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum remove erlang-26.2.5.4-1.el7.x86_64</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<p><strong>检查并删除残留文件</strong></p>
<p><strong>确保系统中没有其他 Erlang 版本的残留文件或配置。</strong></p>
<ol>
<li><p><strong>查找并删除所有与 Erlang 相关的目录</strong>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> find / -name <span class="string">"erlang"</span> -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">rm</span> -rf {} +</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><strong>查找并删除所有与 Erlang 相关的文件</strong>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> find / -name <span class="string">"*erlang*"</span> -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">rm</span> -f {} +</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><strong>查找并删除所有与 Erlang 相关的符号链接</strong>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">sudo</span> find /usr/bin /usr/local/bin -name <span class="string">"erl*"</span> -<span class="built_in">type</span> l -<span class="built_in">exec</span> <span class="built_in">rm</span> -f {} +</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装时需要注意Erlang与CentOS的版本匹配，详细介绍见官网： https://www.rabbitmq.com/docs/which-erlang</span><br><span class="line"></span><br><span class="line">![image-20241013120828545](https://img.shiguangdev.cn/i/2024/10/13/670b47bc9a9df.png)</span><br><span class="line"></span><br><span class="line">如课程中RabbitMQ使用的是`v3.13.0`，erlang需要安装的版本需要 &gt;= 26.0</span><br><span class="line"></span><br><span class="line">由于`rabbitmq-server` 安装包支持CentOS7的版本较老，如 `v3.9.16`，兼容的erlang最低版本为23.3，最高24.3</span><br><span class="line"></span><br><span class="line">![image-20241013122208421](https://img.shiguangdev.cn/i/2024/10/13/670b4af04aeb2.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**通过RPM安装**</span><br><span class="line"></span><br><span class="line">可参考文章：[OpenCloudOS 8配置rabbitmq](https://blog.csdn.net/MeltryLL/article/details/141437375)</span><br><span class="line"></span><br><span class="line">下载地址：https://github.com/rabbitmq/erlang-rpm/releases</span><br><span class="line"></span><br><span class="line">我们需要下载与之相兼容的erlang版本如 [erlang-23.3-2.el7.x86_64.rpm](https://github.com/rabbitmq/erlang-rpm/releases/tag/v23.3)， el7 代表 CentOS 7</span><br><span class="line"></span><br><span class="line">GitHub仓库地址： https://github.com/rabbitmq/erlang-rpm/releases</span><br><span class="line"></span><br><span class="line">![image-20241013122538176](https://img.shiguangdev.cn/i/2024/10/13/670b4bc1f1519.png)</span><br><span class="line"></span><br><span class="line">将文件上传到CentOS的某个目录上，如`/opt/rabbitmq`</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> rpm -ivh erlang-23.3-2.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Erlang 版本，验证 Erlang 是否安装成功</span></span><br><span class="line"><span class="comment"># Erlang (SMP,ASYNC_THREADS,HIPE) (BEAM) emulator version 11.2</span></span><br><span class="line">erl -version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者用erl命令,其中OTP 23是我们安装的版本,erts-11.2是lib库依赖的版本</span></span><br><span class="line"><span class="comment">#Erlang/OTP 23 [erts-11.2] [source] [64-bit] [smp:4:4] [ds:4:4:10] [async-threads:1] [hipe]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Eshell V11.2  (abort with ^G)</span></span><br><span class="line">erl</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
</blockquote>
<p><strong>通过yum 安装</strong></p>
<blockquote>
<p>可参考文章： <a target="_blank" rel="noopener" href="https://blog.csdn.net/mumanquan1/article/details/122074059">CentOS 7 安装Erlang、RabbitMQ（亲测通过）</a></p>
</blockquote>
<p>Erlang安装包下载地址： <a target="_blank" rel="noopener" href="https://packagecloud.io/rabbitmq/erlang">https://packagecloud.io/rabbitmq/erlang</a> </p>
<p>选择与<code>rabbitmq-server</code> 相兼容的版本，如 <code>erlang-23.3.4.11-1.el7.x86_64.rpm</code>，el7 代表适用CentOS7</p>
<blockquote>
<p>若执行第一步出现如下错误</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | <span class="built_in">sudo</span> bash</span><br><span class="line">Detected operating system as centos/7.</span><br><span class="line">Checking <span class="keyword">for</span> curl...</span><br><span class="line">Detected curl...</span><br><span class="line">Downloading repository file: https://packagecloud.io/install/repositories/rabbitmq/erlang/config_file.repo?os=centos&amp;dist=7&amp;<span class="built_in">source</span>=script</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">Attempting to install pygpgme <span class="keyword">for</span> your os/dist: centos/7. Only required on older OSes to verify GPG signatures.</span><br><span class="line">Installing yum-utils...</span><br><span class="line">  File <span class="string">"/bin/yum"</span>, line 30</span><br><span class="line">    except KeyboardInterrupt, e:</span><br><span class="line">                            ^</span><br><span class="line">SyntaxError: invalid syntax</span><br><span class="line">Generating yum cache <span class="keyword">for</span> rabbitmq_erlang...</span><br><span class="line">  File <span class="string">"/bin/yum"</span>, line 30</span><br><span class="line">    except KeyboardInterrupt, e:</span><br><span class="line">                            ^</span><br><span class="line">SyntaxError: invalid syntax</span><br><span class="line">Generating yum cache <span class="keyword">for</span> rabbitmq_erlang-source...</span><br><span class="line">  File <span class="string">"/bin/yum"</span>, line 30</span><br><span class="line">    except KeyboardInterrupt, e:</span><br><span class="line">                            ^</span><br><span class="line">SyntaxError: invalid syntax</span><br><span class="line"></span><br><span class="line">The repository is setup! You can now install packages.</span><br></pre></td></tr></tbody></table></figure>

<p>检查Python版本</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# python --version</span><br><span class="line">Python 3.7.0</span><br></pre></td></tr></tbody></table></figure>

<p>若为3.x，执行如下命令创建软连接，使用python2执行</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -sf /usr/bin/python2 /usr/bin/python</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">步骤 1：安装了存储库</span></span><br><span class="line">curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">步骤 2：安装软件包</span></span><br><span class="line">sudo yum install -y erlang-23.3.4.11-1.el7.x86_64 </span><br></pre></td></tr></tbody></table></figure>

<p>若下载失败可到官网手动下载安装</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.erlang.org/downloads%EF%BC%8C%E4%BC%9A%E8%B7%B3%E8%BD%AC%E8%87%B3GitHub">https://www.erlang.org/downloads，会跳转至GitHub</a></p>
<p>GitHub: <a target="_blank" rel="noopener" href="https://github.com/erlang/otp/releases">https://github.com/erlang/otp/releases</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b546b5e5c4.png" alt="image-20241013130235515"></p>
<p>下载完成后，将文件上传到某个目录，如<code>/opt/rabbitmq</code>，通过以下代码完成安装</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 yum 包管理器安装 GCC 编译器，-y 选项表示自动回答 "yes" 以确认所有提示</span></span><br><span class="line">yum -y install gcc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 tar 命令解压 Erlang 源码包，-z 选项表示使用 gzip 解压，-x 选项表示解压，-v 选项表示显示详细信息，-f 选项指定文件名</span></span><br><span class="line">tar -zxvf otp_src_23.3.4.11.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入解压后的 Erlang 源码目录</span></span><br><span class="line"><span class="built_in">cd</span> /opt/rabbitmq/otp_src_23.3.4.11/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 configure 脚本，--prefix 选项指定 Erlang 的安装路径为 /usr/local/erlang</span></span><br><span class="line">./configure --prefix=/usr/local/erlang</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译并安装 Erlang，make install 会执行编译后的安装步骤</span></span><br><span class="line">make install</span><br></pre></td></tr></tbody></table></figure>

<p>查看是否安装成功以及设置环境变量</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出 /usr/local/erlang/bin 目录下的所有文件和目录，ll 是 <span class="built_in">ls</span> -l 的别名，显示详细信息</span></span><br><span class="line">ll /usr/local/erlang/bin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 Erlang 的 bin 目录添加到系统的 PATH 环境变量中，以便在终端中可以直接使用 Erlang 命令</span></span><br><span class="line">echo 'export PATH=$PATH:/usr/local/erlang/bin' &gt;&gt; /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载 /etc/profile 文件，使环境变量配置立即生效</span></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查 Erlang 版本，验证 Erlang 是否安装成功</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Erlang (SMP,ASYNC_THREADS,HIPE) (BEAM) emulator version 11.2.2.10</span></span><br><span class="line">erl -version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者用 erl 验证</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Erlang/OTP 23 [erts-11.2.2.10] [<span class="built_in">source</span>] [64-bit] [smp:4:4] [ds:4:4:10] [async-threads:1] <span class="comment">#[hipe]</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Eshell V11.2.2.10  (abort with ^G)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1&gt;</span></span><br><span class="line"></span><br><span class="line">erl</span><br></pre></td></tr></tbody></table></figure>



<blockquote>
<p>安装Erlang最新版会遇到的坑</p>
</blockquote>
<p>此处发现打印的是版本是 <code>14.2.5.4</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">erl -version</span><br><span class="line">Erlang (SMP,ASYNC_THREADS) (BEAM) emulator version 14.2.5.4</span><br></pre></td></tr></tbody></table></figure>

<p>使用 <code>erl</code>验证下，发现</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rabbitmq]# erl</span><br><span class="line">Erlang/OTP 26 [erts-14.2.5.4] [<span class="built_in">source</span>] [64-bit] [smp:4:4] [ds:4:4:10] [async-threads:1]</span><br><span class="line"></span><br><span class="line">Eshell V14.2.5.4 (press Ctrl+G to abort, <span class="built_in">type</span> <span class="built_in">help</span>(). <span class="keyword">for</span> <span class="built_in">help</span>)</span><br><span class="line">1&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>安装RabbitMQ时提示如下错误</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rabbitmq]# rpm -ivh rabbitmq-server-3.13.0-1.el8.noarch.rpm 错误：依赖检测失败：        erlang &gt;= 26.0 被 rabbitmq-server-3.13.0-1.el8.noarch 需要</span><br></pre></td></tr></tbody></table></figure>

<h3 id="安装RabbitMQ-2"><a href="#安装RabbitMQ-2" class="headerlink" title="安装RabbitMQ"></a><strong>安装RabbitMQ</strong></h3><h4 id="CentOS-8-1"><a href="#CentOS-8-1" class="headerlink" title="CentOS 8"></a>CentOS 8</h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入GPG密钥</span></span><br><span class="line">rpm --import 'https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc'</span><br><span class="line"></span><br><span class="line">rpm --import 'https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key'</span><br><span class="line"></span><br><span class="line">rpm --import 'https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载 RPM 包</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若下载失败多尝试几次或CentOS重启后重新尝试</span></span><br><span class="line">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.13.0/rabbitmq-server-3.13.0-1.el8.noarch.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line">rpm -ivh rabbitmq-server-3.13.0-1.el8.noarch.rpm</span><br></pre></td></tr></tbody></table></figure>

<h4 id="CentOS-7-1"><a href="#CentOS-7-1" class="headerlink" title="CentOS 7"></a>CentOS 7</h4><p>通过<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/release-information">Release Information | RabbitMQ</a>跳转到github下载界面</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-server/releases">https://github.com/rabbitmq/rabbitmq-server/releases</a></p>
<p>选择与<code>rabbitmq-server</code> 相兼容的版本，如  <a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.9.16">rabbitmq-server-3.9.16-1.el7.noarch.rpm</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670aa3dd08f44.png" alt="image-20241013002916641"></p>
<p>上传到CentOS某个目录，如 <code>/opt/rabbitmq</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">rpm -ivh rabbitmq-server-3.9.16-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示如下信息代表安装成功</span></span><br><span class="line"><span class="comment">#警告：rabbitmq-server-3.9.16-1.el7.noarch.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID 6026dfca: #NOKEY</span></span><br><span class="line"><span class="comment">#准备中...                          ################################# [100%]</span></span><br><span class="line"><span class="comment">#正在升级/安装...</span></span><br><span class="line"><span class="comment">#   1:rabbitmq-server-3.9.16-1.el7     ################################# [100%]</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="RabbitMQ基础配置"><a href="#RabbitMQ基础配置" class="headerlink" title="RabbitMQ基础配置"></a><strong>RabbitMQ基础配置</strong></h3><blockquote>
<p>启动服务前注意停用之前的Docker服务，以免造成端口冲突</p>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用管理界面插件</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 RabbitMQ 服务</span></span><br><span class="line">systemctl start rabbitmq-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 RabbitMQ 服务设置为开机自动启动</span></span><br><span class="line">systemctl enable rabbitmq-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增登录账号密码</span></span><br><span class="line">rabbitmqctl add_user shiguang 123456</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置登录账号权限</span></span><br><span class="line">rabbitmqctl set_user_tags shiguang administrator</span><br><span class="line">rabbitmqctl set_permissions -p / shiguang ".*" ".*" ".*"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置所有稳定功能 flag 启动</span></span><br><span class="line">rabbitmqctl enable_feature_flag all</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新启动 RabbitMQ服务</span></span><br><span class="line">systemctl restart rabbitmq-server</span><br></pre></td></tr></tbody></table></figure>

<h3 id="收尾工作"><a href="#收尾工作" class="headerlink" title="收尾工作"></a>收尾工作</h3><blockquote>
<p>若不删除该配置，以后用yum安装会受到该配置影响</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /etc/yum.repos.d/rabbitmq.repo</span><br></pre></td></tr></tbody></table></figure>

<h2 id="克隆-VMWare虚拟机"><a href="#克隆-VMWare虚拟机" class="headerlink" title="克隆 VMWare虚拟机"></a>克隆 VMWare虚拟机</h2><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>通过克隆操作，一共准备三台VMWare虚拟机</p>
<table>
<thead>
<tr>
<th>集群节点名称</th>
<th>虚拟机IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>node01</td>
<td>192.168.10.66</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.10.88</td>
</tr>
<tr>
<td>node03</td>
<td>192.168.10.99</td>
</tr>
</tbody></table>
<h3 id="克隆虚拟机"><a href="#克隆虚拟机" class="headerlink" title="克隆虚拟机"></a>克隆虚拟机</h3><p>需克隆完整连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b59e4277f9.png" alt="image-20241013132556306"></p>
<p>如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b5a0a12674.png" alt="image-20241013132634295"></p>
<h3 id="给新机器设置IP地址"><a href="#给新机器设置IP地址" class="headerlink" title="给新机器设置IP地址"></a>给新机器设置IP地址</h3><p>在CentOS 7 中，可以使用<code>nmcli</code>命令行工具修改IP地址。以下是具体步骤：</p>
<p>1、查看网络连接信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli con show </span><br></pre></td></tr></tbody></table></figure>

<p>2、停止指定的网络连接（将 <connection_name>替换为实际的网络连接名称）：</connection_name></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli con down &lt;connection_name&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>3、修改IP地址（将 <connection_name>替换为实际的网络连接名称，将 <new_ip_address>替换为新的IP地址，将<subnet_mask>替换为子网掩码，将&lt;gateway&gt;替换为网关）</subnet_mask></new_ip_address></connection_name></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;new_ip_address&gt;/&lt;subnet_mask&gt;这里是 CIDR 表示法</span></span><br><span class="line">nmcli con mod &lt;connection_name&gt; ipv4.addresses &lt;new_ip_address&gt;/&lt;subnet_mask&gt;</span><br><span class="line">nmcli con mod &lt;connection_name&gt; ipv4.gateway &lt;gateway&gt;</span><br><span class="line">nmcli con mod &lt;connection_name&gt; ipv4.method manual <span class="comment"># 手动</span></span><br></pre></td></tr></tbody></table></figure>

<p>4、启动网络连接</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli con up &lt;connection_name&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>5、验证新的IP地址是否生效：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr show</span><br></pre></td></tr></tbody></table></figure>

<h3 id="修改主机名称"><a href="#修改主机名称" class="headerlink" title="修改主机名称"></a>修改主机名称</h3><p>主机名称会被RabbitMQ作为集群中的节点名称，后面会用到，所以需要设置一下。<br>修改后需重启</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前系统名称</span></span><br><span class="line"><span class="built_in">cat</span> /etc/hostname</span><br><span class="line"><span class="comment"># 修改当前系统名称</span></span><br><span class="line">vim /etc/hostname</span><br></pre></td></tr></tbody></table></figure>

<h3 id="保险措施"><a href="#保险措施" class="headerlink" title="保险措施"></a>保险措施</h3><p>为了在后续操作过程中，万一遇到操作失误，友情建议拍摄快照。</p>
<h2 id="集群节点彼此发现"><a href="#集群节点彼此发现" class="headerlink" title="集群节点彼此发现"></a>集群节点彼此发现</h2><h3 id="node01设置"><a href="#node01设置" class="headerlink" title="node01设置"></a>node01设置</h3><p>① 设置IP地址到主机名称的映射</p>
<p>修改文件<code>/etc/hosts</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></tbody></table></figure>

<p>追加如下内容：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.10.66 node01</span><br><span class="line">192.168.10.88 node02</span><br><span class="line">192.168.10.99 node03</span><br></pre></td></tr></tbody></table></figure>

<p>② 查看当前RabbitMQ节点的Cookie值并记录</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/lib/rabbitmq/.erlang.cookie</span><br></pre></td></tr></tbody></table></figure>

<p>显示如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# <span class="built_in">cat</span> /var/lib/rabbitmq/.erlang.cookie</span><br><span class="line">KFGJAHXELTVBZJVTEHSG[root@node01 ~]#</span><br></pre></td></tr></tbody></table></figure>

<p>③ 重置节点应用</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>

<h3 id="node02设置"><a href="#node02设置" class="headerlink" title="node02设置"></a>node02设置</h3><p>① 设置P地址到主机名称的映射</p>
<p>修改文件<code>/etc/hosts</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></tbody></table></figure>

<p>追加如下内容：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.10.66 node01</span><br><span class="line">192.168.10.88 node02</span><br><span class="line">192.168.10.99 node03</span><br></pre></td></tr></tbody></table></figure>

<p>② 修改当前RabbitMQ节点的Cookie值<br>node02和node03都改成和node01一样：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/rabbitmq/.erlang.cookie</span><br></pre></td></tr></tbody></table></figure>

<p>③ 重置节点应用并加入集群</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@node01</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>

<h3 id="node03设置"><a href="#node03设置" class="headerlink" title="node03设置"></a>node03设置</h3><p>① 设置P地址到主机名称的映射</p>
<p>修改文件<code>/etc/hosts</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></tbody></table></figure>

<p>追加如下内容：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.10.66 node01</span><br><span class="line">192.168.10.88 node02</span><br><span class="line">192.168.10.99 node03</span><br></pre></td></tr></tbody></table></figure>

<p>② 修改当前RabbitMQ节点的Cookie值<br>node02和node03都改成和node01一样：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/rabbitmq/.erlang.cookie</span><br></pre></td></tr></tbody></table></figure>

<p>③ 重置节点应用并加入集群</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@node01</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>

<p>④ 查看集群状态</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></tbody></table></figure>

<p>显示如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# rabbitmqctl cluster_status</span><br><span class="line">Cluster status of node rabbit@node01 ...</span><br><span class="line">Basics</span><br><span class="line"></span><br><span class="line">Cluster name: rabbit@node01</span><br><span class="line"></span><br><span class="line">Disk Nodes</span><br><span class="line"></span><br><span class="line">rabbit@node01</span><br><span class="line">rabbit@node02</span><br><span class="line">rabbit@node03</span><br><span class="line"></span><br><span class="line">Running Nodes</span><br><span class="line"></span><br><span class="line">rabbit@node01</span><br><span class="line">rabbit@node02</span><br><span class="line">rabbit@node03</span><br><span class="line"></span><br><span class="line">Versions</span><br><span class="line"></span><br><span class="line">rabbit@node01: RabbitMQ 3.9.16 on Erlang 23.3</span><br><span class="line">rabbit@node02: RabbitMQ 3.9.16 on Erlang 23.3.4.11</span><br><span class="line">rabbit@node03: RabbitMQ 3.9.16 on Erlang 23.3.4.11</span><br><span class="line"></span><br><span class="line">Maintenance status</span><br><span class="line"></span><br><span class="line">Node: rabbit@node01, status: not under maintenance</span><br><span class="line">Node: rabbit@node02, status: not under maintenance</span><br><span class="line">Node: rabbit@node03, status: not under maintenance</span><br><span class="line"></span><br><span class="line">Alarms</span><br><span class="line"></span><br><span class="line">(none)</span><br><span class="line"></span><br><span class="line">Network Partitions</span><br><span class="line"></span><br><span class="line">(none)</span><br><span class="line"></span><br><span class="line">Listeners</span><br><span class="line"></span><br><span class="line">Node: rabbit@node01, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication</span><br><span class="line">Node: rabbit@node01, interface: [::], port: 15672, protocol: http, purpose: HTTP API</span><br><span class="line">Node: rabbit@node01, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0</span><br><span class="line">Node: rabbit@node02, interface: [::], port: 15672, protocol: http, purpose: HTTP API</span><br><span class="line">Node: rabbit@node02, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication</span><br><span class="line">Node: rabbit@node02, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0</span><br><span class="line">Node: rabbit@node03, interface: [::], port: 15672, protocol: http, purpose: HTTP API</span><br><span class="line">Node: rabbit@node03, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication</span><br><span class="line">Node: rabbit@node03, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0</span><br><span class="line"></span><br><span class="line">Feature flags</span><br><span class="line"></span><br><span class="line">Flag: drop_unroutable_metric, state: enabled</span><br><span class="line">Flag: empty_basic_get_metric, state: enabled</span><br><span class="line">Flag: implicit_default_bindings, state: enabled</span><br><span class="line">Flag: maintenance_mode_status, state: enabled</span><br><span class="line">Flag: quorum_queue, state: enabled</span><br><span class="line">Flag: stream_queue, state: enabled</span><br><span class="line">Flag: user_limits, state: enabled</span><br><span class="line">Flag: virtual_host_metadata, state: enabled</span><br></pre></td></tr></tbody></table></figure>

<p>也可登录管理后台查看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b7236e8402.png" alt="image-20241013150943009"></p>
<h2 id="负载均衡：Management-UI"><a href="#负载均衡：Management-UI" class="headerlink" title="负载均衡：Management UI"></a>负载均衡：Management UI</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>两个需要暴露的端口：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b72b46ef57.png" alt="image-20241013151148707"></p>
<p>目前集群方案：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b72f26a90b.png" alt="image-20241013151250667"></p>
<p>管理界面负载均衡：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b733a7ea3f.png" alt="image-20241013151402696"></p>
<p>核心功能负载均衡：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b7370b02e3.png" alt="image-20241013151456881"></p>
<h3 id="安装HAProxy"><a href="#安装HAProxy" class="headerlink" title="安装HAProxy"></a>安装HAProxy</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install -y haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否安装成功</span></span><br><span class="line">haproxy -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机自启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br></pre></td></tr></tbody></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><blockquote>
<p>配置文件位置：/etc/haproxy/haproxy.cfg</p>
</blockquote>
<p>在配置文件未尾增加如下内容：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">frontend rabbitmq_ui_frontend</span><br><span class="line"><span class="built_in">bind</span> 192.168.10.66:22222</span><br><span class="line">mode http</span><br><span class="line">default_backend rabbitmq_ui_backend</span><br><span class="line"></span><br><span class="line">backend rabbitmq_ui_backend</span><br><span class="line">mode http</span><br><span class="line">balance roundrobin</span><br><span class="line">option httpchk GET /</span><br><span class="line">server rabbitmq_ui1 192.168.10.66:15672 check</span><br><span class="line">server rabbitmq_ui2 192.168.10.88:15672 check</span><br><span class="line">server rabbitmq_ui3 192.168.10.99:15672 check</span><br></pre></td></tr></tbody></table></figure>

<p>设置SELinux策略，允许HAProxy拥有权限连接任意端口：</p>
<blockquote>
<p>SELinux是Linux系统中的安全模块，它可以限制进程的权限以提高系统的安全性。在某些情况下，SELinux可能会阻止HAProxy绑定指定的端口，这就需要通过设置域(domain)的安全策略来解决此问题。</p>
<p>通过执行setsebool-P haproxy_connect_any=1命令，您已经为HAProxyi设置了一个布尔值，允许HAProxy连接到任意端口。这样，HAProxy就可以成功绑定指定的socket,并正常工作。</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setsebool -P haproxy_connect_any=1</span><br></pre></td></tr></tbody></table></figure>


<p>重启HAProxy</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h3><p>访问配置的前台负载均衡地址： <a target="_blank" rel="noopener" href="http://192.168.10.66:22222/">http://192.168.10.66:22222</a></p>
<p>查看是否可以正常打开rabbitmq管理端界面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b793069de5.png" alt="image-20241013153928411"></p>
<h2 id="负载均衡：核心功能"><a href="#负载均衡：核心功能" class="headerlink" title="负载均衡：核心功能"></a>负载均衡：核心功能</h2><h3 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h3><blockquote>
<p>配置文件位置：/etc/haproxy/haproxy.cfg</p>
</blockquote>
<p>在配置文件未尾增加如下内容：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend rabbitmq_frontend</span><br><span class="line"><span class="built_in">bind</span> 192.168.10.66:11111</span><br><span class="line">mode tcp</span><br><span class="line">default_backend rabbitmq_backend</span><br><span class="line"></span><br><span class="line">backend rabbitmq_backend</span><br><span class="line">mode tcp</span><br><span class="line">balance roundrobin</span><br><span class="line">server rabbitmq1 192.168.10.66:5672 check</span><br><span class="line">server rabbitmq2 192.168.10.88:5672 check</span><br><span class="line">server rabbitmq3 192.168.10.99:5672 check</span><br></pre></td></tr></tbody></table></figure>

<p>重启HAProxy</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br></pre></td></tr></tbody></table></figure>

<h3 id="测试-6"><a href="#测试-6" class="headerlink" title="测试"></a>测试</h3><h4 id="创建组件"><a href="#创建组件" class="headerlink" title="创建组件"></a><strong>创建组件</strong></h4><ul>
<li>交换机：exchange.cluster.test</li>
<li>队列；queue.cluster.test</li>
<li>路由键：routing.key.cluster.test</li>
</ul>
<h4 id="创建生产者端程序"><a href="#创建生产者端程序" class="headerlink" title="创建生产者端程序"></a><strong>创建生产者端程序</strong></h4><p><strong>1、POM</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.shiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>module08-cluster-producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>2、核心配置文件</strong></p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">11111</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">shiguang</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span> <span class="comment">#交换机的确认</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment">#队列的确认</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.shiguang.mq.config.MQProducerAckConfig:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>3、配置类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/13 16:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerAckConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnsCallback {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> {</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息发送到交换机成功或失败时调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData 用于关联消息的唯一标识符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack             表示消息是否被成功确认</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause           如果消息确认失败，这里会包含失败的原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> {</span><br><span class="line">        <span class="keyword">if</span> (ack) {</span><br><span class="line">            log.info(<span class="string">"消息发送到交换机成功！数据: "</span> + correlationData);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            log.info(<span class="string">"消息发送到交换机失败！ 数据: "</span> + correlationData + <span class="string">" 错误原因: "</span> + cause);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当消息无法路由到队列时调用这个方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> returnedMessage 包含无法路由的消息的详细信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returnedMessage)</span> {</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 消息主体: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(returnedMessage.getMessage().getBody()));</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 应答码: "</span> + returnedMessage.getReplyCode());</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 描述: "</span> + returnedMessage.getReplyText());</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 消息使用的交换器 exchange: "</span> + returnedMessage.getExchange());</span><br><span class="line">        log.info(<span class="string">"returnedMessage() 回调函数 消息使用的路由键 routing: "</span> + returnedMessage.getRoutingKey());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>4、启动类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>5、测试类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 20:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_CLUSTER_TEST</span> <span class="operator">=</span> <span class="string">"exchange.cluster.test"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_CLUSTER_TEST</span> <span class="operator">=</span> <span class="string">"routing.key.cluster.test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Test Send Message By Cluster !!"</span>;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_CLUSTER_TEST, ROUTING_KEY_CLUSTER_TEST, message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4 id="创建消费者端程序"><a href="#创建消费者端程序" class="headerlink" title="创建消费者端程序"></a>创建消费者端程序</h4><p><strong>1、POM</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.chiguang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>module09-cluster-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- springboot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>2、核心配置文件</strong></p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.10</span><span class="number">.66</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">11111</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">shiguang</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#手动确认</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.shiguang.mq.config.MQProducerAckConfig:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>3、Listener</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_CLUSTER</span> <span class="operator">=</span> <span class="string">"queue.cluster.test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {QUEUE_CLUSTER})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPriorityMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        log.info(<span class="string">"[消费者端] 消息内容: "</span> + dataString);</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>4、启动类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiguang.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created By Shiguang On 2024/10/11 16:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConsumerMainType</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQConsumerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b883067356.png" alt="image-20241013164328717"></p>
<h2 id="镜像队列"><a href="#镜像队列" class="headerlink" title="镜像队列"></a>镜像队列</h2><blockquote>
<p>镜像队列在新版本中已被仲裁队列取代，这里不再介绍</p>
</blockquote>
<h2 id="仲裁队列"><a href="#仲裁队列" class="headerlink" title="仲裁队列"></a>仲裁队列</h2><p>RabbitMQ3.8.x版本的主要更新内容，未来有可能取代Classic Queue</p>
<p>创建仲裁队列，可以将队列同步到集群中的每个节点上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b895fe4c73.png" alt="image-20241013164832214"></p>
<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><h4 id="创建仲裁队列"><a href="#创建仲裁队列" class="headerlink" title="创建仲裁队列"></a>创建仲裁队列</h4><blockquote>
<p>需要在集群的基础上创建</p>
</blockquote>
<p><strong>1、创建交换机</strong></p>
<p>和仲裁队列绑定的交换机没有特殊要求，我们还是创建一个direct交换机即可<br>交换机名称：exchange.quorum.test</p>
<p><strong>2、创建仲裁队列</strong></p>
<p>队列名称：queue.quorum.test</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8a9e7fddc.png" alt="image-20241013165350867"></p>
<p>创建好后如图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8af5cbc51.png" alt="image-20241013165518171"></p>
<p>详情信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8b10c7469.png" alt="image-20241013165545104"></p>
<p>3、绑定交换机</p>
<p>路由键：routing.key.quorum.test</p>
<h4 id="测试-7"><a href="#测试-7" class="headerlink" title="测试"></a>测试</h4><h5 id="常规测试"><a href="#常规测试" class="headerlink" title="常规测试"></a>常规测试</h5><p>像使用经典队列一样发送消息、消费消息</p>
<p><strong>① 生产者端</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_QUORUM_TEST</span> <span class="operator">=</span> <span class="string">"exchange.quorum.test"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_QUORUM_TEST</span> <span class="operator">=</span> <span class="string">"routing.key.quorum.test"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageToQuorum</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"Test Send Message By Quorum!!"</span>;</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_QUORUM_TEST, ROUTING_KEY_QUORUM_TEST, message);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>日志输出情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8cc33938f.png" alt="image-20241013170259621"></p>
<p>队列情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8ca0d734a.png" alt="image-20241013170225207"></p>
<p><strong>② 消费者端</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_QUORUM_TEST</span> <span class="operator">=</span> <span class="string">"queue.quorum.test"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_QUORUM_TEST})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processQuorumMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    log.info(<span class="string">"[消费者端] 消息内容: "</span> + dataString);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>日志输出情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8dbf5bb45.png" alt="image-20241013170711764"></p>
<p>队列情况：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8dd82bbb1.png" alt="image-20241013170736519"></p>
<h5 id="高可用测试"><a href="#高可用测试" class="headerlink" title="高可用测试"></a>高可用测试</h5><p>① 停止某个节点的rabbit应用</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止rabbit应用</span></span><br><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></tbody></table></figure>

<p>此时可以再观察下队列详情，可以发现已自动选举出新的Leader</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8e8f41fb3.png" alt="image-20241013171039544"></p>
<p>② 再次发送消息</p>
<p>修改发送消息的内容，以区分之前发送的消息，消费者端能够正常消费</p>
<p>控制台有报错是因为有节点下线，属于正常情况</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8f48b9a4b.png" alt="image-20241013171344976"></p>
<h2 id="流式队列"><a href="#流式队列" class="headerlink" title="流式队列"></a>流式队列</h2><p>RabbitMQ在 3.9.x 推出的新特性</p>
<p><strong>工作机制</strong>：</p>
<p>在一个仅追加的日志文件内保存所发送的消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8fdf3b1e5.png" alt="image-20241013171615604"></p>
<p>给每个消息都分配个偏移页，即使消息被消费端消费掉，消息依然保存在日志文件中，可重复消费</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670b8ff637f5a.png" alt="image-20241013171638560"></p>
<p><strong>总体评价</strong></p>
<ul>
<li>从客户端支持角度来说，生态尚不健全</li>
<li>从使用习惯角度来说，和原有队列用法不完全兼容</li>
<li>从竞品角度来说，<strong>像Kafka，但远远比不上Kafka</strong></li>
<li>从应用场景角度来说：<ul>
<li>经典队列：适用于系统内部异步通信场景</li>
<li>流式队列：适用于系统间跨平台、大流量、实时计算场景(Kafka主场)</li>
</ul>
</li>
<li>使用建议：Stream队列在目前企业实际应用非常少，真有特定场景需要使用肯定会倾向于使用Kafka,而不是RabbitMQ Stream</li>
<li>未来展望：Classic Queue已经有和Quorum Queue合二为一的趋势,Stream也有加入进来整合成一种队列的趋势，但Stream内部机制决定这很难</li>
</ul>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><h4 id="启用插件-1"><a href="#启用插件-1" class="headerlink" title="启用插件"></a>启用插件</h4><blockquote>
<p>说明：只有启用了Stream插件，才能使用流式队列的完整功能</p>
</blockquote>
<p>在集群每个节点中依次执行如下操作：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用Stream插件</span></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_stream </span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启rabbit应用</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看插件状态</span></span><br><span class="line">rabbitmq-plugins list</span><br></pre></td></tr></tbody></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bb9061efb6.png" alt="image-20241013201150462"></p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><blockquote>
<p>配置文件位置：/etc/haproxy/haproxy.cfg</p>
</blockquote>
<p>在配置文件未尾增加如下内容：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend rabbitmq_stream_frontend</span><br><span class="line"><span class="built_in">bind</span> 192.168.10.66:33333</span><br><span class="line">mode tcp</span><br><span class="line">default_backend rabbitmq_stream_backend</span><br><span class="line"></span><br><span class="line">backend rabbitmq_stream_backend</span><br><span class="line">mode tcp</span><br><span class="line">balance roundrobin</span><br><span class="line">server rabbitmq1 192.168.10.66:5552 check</span><br><span class="line">server rabbitmq2 192.168.10.88:5552 check</span><br><span class="line">server rabbitmq3 192.168.10.99:5552 check</span><br></pre></td></tr></tbody></table></figure>

<p>重启HAProxy</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br></pre></td></tr></tbody></table></figure>

<h4 id="JAVA代码"><a href="#JAVA代码" class="headerlink" title="JAVA代码"></a>JAVA代码</h4><p>Stream专属Java客户端官方网址：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-stream-java-client">https://github.com/rabbitmq/rabbitmq-stream-java-client</a><br>Stream专属Java客户端官方文档网址：<a target="_blank" rel="noopener" href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/">https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/</a></p>
<h5 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>stream-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="创建Stream"><a href="#创建Stream" class="headerlink" title="创建Stream"></a>创建Stream</h5><blockquote>
<p>不需要创建交换机</p>
</blockquote>
<p><strong>① 代码方式创建</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">    .host(<span class="string">"192.168.10.66"</span>)</span><br><span class="line">    .port(<span class="number">33333</span>)</span><br><span class="line">    .username(<span class="string">"shiguang"</span>)</span><br><span class="line">    .password(<span class="string">"123456"</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">environment.streamCreator().stream(<span class="string">"stream.shiguang.test"</span>).create();</span><br></pre></td></tr></tbody></table></figure>



<p><strong>② ManagementUlt创建</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bbce107546.png" alt="image-20241013202817496"></p>
<h5 id="生产端程序"><a href="#生产端程序" class="headerlink" title="生产端程序"></a>生产端程序</h5><p><strong>① 内部机制说明</strong><br>[1] 官方文档</p>
<blockquote>
<p>Internally，the Environment will query the broker to find out about the topology of the stream and will create or re-use a connection to publish to the leader node of the stream.</p>
</blockquote>
<p>翻译：</p>
<blockquote>
<p>在内部，Environment将查问brokerl以了解流的拓扑结构，并将创建或重用连接以发布到流的leader节点。</p>
</blockquote>
<p>[2] 解析</p>
<ul>
<li>在Environment中封装的连接信息仅负责连接到 broker</li>
<li>Producer在构建对象时会访问broker拉取集群中 Leader 的连接信息</li>
<li>将来实际访问的是集群中的 Leader 节点</li>
<li>Leader的连接信息格式是：节点名称:端口号</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bbe344e090.png" alt="image-20241013203356647"></p>
<p>[3] 配置</p>
<blockquote>
<p>文件位置： C:\Windows\System32\drivers\etc</p>
</blockquote>
<p>为了让本机的应用程序知道Leader节点名称对应的IP地址，我们需要在<strong>本地</strong>配置hosts文件，建立从节点名称到P地址的映射关系</p>
<figure class="highlight tex"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">#</span> rabbitmq 测试</span><br><span class="line">192.168.10.66 node01</span><br><span class="line">192.168.10.88 node02</span><br><span class="line">192.168.10.99 node03</span><br></pre></td></tr></tbody></table></figure>



<p><strong>② 示例代码</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">    .host(<span class="string">"192.168.10.66"</span>)</span><br><span class="line">    .port(<span class="number">33333</span>)</span><br><span class="line">    .username(<span class="string">"shiguang"</span>)</span><br><span class="line">    .password(<span class="string">"123456"</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> environment.producerBuilder()</span><br><span class="line">    .stream(<span class="string">"stream.shiguang.test"</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] messagePayload = <span class="string">"hello rabbit stream"</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">producer.send(</span><br><span class="line">    producer.messageBuilder().addData(messagePayload).build(),</span><br><span class="line">    confirmationStatus -&gt; {</span><br><span class="line">        <span class="keyword">if</span> (confirmationStatus.isConfirmed()) {</span><br><span class="line">            System.out.println(<span class="string">"[生产者端]the message made it to the broker"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.println(<span class="string">"[生产者端]the message did not make it to the broker"</span>);</span><br><span class="line">        }</span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">    });</span><br><span class="line">countDownLatch.await();</span><br><span class="line">producer.close();</span><br><span class="line">environment.close();</span><br></pre></td></tr></tbody></table></figure>

<h5 id="消费端程序"><a href="#消费端程序" class="headerlink" title="消费端程序"></a>消费端程序</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">    .host(<span class="string">"192.168.10.66"</span>)</span><br><span class="line">    .port(<span class="number">33333</span>)</span><br><span class="line">    .username(<span class="string">"shiguang"</span>)</span><br><span class="line">    .password(<span class="string">"123456"</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">environment.consumerBuilder()</span><br><span class="line">    .stream(<span class="string">"stream.shiguang.test"</span>)</span><br><span class="line">    .name(<span class="string">"stream.shiguang.test.consumer"</span>)</span><br><span class="line">    .autoTrackingStrategy()</span><br><span class="line">    .builder()</span><br><span class="line">    .messageHandler((offset, message) -&gt; {</span><br><span class="line">        <span class="type">byte</span>[] bodyAsBinary = message.getBodyAsBinary();</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bodyAsBinary);</span><br><span class="line">        System.out.println(<span class="string">"[消费者] messagecontent = "</span> + messageContent + <span class="string">" offset = "</span> + offset.offset());</span><br><span class="line">    })</span><br><span class="line">    .build();</span><br></pre></td></tr></tbody></table></figure>

<h4 id="指定偏移量消费"><a href="#指定偏移量消费" class="headerlink" title="指定偏移量消费"></a>指定偏移量消费</h4><h5 id="偏移量"><a href="#偏移量" class="headerlink" title="偏移量"></a>偏移量</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bc8395c066.png" alt="image-20241013211641886"></p>
<h5 id="官网文档说明"><a href="#官网文档说明" class="headerlink" title="官网文档说明"></a>官网文档说明</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bc85c7e1d5.png" alt="image-20241013211716855"></p>
<h5 id="指定Offset消费"><a href="#指定Offset消费" class="headerlink" title="指定Offset消费"></a>指定Offset消费</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">    .host(<span class="string">"192.168.10.66"</span>)</span><br><span class="line">    .port(<span class="number">33333</span>)</span><br><span class="line">    .username(<span class="string">"shiguang"</span>)</span><br><span class="line">    .password(<span class="string">"123456"</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> environment.consumerBuilder()</span><br><span class="line">    .stream(<span class="string">"stream.shiguang.test"</span>)</span><br><span class="line">    .offset(OffsetSpecification.first())</span><br><span class="line">    .messageHandler((offset, message) -&gt; {</span><br><span class="line">        <span class="type">byte</span>[] bodyAsBinary = message.getBodyAsBinary();</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bodyAsBinary);</span><br><span class="line">        System.out.println(<span class="string">"[消费者端] messagecontent = "</span> + messageContent);</span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">    })</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">countDownLatch.await();</span><br><span class="line">consumer.close();</span><br></pre></td></tr></tbody></table></figure>

<h5 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h5><ul>
<li>autoTrackingStrategy方式：始终监听Stream中的新消息（狗狗看家，忠于职守）</li>
<li>指定偏移量方式：针对指定偏移量的消息消费之后就停止（狗狗叼飞盘，叼回来就完）</li>
</ul>
<h1 id="Federation插件"><a href="#Federation插件" class="headerlink" title="Federation插件"></a>Federation插件</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Federation插件的设计目标是使RabbitMQ在不同的Broker节点之间进行消息传送而无须建立集群。</p>
<p>它可以在不同的管理域中的Broker或集群间传递消息，这些管理域可能设置了不同的用户和vhost,也可能运行在不同版本的RabbitMQ和Erang上，Federation基于AMOP 0-9-1协议在不同的Broker之间进行通信。并且设计成能够密忍不稳定的网络连接情况。</p>
<h2 id="Federation交换机"><a href="#Federation交换机" class="headerlink" title="Federation交换机"></a>Federation交换机</h2><h3 id="总体说明"><a href="#总体说明" class="headerlink" title="总体说明"></a>总体说明</h3><ul>
<li>各节点操作：启用联邦插件</li>
<li>下游操作：<ul>
<li>添加上游连接端点</li>
<li>创建控制策略</li>
</ul>
</li>
</ul>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>为了执行相关测试，我们使用Dockert创建两个RabbitMQ实例。<br><strong>特别提示</strong>：由于Federation机制的最大特点就是跨集群同步数据，所以这两个Docker容器中的RabbitMQ实例不加入集群！！！是两个<strong>独立的broker实例</strong>。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上游</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq-shenzhen \</span><br><span class="line">-p 51000:5672 \</span><br><span class="line">-p 52000:15672 \</span><br><span class="line">-v rabbitmq-plugin:/plugins \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=guest \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line">rabbitmq:3.13-management</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下游</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq-shanghai \</span><br><span class="line">-p 61000:5672 \</span><br><span class="line">-p 62000:15672 \</span><br><span class="line">-v rabbitmq-plugin:/plugins \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=guest \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line">rabbitmq:3.13-management</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启用联邦插件"><a href="#启用联邦插件" class="headerlink" title="启用联邦插件"></a>启用联邦插件</h3><p>在上游、下游节点中都需要开启。<br>Docker容器中的RabbitMQ已经开启了rabbitmq_federation,还需要开启rabbitmq_federation_management</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用以下命令进入 RabbitMQ 容器的 shell</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;container_name&gt; /bin/bash</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_federation</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_federation_management</span><br></pre></td></tr></tbody></table></figure>

<p>rabbitmq_federation_management插件启用后会在Management Ul的Admin选项卡下看到：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bd81692b37.png" alt="image-20241013222423034"></p>
<h3 id="添加上游连接端点"><a href="#添加上游连接端点" class="headerlink" title="添加上游连接端点"></a>添加上游连接端点</h3><p>在下游节点填写上游节点的连接信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name</span></span><br><span class="line">shiguang.upstream</span><br><span class="line"><span class="comment"># URI</span></span><br><span class="line">amqp://guest:[redacted]@192.168.10.66:51000</span><br></pre></td></tr></tbody></table></figure>



<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bd8c2cc5b2.png" alt="image-20241013222715218"></p>
<h3 id="创建控制策略"><a href="#创建控制策略" class="headerlink" title="创建控制策略"></a>创建控制策略</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bd963385ee.png" alt="image-20241013222955450"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bd9433b9e8.png" alt="image-20241013222923676"></p>
<p>详细配置如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name</span></span><br><span class="line">police.federation.exchange</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pattern</span></span><br><span class="line">^federated\.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply to</span></span><br><span class="line">Exchanges</span><br><span class="line"></span><br><span class="line"><span class="comment"># Priority</span></span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Definition</span></span><br><span class="line">federation-upstream = shiguang.upstream</span><br></pre></td></tr></tbody></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bdcd98f54c.png" alt="image-20241013224442084"></p>
<h3 id="测试-8"><a href="#测试-8" class="headerlink" title="测试"></a>测试</h3><p><strong>① 测试计划</strong><br><strong>特别提示</strong>：</p>
<ul>
<li>普通交换机和联邦交换机名称要一致</li>
<li>交换机名称要能够和策略正则表达式匹配上</li>
<li>发送消息时，两边使用的路由键也要一致</li>
<li>队列名称不要求一致</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bdaafd9145.png" alt="image-20241013223528412"></p>
<p><strong>② 创建组件</strong></p>
<table>
<thead>
<tr>
<th>所在机房</th>
<th>交换机名称</th>
<th>路由键</th>
<th>队列名称</th>
</tr>
</thead>
<tbody><tr>
<td>深圳机房（上游）</td>
<td>federated.exchange.demo</td>
<td>routing.key.demo.test</td>
<td>queue.normal.shenzhen</td>
</tr>
<tr>
<td>上海机房（下游）</td>
<td>federated.exchange.demo</td>
<td>routing.key.demo.test</td>
<td>queue.normal.shanghai</td>
</tr>
</tbody></table>
<p>创建组件后可以查看一下联邦状态，连接成功的联邦状态如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bdd054c145.png" alt="image-20241013224525828"></p>
<p>③ 发布消息执行测试</p>
<p>在上游节点向交换机发布消息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bdd6df06ef.png" alt="image-20241013224710446"></p>
<p>下游两个队列消息总量均变成了1</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bdda746017.png" alt="image-20241013224807815"></p>
<h2 id="Federation队列"><a href="#Federation队列" class="headerlink" title="Federation队列"></a>Federation队列</h2><h3 id="总体说明-1"><a href="#总体说明-1" class="headerlink" title="总体说明"></a>总体说明</h3><p>Federation队列和Federation交换机的最核心区别就是：</p>
<ul>
<li>Federation Police作用在交换机上，就是Federation交换机</li>
<li>Federation Police作用在队列上，就是Federation队列</li>
</ul>
<h3 id="创建控制策略-1"><a href="#创建控制策略-1" class="headerlink" title="创建控制策略"></a>创建控制策略</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bde11003d4.png" alt="image-20241013224953436"></p>
<p>详细配置如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name</span></span><br><span class="line">police.federation.queue</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pattern</span></span><br><span class="line">^fed\.queue\.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply to</span></span><br><span class="line">Queues</span><br><span class="line"></span><br><span class="line"><span class="comment"># Priority</span></span><br><span class="line">10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Definition</span></span><br><span class="line">federation-upstream = shiguang.upstream</span><br></pre></td></tr></tbody></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bdf0212196.png" alt="image-20241013225354586"></p>
<h3 id="测试-9"><a href="#测试-9" class="headerlink" title="测试"></a>测试</h3><p><strong>① 测试计划</strong><br>上游节点和下游节点中队列名称是相同的，只是下游队列中的节点附加了联邦策略而已</p>
<table>
<thead>
<tr>
<th>所在机房</th>
<th>交换机名称</th>
<th>路由键</th>
<th>队列名称</th>
</tr>
</thead>
<tbody><tr>
<td>深圳机房（上游）</td>
<td>exchange.normal.shenzhen</td>
<td>routing.key.normal.shenzhen</td>
<td>fed.queue.demo</td>
</tr>
<tr>
<td>上海机房（下游）</td>
<td>——</td>
<td>——</td>
<td>fed.queue.demo</td>
</tr>
</tbody></table>
<p><strong>② 创建组件</strong><br>上游节点都是常规操作，此处省略。重点需要关注的是下游节点的联邦队列创建时需要指定相关参数：<br>创建组件后可以查看一下联邦状态，连接成功的联邦状态如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670be3c863697.png" alt="image-20241013231417003"></p>
<p><strong>③ 执行测试</strong><br>在上游节点向交换机发布消息：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670be424d1e9e.png" alt="image-20241013231549413"></p>
<p>但此时发现下游节点中联邦队列并没有接收到消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670be46aa74b7.png" alt="image-20241013231659313"></p>
<p>这是为什么呢？这里就体现出了联邦队列和联邦交换机工作逻辑的区别。<br>对联邦队列来说，如果没有监响联队列的消费端程序，它是不会到上游去拉取消息的！<br>如果有消费端监听联邦队列，那么首先消费联邦队列自身的消息；<strong>如果联邦队列为空，这时候才会到上游队列节点中拉取消息。</strong><br>所以现在的测试效果需要消费端程序配合才能看到：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670be72d370db.png" alt="image-20241013232845847"></p>
<h1 id="Shovel插件"><a href="#Shovel插件" class="headerlink" title="Shovel插件"></a>Shovel插件</h1><blockquote>
<p>Shovel 是铲子的意思，把消息铲走，从源节点移至目标节点，源节点将收不到消息</p>
</blockquote>
<h2 id="启用Shovel插件"><a href="#启用Shovel插件" class="headerlink" title="启用Shovel插件"></a>启用Shovel插件</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用以下命令进入 RabbitMQ 容器的 shell</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;container_name&gt; /bin/bash</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_shovel</span><br><span class="line"></span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_shovel_management</span><br></pre></td></tr></tbody></table></figure>

<p>启用后管理界面可以看到如下配置：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670be88711637.png" alt="image-20241013233431738"></p>
<h2 id="配置Shovel"><a href="#配置Shovel" class="headerlink" title="配置Shovel"></a>配置Shovel</h2><blockquote>
<p>不区分上下游，在哪个节点配置都可以</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Name</span></span><br><span class="line">shiguang.shovel.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># Source URI shenzhen</span></span><br><span class="line">amqp://guest:123456@192.168.10.66:51000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Source Queue</span></span><br><span class="line">queue.shovel.demo.shenzhen</span><br><span class="line"></span><br><span class="line"><span class="comment"># Destination URI shanghai </span></span><br><span class="line">amqp://guest:123456@192.168.10.66:61000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Destination Queue</span></span><br><span class="line">queue.shovel.demo.shanghai</span><br></pre></td></tr></tbody></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/14/670bf11299cce.png" alt="image-20241014001059119"></p>
<h2 id="测试-10"><a href="#测试-10" class="headerlink" title="测试"></a>测试</h2><h3 id="测试计划"><a href="#测试计划" class="headerlink" title="测试计划"></a><strong>测试计划</strong></h3><table>
<thead>
<tr>
<th>所在机房</th>
<th>交换机名称</th>
<th>路由键</th>
<th>队列名称</th>
</tr>
</thead>
<tbody><tr>
<td>深圳机房</td>
<td>exchange.shovel.test</td>
<td>exchange.shovel.test</td>
<td>queue.shovel.demo.shenzhen</td>
</tr>
<tr>
<td>上海机房</td>
<td>——</td>
<td>——</td>
<td>queue.shovel.demo.shanghai</td>
</tr>
</tbody></table>
<h3 id="测试效果-1"><a href="#测试效果-1" class="headerlink" title="测试效果"></a>测试效果</h3><p><strong>① 发布消息</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670bebb5718d6.png" alt="image-20241013234805964"></p>
<p><strong>② 源节点</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/14/670bf762e144f.png" alt="image-20241014003755567"></p>
<p><strong>③ 目标节点</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/14/670bf76d75248.png" alt="image-20241014003806164"></p>
<p>如果测试效果与视频中演示不一致，可检查配置的账号密码是否正确<br>可用 <code>docker logs  &lt;container_name/container_id&gt; 查看日志</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/14/670c887a10928.png" alt="image-20241014105658504"></p>
<p>可点击 Shovels Name 查看配置详情，例如此处我错误地将用户名写为<code>gust</code>，正确应为 <code>guest</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/14/670c8998e97e0.png" alt="image-20241014110145653"></p>
<p>如果账号密码配置错误导致无法连接，实际测试效果将和普通队列相同</p>
<p>源节点：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670beca4dd4ad.png" alt="image-20241013235205538"></p>
<p>目标节点：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/13/670becbea5201.png" alt="image-20241013235231335"></p>
</div></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">時光</div><div class="post-copyright__author_desc">心寄朗朗乾坤，胸怀真修之道。</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/')">【尚硅谷】RabbitMQ</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=【尚硅谷】RabbitMQ&amp;url=https://blog.shiguang666.eu.org/2024/10/10/3149a4506563/&amp;pic=https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.shiguang666.eu.org" target="_blank">時光</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>尚硅谷<span class="tagsPageCount">42</span></a><a class="post-meta__box__tags" href="/tags/RabbitMQ/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>RabbitMQ<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://img.shiguangdev.cn/i/2024/12/18/6762e71b2e658.webp" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/30/69d054bcefd2/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【尚硅谷】Kafka 3.x</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/10/e53f783bc63e/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/10/15/670e7e16a10f1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">YUM命令Python3与Python2命令不兼容问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/09/18/847c1ec4d4cd/" title="【尚硅谷】Docker快速通关"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-18</div><div class="title">【尚硅谷】Docker快速通关</div></div></a></div><div><a href="/2024/09/17/56a6db38519d/" title="【尚硅谷】JAVA基础-IO流"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-17</div><div class="title">【尚硅谷】JAVA基础-IO流</div></div></a></div><div><a href="/2024/09/16/a32606420cb2/" title="【尚硅谷】JAVA基础-API"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-16</div><div class="title">【尚硅谷】JAVA基础-API</div></div></a></div><div><a href="/2024/09/17/ef5bcf52c331/" title="【尚硅谷】JAVA基础-JDK新特性"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-17</div><div class="title">【尚硅谷】JAVA基础-JDK新特性</div></div></a></div><div><a href="/2024/09/16/277ab91cb5a0/" title="【尚硅谷】JAVA基础-多线程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-16</div><div class="title">【尚硅谷】JAVA基础-多线程</div></div></a></div><div><a href="/2024/09/16/fadbedc8dc87/" title="【尚硅谷】JAVA基础-异常&amp;Object"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/08/28/66cedaf5d014a.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-16</div><div class="title">【尚硅谷】JAVA基础-异常&amp;Object</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display: none">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://emotion.acs.pw/emotion/Heo/送福.png" alt="status"></div></div><div class="author-info__description">代码成就万事基积沙镇海,<br>梦想永在凌云意意气风发。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">時光</h1><div class="author-info__desc">心寄朗朗乾坤，胸怀真修之道。</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/shiguang-coding" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><span>🌟欢迎光临時光的博客园子🌟</span><br> <span><a target="_blank" rel="noopener" href="https://blog.shiguangdev.cn"><b>blog.shiguangdev.cn</b></a></span><br> <span><a target="_blank" rel="noopener" href="https://blog.shiguang88.icu"><b>blog.shiguang88.icu</b></a></span><br> <span><a href="https://blog.shiguang666.eu.org"><b>blog.shiguang666.eu.org</b></a></span><br> <span>🤔 如有问题欢迎评论区交流！</span><br> <span>📧 如需联系我：<a href="mailto:an_shiguang@163.com"><b>发送邮件🚀</b></a></span> <div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MQ%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">MQ的相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMQ"><span class="toc-number">1.1.</span> <span class="toc-text">什么是MQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8MQ"><span class="toc-number">1.2.</span> <span class="toc-text">为什么要用MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%B6%88%E5%B3%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">流量消峰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%A7%A3%E8%80%A6"><span class="toc-number">1.2.2.</span> <span class="toc-text">应用解耦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="toc-number">1.2.3.</span> <span class="toc-text">异步处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.</span> <span class="toc-text">MQ的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%9A%84%E4%B8%A4%E5%A4%A7%E4%B8%BB%E6%B5%81%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.</span> <span class="toc-text">消息队列底层实现的两大主流方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMQP%E4%B8%8EJMS%E5%AF%B9%E6%AF%94"><span class="toc-number">1.3.2.</span> <span class="toc-text">AMQP与JMS对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E4%B8%BB%E6%B5%81MQ%E4%BA%A7%E5%93%81%E5%AF%B9%E6%AF%94"><span class="toc-number">1.3.3.</span> <span class="toc-text">各主流MQ产品对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">1.4.</span> <span class="toc-text">MQ的选择</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">RabbitMQ介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">2.1.</span> <span class="toc-text">RabbitMQ的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.</span> <span class="toc-text">四大核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ%E6%A0%B8%E5%BF%83%E9%83%A8%E5%88%86"><span class="toc-number">2.3.</span> <span class="toc-text">RabbitMQ核心部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E4%B8%AA%E5%90%8D%E8%AF%8D%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.4.</span> <span class="toc-text">各个名词介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85RabbitMQ"><span class="toc-number">3.</span> <span class="toc-text">安装RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">手动安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">Docker安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hello-World"><span class="toc-number">4.</span> <span class="toc-text">Hello World</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%AB%AF-%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">4.2.</span> <span class="toc-text">消息发送端(生产者)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6%E7%AB%AF-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">4.3.</span> <span class="toc-text">消息接收端(消费者)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RabbitMQ%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">RabbitMQ工作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">工作模式概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Queues"><span class="toc-number">5.2.</span> <span class="toc-text">Work Queues</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.1.</span> <span class="toc-text">生产者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">封装工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%95%88%E6%9E%9C"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">发送消息效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.2.</span> <span class="toc-text">消费者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-1"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">运行效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F%EF%BC%88Publish-Subscribe%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">发布订阅模式（Publish/Subscribe）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81-1"><span class="toc-number">5.3.1.</span> <span class="toc-text">生产者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.3.1.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C"><span class="toc-number">5.3.1.2.</span> <span class="toc-text">执行效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81-1"><span class="toc-number">5.3.2.</span> <span class="toc-text">消费者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-3"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C-1"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">执行效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F%EF%BC%88Routing%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">路由模式（Routing）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.4.1.</span> <span class="toc-text">生产者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-4"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C-1"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">运行效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.4.2.</span> <span class="toc-text">消费者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-5"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C-2"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">执行效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%BC%8F%EF%BC%88Topics%EF%BC%89"><span class="toc-number">5.5.</span> <span class="toc-text">主题模式（Topics）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E4%BB%A3%E7%A0%81-3"><span class="toc-number">5.5.1.</span> <span class="toc-text">生产者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-6"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C-3"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">执行效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E4%BB%A3%E7%A0%81-3"><span class="toc-number">5.5.2.</span> <span class="toc-text">消费者代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-7"><span class="toc-number">5.5.2.1.</span> <span class="toc-text">编写代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C-4"><span class="toc-number">5.5.2.2.</span> <span class="toc-text">执行效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%88RPC%EF%BC%89"><span class="toc-number">5.6.</span> <span class="toc-text">远程过程调用（RPC）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%B0%8F%E7%BB%93"><span class="toc-number">5.7.</span> <span class="toc-text">工作模式小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Boot-%E6%95%B4%E5%90%88RabbitMQ"><span class="toc-number">6.</span> <span class="toc-text">Spring Boot 整合RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF"><span class="toc-number">6.1.</span> <span class="toc-text">基本思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.2.</span> <span class="toc-text">消费者操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">6.2.1.</span> <span class="toc-text">创建项目并导入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">创建配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">6.2.3.</span> <span class="toc-text">创建启动类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyMessageListener"><span class="toc-number">6.2.4.</span> <span class="toc-text">MyMessageListener</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">6.2.5.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%BD%A2%E5%8C%96%E7%95%8C%E9%9D%A2%E6%93%8D%E4%BD%9C"><span class="toc-number">6.2.6.</span> <span class="toc-text">图形化界面操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.3.</span> <span class="toc-text">生产者操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-number">6.3.1.</span> <span class="toc-text">创建项目并导入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">6.3.2.</span> <span class="toc-text">创建配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">6.3.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92"><span class="toc-number">7.</span> <span class="toc-text">消息可靠性投递</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%9C%BA%E6%99%AF%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">7.1.</span> <span class="toc-text">问题场景及解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%9C%BA%E6%99%AF"><span class="toc-number">7.1.1.</span> <span class="toc-text">问题场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">7.1.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%83%85%E5%86%B51"><span class="toc-number">7.2.</span> <span class="toc-text">故障情况1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.1.</span> <span class="toc-text">生产者端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-2"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">创建项目并导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.1.3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">7.2.1.4.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">7.2.1.5.</span> <span class="toc-text">测试类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">7.2.1.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.2.</span> <span class="toc-text">备份交换机实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%83%85%E5%86%B52"><span class="toc-number">7.3.</span> <span class="toc-text">故障情况2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%83%85%E5%86%B53"><span class="toc-number">7.4.</span> <span class="toc-text">故障情况3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.4.1.</span> <span class="toc-text">消费者端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-3"><span class="toc-number">7.4.1.1.</span> <span class="toc-text">创建项目并导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-1"><span class="toc-number">7.4.1.2.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">7.4.1.3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Listener"><span class="toc-number">7.4.1.4.</span> <span class="toc-text">Listener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">7.4.1.5.</span> <span class="toc-text">消息确认相关方法参数说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-number">7.4.1.6.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81"><span class="toc-number">8.</span> <span class="toc-text">消费端限流</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%B6%85%E6%97%B6"><span class="toc-number">9.</span> <span class="toc-text">消息超时</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="toc-number">9.1.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E9%98%9F%E5%88%97%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">9.1.1.</span> <span class="toc-text">给队列设置超时时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E6%B6%88%E6%81%AF%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="toc-number">9.1.2.</span> <span class="toc-text">给消息设置超时时间</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AD%BB%E4%BF%A1%E5%92%8C%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">10.</span> <span class="toc-text">死信和死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%9B%B8%E5%85%B3%E5%87%86%E5%A4%87"><span class="toc-number">10.1.</span> <span class="toc-text">测试相关准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">10.1.1.</span> <span class="toc-text">创建死信交换机和死信队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%AD%A3%E5%B8%B8%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E6%AD%A3%E5%B8%B8%E9%98%9F%E5%88%97"><span class="toc-number">10.1.2.</span> <span class="toc-text">创建正常交换机和正常队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E5%B8%B8%E9%87%8F%E5%A3%B0%E6%98%8E"><span class="toc-number">10.1.3.</span> <span class="toc-text">java代码中的相关常量声明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E6%8B%92%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-number">10.2.</span> <span class="toc-text">消费端拒收消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">10.2.1.</span> <span class="toc-text">发送消息的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">10.2.2.</span> <span class="toc-text">接收消息的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">10.2.3.</span> <span class="toc-text">执行结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%95%B0%E9%87%8F%E8%B6%85%E8%BF%87%E9%98%9F%E5%88%97%E5%AE%B9%E9%87%8F%E6%9E%81%E9%99%90"><span class="toc-number">10.3.</span> <span class="toc-text">消费数量超过队列容量极限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E4%BB%A3%E7%A0%81-1"><span class="toc-number">10.3.1.</span> <span class="toc-text">发送消息的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%E7%9A%84%E4%BB%A3%E7%A0%81-1"><span class="toc-number">10.3.2.</span> <span class="toc-text">接收消息的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C-5"><span class="toc-number">10.3.3.</span> <span class="toc-text">执行效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%B6%85%E6%97%B6%E6%9C%AA%E6%B6%88%E8%B4%B9"><span class="toc-number">10.4.</span> <span class="toc-text">消息超时未消费</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E4%BB%A3%E7%A0%81-2"><span class="toc-number">10.4.1.</span> <span class="toc-text">发送消息的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%95%88%E6%9E%9C-6"><span class="toc-number">10.4.2.</span> <span class="toc-text">执行效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-number">11.</span> <span class="toc-text">延迟队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">11.1.</span> <span class="toc-text">业务场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">11.2.</span> <span class="toc-text">实现思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%881%EF%BC%9A%E8%AE%BE%E7%BD%AE%E6%B6%88%E6%81%AF%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4-%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">11.2.1.</span> <span class="toc-text">方案1：设置消息超时时间 + 死信队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%882%EF%BC%9A%E7%BB%99RabbitMQ%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">11.2.2.</span> <span class="toc-text">方案2：给RabbitMQ安装插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">11.2.2.1.</span> <span class="toc-text">插件介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">11.2.2.2.</span> <span class="toc-text">安装插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%8D%B7%E6%98%A0%E5%B0%84%E7%9B%AE%E5%BD%95"><span class="toc-number">11.2.2.3.</span> <span class="toc-text">确定卷映射目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%BB%B6%E8%BF%9F%E6%8F%92%E4%BB%B6"><span class="toc-number">11.2.2.4.</span> <span class="toc-text">下载延迟插件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">11.2.3.</span> <span class="toc-text">启用插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4"><span class="toc-number">11.2.3.1.</span> <span class="toc-text">确认</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%8F%8A%E9%98%9F%E5%88%97"><span class="toc-number">11.2.4.</span> <span class="toc-text">创建交换机及队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95"><span class="toc-number">11.2.5.</span> <span class="toc-text">代码测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">11.2.5.1.</span> <span class="toc-text">生产者端代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">11.2.5.2.</span> <span class="toc-text">消费者端代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">12.</span> <span class="toc-text">事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%E6%BC%94%E7%A4%BA"><span class="toc-number">12.1.</span> <span class="toc-text">实操演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">12.1.1.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-4"><span class="toc-number">12.1.1.1.</span> <span class="toc-text">创建项目并导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="toc-number">12.1.1.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">12.1.1.3.</span> <span class="toc-text">启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB-1"><span class="toc-number">12.1.1.4.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%B1%BB-1"><span class="toc-number">12.1.1.5.</span> <span class="toc-text">测试类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-5"><span class="toc-number">12.1.2.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%83%B0%E6%80%A7%E9%98%9F%E5%88%97"><span class="toc-number">13.</span> <span class="toc-text">惰性队列</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97"><span class="toc-number">14.</span> <span class="toc-text">优先级队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%E6%BC%94%E7%A4%BA-1"><span class="toc-number">14.1.</span> <span class="toc-text">实操演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">15.</span> <span class="toc-text">集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85RabbitMQ-1"><span class="toc-number">15.1.</span> <span class="toc-text">安装RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E8%A6%81%E6%B1%82"><span class="toc-number">15.1.1.</span> <span class="toc-text">前置要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Erlang%E7%8E%AF%E5%A2%83"><span class="toc-number">15.1.2.</span> <span class="toc-text">安装Erlang环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAyum%E5%BA%93%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">15.1.2.1.</span> <span class="toc-text">创建yum库配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="toc-number">15.1.2.2.</span> <span class="toc-text">加入配置内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0yum%E5%BA%93"><span class="toc-number">15.1.2.3.</span> <span class="toc-text">更新yum库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%BC%8F%E5%AE%89%E8%A3%85Erlang"><span class="toc-number">15.1.2.4.</span> <span class="toc-text">正式安装Erlang</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS-8"><span class="toc-number">15.1.2.4.1.</span> <span class="toc-text">CentOS 8</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS-7"><span class="toc-number">15.1.2.4.2.</span> <span class="toc-text">CentOS 7</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85RabbitMQ-2"><span class="toc-number">15.1.3.</span> <span class="toc-text">安装RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-8-1"><span class="toc-number">15.1.3.1.</span> <span class="toc-text">CentOS 8</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-7-1"><span class="toc-number">15.1.3.2.</span> <span class="toc-text">CentOS 7</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RabbitMQ%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">15.1.4.</span> <span class="toc-text">RabbitMQ基础配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E5%B0%BE%E5%B7%A5%E4%BD%9C"><span class="toc-number">15.1.5.</span> <span class="toc-text">收尾工作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%8B%E9%9A%86-VMWare%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">15.2.</span> <span class="toc-text">克隆 VMWare虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">15.2.1.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8B%E9%9A%86%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">15.2.2.</span> <span class="toc-text">克隆虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E6%96%B0%E6%9C%BA%E5%99%A8%E8%AE%BE%E7%BD%AEIP%E5%9C%B0%E5%9D%80"><span class="toc-number">15.2.3.</span> <span class="toc-text">给新机器设置IP地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0"><span class="toc-number">15.2.4.</span> <span class="toc-text">修改主机名称</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E9%99%A9%E6%8E%AA%E6%96%BD"><span class="toc-number">15.2.5.</span> <span class="toc-text">保险措施</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%BD%BC%E6%AD%A4%E5%8F%91%E7%8E%B0"><span class="toc-number">15.3.</span> <span class="toc-text">集群节点彼此发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#node01%E8%AE%BE%E7%BD%AE"><span class="toc-number">15.3.1.</span> <span class="toc-text">node01设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node02%E8%AE%BE%E7%BD%AE"><span class="toc-number">15.3.2.</span> <span class="toc-text">node02设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node03%E8%AE%BE%E7%BD%AE"><span class="toc-number">15.3.3.</span> <span class="toc-text">node03设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9AManagement-UI"><span class="toc-number">15.4.</span> <span class="toc-text">负载均衡：Management UI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">15.4.1.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85HAProxy"><span class="toc-number">15.4.2.</span> <span class="toc-text">安装HAProxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">15.4.3.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C"><span class="toc-number">15.4.4.</span> <span class="toc-text">测试效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9A%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">15.5.</span> <span class="toc-text">负载均衡：核心功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">15.5.1.</span> <span class="toc-text">添加配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-6"><span class="toc-number">15.5.2.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BB%84%E4%BB%B6"><span class="toc-number">15.5.2.1.</span> <span class="toc-text">创建组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E7%AB%AF%E7%A8%8B%E5%BA%8F"><span class="toc-number">15.5.2.2.</span> <span class="toc-text">创建生产者端程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E7%AB%AF%E7%A8%8B%E5%BA%8F"><span class="toc-number">15.5.2.3.</span> <span class="toc-text">创建消费者端程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">15.5.2.4.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E9%98%9F%E5%88%97"><span class="toc-number">15.6.</span> <span class="toc-text">镜像队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%B2%E8%A3%81%E9%98%9F%E5%88%97"><span class="toc-number">15.7.</span> <span class="toc-text">仲裁队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="toc-number">15.7.1.</span> <span class="toc-text">操作步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%B2%E8%A3%81%E9%98%9F%E5%88%97"><span class="toc-number">15.7.1.1.</span> <span class="toc-text">创建仲裁队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-7"><span class="toc-number">15.7.1.2.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%B5%8B%E8%AF%95"><span class="toc-number">15.7.1.2.1.</span> <span class="toc-text">常规测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">15.7.1.2.2.</span> <span class="toc-text">高可用测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E9%98%9F%E5%88%97"><span class="toc-number">15.8.</span> <span class="toc-text">流式队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">15.8.1.</span> <span class="toc-text">使用步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E6%8F%92%E4%BB%B6-1"><span class="toc-number">15.8.1.1.</span> <span class="toc-text">启用插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">15.8.1.2.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JAVA%E4%BB%A3%E7%A0%81"><span class="toc-number">15.8.1.3.</span> <span class="toc-text">JAVA代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">15.8.1.3.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAStream"><span class="toc-number">15.8.1.3.2.</span> <span class="toc-text">创建Stream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%AB%AF%E7%A8%8B%E5%BA%8F"><span class="toc-number">15.8.1.3.3.</span> <span class="toc-text">生产端程序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E7%A8%8B%E5%BA%8F"><span class="toc-number">15.8.1.3.4.</span> <span class="toc-text">消费端程序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%81%8F%E7%A7%BB%E9%87%8F%E6%B6%88%E8%B4%B9"><span class="toc-number">15.8.1.4.</span> <span class="toc-text">指定偏移量消费</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="toc-number">15.8.1.4.1.</span> <span class="toc-text">偏移量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%98%E7%BD%91%E6%96%87%E6%A1%A3%E8%AF%B4%E6%98%8E"><span class="toc-number">15.8.1.4.2.</span> <span class="toc-text">官网文档说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9AOffset%E6%B6%88%E8%B4%B9"><span class="toc-number">15.8.1.4.3.</span> <span class="toc-text">指定Offset消费</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-number">15.8.1.4.4.</span> <span class="toc-text">对比</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Federation%E6%8F%92%E4%BB%B6"><span class="toc-number">16.</span> <span class="toc-text">Federation插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">16.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Federation%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">16.2.</span> <span class="toc-text">Federation交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E8%AF%B4%E6%98%8E"><span class="toc-number">16.2.1.</span> <span class="toc-text">总体说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">16.2.2.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E8%81%94%E9%82%A6%E6%8F%92%E4%BB%B6"><span class="toc-number">16.2.3.</span> <span class="toc-text">启用联邦插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%8A%E6%B8%B8%E8%BF%9E%E6%8E%A5%E7%AB%AF%E7%82%B9"><span class="toc-number">16.2.4.</span> <span class="toc-text">添加上游连接端点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5"><span class="toc-number">16.2.5.</span> <span class="toc-text">创建控制策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-8"><span class="toc-number">16.2.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Federation%E9%98%9F%E5%88%97"><span class="toc-number">16.3.</span> <span class="toc-text">Federation队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E8%AF%B4%E6%98%8E-1"><span class="toc-number">16.3.1.</span> <span class="toc-text">总体说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8E%A7%E5%88%B6%E7%AD%96%E7%95%A5-1"><span class="toc-number">16.3.2.</span> <span class="toc-text">创建控制策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-9"><span class="toc-number">16.3.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shovel%E6%8F%92%E4%BB%B6"><span class="toc-number">17.</span> <span class="toc-text">Shovel插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E7%94%A8Shovel%E6%8F%92%E4%BB%B6"><span class="toc-number">17.1.</span> <span class="toc-text">启用Shovel插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEShovel"><span class="toc-number">17.2.</span> <span class="toc-text">配置Shovel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-10"><span class="toc-number">17.3.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%A1%E5%88%92"><span class="toc-number">17.3.1.</span> <span class="toc-text">测试计划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%95%88%E6%9E%9C-1"><span class="toc-number">17.3.2.</span> <span class="toc-text">测试效果</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/12/18/59743779c169/" title="【白嫖福利】注册US.KG免费域名"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/12/18/6762e71b2e658.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【白嫖福利】注册US.KG免费域名"></a><div class="content"><a class="title" href="/2024/12/18/59743779c169/" title="【白嫖福利】注册US.KG免费域名">【白嫖福利】注册US.KG免费域名</a><time datetime="2024-12-18T14:53:30.000Z" title="发表于 2024-12-18 22:53:30">2024-12-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/16/d5e9d59f93d4/" title="博客、论坛必备：一键填充评论区昵称、邮箱、网址"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/12/16/675fdff3aa4bb.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="博客、论坛必备：一键填充评论区昵称、邮箱、网址"></a><div class="content"><a class="title" href="/2024/12/16/d5e9d59f93d4/" title="博客、论坛必备：一键填充评论区昵称、邮箱、网址">博客、论坛必备：一键填充评论区昵称、邮箱、网址</a><time datetime="2024-12-16T06:35:35.000Z" title="发表于 2024-12-16 14:35:35">2024-12-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/15/a9c615a71d17/" title="【智能协同云图库】3-用户模块"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/12/09/6756ee980378a.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【智能协同云图库】3-用户模块"></a><div class="content"><a class="title" href="/2024/12/15/a9c615a71d17/" title="【智能协同云图库】3-用户模块">【智能协同云图库】3-用户模块</a><time datetime="2024-12-15T03:12:06.000Z" title="发表于 2024-12-15 11:12:06">2024-12-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/13/2ec3ab3954b3/" title="通过SSH密钥连接Linux"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/12/13/675c5996649aa.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="通过SSH密钥连接Linux"></a><div class="content"><a class="title" href="/2024/12/13/2ec3ab3954b3/" title="通过SSH密钥连接Linux">通过SSH密钥连接Linux</a><time datetime="2024-12-13T15:37:00.000Z" title="发表于 2024-12-13 23:37:00">2024-12-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/13/0616411766f4/" title="【Hexo】一键部署至远程服务器"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/i/2024/12/13/675c59eff34f4.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【Hexo】一键部署至远程服务器"></a><div class="content"><a class="title" href="/2024/12/13/0616411766f4/" title="【Hexo】一键部署至远程服务器">【Hexo】一键部署至远程服务器</a><time datetime="2024-12-13T13:35:49.000Z" title="发表于 2024-12-13 21:35:49">2024-12-13</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/shiguang-coding" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" href="mailto:an_shiguang@163.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar.png" size="50px"><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html">开往</a><a class="footer-item" title="异次元之旅" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on">异次元之旅</a><a class="footer-item" title="列表导航" target="_blank" rel="noopener" href="https://zhblogs.ohyee.cc/">列表导航</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a></div></div><div class="footer-group"><div class="footer-title">文章</div><div class="footer-links"><a class="footer-item" title="归档" href="/archives/">归档</a><a class="footer-item" title="分类" href="/categories/">分类</a><a class="footer-item" title="标签" href="/tags/">标签</a><a class="footer-item" title="RSS" href="/tom.xml">RSS</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="留言板" href="/comment/">留言板</a><a class="footer-item" title="关于我" href="/about/">关于我</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"></a><a class="github-badge" target="_blank" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=blog.shiguangdev.cn" style="margin-inline:5px" data-title="萌ICP备20246006号" title="萌ICP备20246006号"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/%E8%90%8Cicp%E5%A4%87-20246006%E5%8F%B7-FF1485" alt="萌ICP备20246006号"></a><a class="github-badge" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">©2023 - 2024 By <a class="footer-bar-link" href="/" title="時光" target="_blank">時光</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = []
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://img.shiguangdev.cn/" title="图床">图床</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="豫ICP备2024070732号">豫ICP备2024070732号</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">257</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">188</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">16</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.shiguang666.eu.org" title="時光主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="時光主页"><span class="back-menu-item-text">時光主页</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://nav.shiguang666.eu.org" title="時光导航站"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="時光导航站"><span class="back-menu-item-text">時光导航站</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://game.shiguang666.eu.org" title="怀旧游戏机"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="怀旧游戏机"><span class="back-menu-item-text">怀旧游戏机</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://umami.shiguangdev.cn/share/1CY8KW6pqM0UBUIL/blog.shiguangdev.cn" title="访客统计"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://umami.shiguangdev.cn/favicon.ico" alt="访客统计"><span class="back-menu-item-text">访客统计</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">后台管理</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://img.shiguangdev.cn/" title="時光图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shiguangdev.cn/favicon.ico" alt="時光图床"><span class="back-menu-item-text">時光图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://qexo.shiguang666.eu.org/" title="Hexo管理面板"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://qexo.shiguang666.eu.org/favicon.ico" alt="Hexo管理面板"><span class="back-menu-item-text">Hexo管理面板</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随机</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/news/"><i class="fa fa-calendar faa-tada"></i><span> 早报亭</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/?id=10051718332&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/gallery/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/xjj/"><i class="fa fa-rocket faa-tada"></i><span> 养生堂</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/flink/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comment/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 0.88rem;">AI<sup>9</sup></a><a href="/tags/Alist/" style="font-size: 0.88rem;">Alist<sup>3</sup></a><a href="/tags/CentOS/" style="font-size: 0.88rem;">CentOS<sup>1</sup></a><a href="/tags/ChatGPT/" style="font-size: 0.88rem;">ChatGPT<sup>13</sup></a><a href="/tags/ChatGPt/" style="font-size: 0.88rem;">ChatGPt<sup>1</sup></a><a href="/tags/Chrome/" style="font-size: 0.88rem;">Chrome<sup>1</sup></a><a href="/tags/CloudFlare/" style="font-size: 0.88rem;">CloudFlare<sup>3</sup></a><a href="/tags/DNS/" style="font-size: 0.88rem;">DNS<sup>1</sup></a><a href="/tags/Ecology/" style="font-size: 0.88rem;">Ecology<sup>1</sup></a><a href="/tags/GPT-4o/" style="font-size: 0.88rem;">GPT-4o<sup>2</sup></a><a href="/tags/Gemini/" style="font-size: 0.88rem;">Gemini<sup>2</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>8</sup></a><a href="/tags/GitHub/" style="font-size: 0.88rem;">GitHub<sup>6</sup></a><a href="/tags/Hexo/" style="font-size: 0.88rem;">Hexo<sup>24</sup></a><a href="/tags/IDEA/" style="font-size: 0.88rem;">IDEA<sup>3</sup></a><a href="/tags/KeyBoardTestUtility/" style="font-size: 0.88rem;">KeyBoardTestUtility<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>4</sup></a><a href="/tags/Lombok/" style="font-size: 0.88rem;">Lombok<sup>1</sup></a><a href="/tags/Markdown/" style="font-size: 0.88rem;">Markdown<sup>2</sup></a><a href="/tags/MindManager/" style="font-size: 0.88rem;">MindManager<sup>1</sup></a><a href="/tags/Mysql/" style="font-size: 0.88rem;">Mysql<sup>2</sup></a><a href="/tags/Perplexity-AI/" style="font-size: 0.88rem;">Perplexity AI<sup>1</sup></a><a href="/tags/PicGo/" style="font-size: 0.88rem;">PicGo<sup>1</sup></a><a href="/tags/QQ/" style="font-size: 0.88rem;">QQ<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 0.88rem;">SQL<sup>12</sup></a><a href="/tags/SSL/" style="font-size: 0.88rem;">SSL<sup>3</sup></a><a href="/tags/Sqlserver/" style="font-size: 0.88rem;">Sqlserver<sup>1</sup></a><a href="/tags/Typora/" style="font-size: 0.88rem;">Typora<sup>5</sup></a><a href="/tags/drawio/" style="font-size: 0.88rem;">drawio<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>1</sup></a><a href="/tags/svn/" style="font-size: 0.88rem;">svn<sup>2</sup></a><a href="/tags/%E5%9B%BE%E5%90%A7%E5%B7%A5%E5%85%B7%E7%AE%B1/" style="font-size: 0.88rem;">图吧工具箱<sup>1</sup></a><a href="/tags/%E5%9B%BE%E5%BA%8A/" style="font-size: 0.88rem;">图床<sup>7</sup></a><a href="/tags/%E5%BC%80%E6%BA%90%E5%88%86%E4%BA%AB/" style="font-size: 0.88rem;">开源分享<sup>6</sup></a><a href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" style="font-size: 0.88rem;">搜索引擎<sup>2</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/" style="font-size: 0.88rem;">数据恢复<sup>1</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 0.88rem;">模板<sup>4</sup></a><a href="/tags/%E8%B8%A9%E5%9D%91/" style="font-size: 0.88rem;">踩坑<sup>6</sup></a><a href="/tags/%E9%B1%BC%E7%9A%AE/" style="font-size: 0.88rem;">鱼皮<sup>11</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="10051718332" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/my/m/music/playlist?id=10051718332&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async="" src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("05/01/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 時光 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async="" src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.shiguangdev.eu.org',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.shiguangdev.eu.org',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async="" src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.shiguangdev.eu.org',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async="" data-pjax="" src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script src="/js/custom/footer-animal.js" defer=""></script><script src="/api/card-welcome.js"></script><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><!-- hexo injector body_end start -->
  <script data-pjax="" src="/js/hexo_githubcalendar.js"></script>
  <script data-pjax="">
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://githubcalendarapi.shiguang666.eu.org/api?user=shiguang-coding";
            var git_color =['#ebedf0', '#a2f7af', '#6ce480', '#54ad63', '#469252', '#31753c', '#1f5f2a', '#13531f', '#084111', '#032b09', '#000000'];
            var git_user ="shiguang-coding";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log("已挂载hexo-github-calendar https://github.com/Barry-Flynn/hexo-github-calendar");
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end -->
    <link rel="stylesheet" href="https://ai.tianli0.top/static/public/postChatUser_summary.min.css">
    <script>
        let tianliGPT_key = '75439fb77e5551eacf54f0df75565616dcf2ad';
        let tianliGPT_postSelector = '#article-container';
        let tianliGPT_Title = '文章摘要';
        let tianliGPT_postURL = '/^https?://[^/]+/[0-9]{4}/[0-9]{2}/[0-9]{2}/';
        let tianliGPT_blacklist = '';
        let tianliGPT_wordLimit = '1000';
        let tianliGPT_typingAnimate = true;
        var postChatConfig = {
          backgroundColor: "#3e86f6",
          bottom: "16px",
          left: "16px",
          fill: "#FFFFFF",
          width: "44px",
          frameWidth: "375px",
          frameHeight: "600px",
          defaultInput: true,
          upLoadWeb: true,
          showInviteLink: true,
          userTitle: "PostChat",
          userDesc: "如果你对网站的内容有任何疑问，可以来问我哦～",
          addButton: true,
          beginningText: "这篇文章介绍了"
        };
    </script>
    <script data-postchat_key="75439fb77e5551eacf54f0df75565616dcf2ad" src="https://ai.tianli0.top/static/public/postChatUser_summary.min.js"></script>
  </body></html>